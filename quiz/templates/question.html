{% extends "base.html" %}
{% load model_template_relation %}

{% load i18n %}
{% load static %}
{% load quiz_tags %}

{% block title %} {{ quiz.title }} {% endblock %}
{% block description %} {{ quiz.title }} - {{ quiz.description }} {% endblock %}
{% block breadcrumb %}

    {% block top_navigation %}

    {% endblock top_navigation %}

    {% block sidebar %}

        <style>
            .nav-pills>li.active>a, .nav-pills>li.active>a:focus, .nav-pills>li.active>a:hover {
                color: #fff;
                background-color: #2a3f54!important;}
            .incomplete-qts{
                list-style: none;
                padding: 0px!important;
                max-height: 80vh;
                overflow: auto;
                margin: 10px 0;
              
            }
            .incomplete-qts li {
                border-bottom: 1px solid grey;
                padding: 3px;

            }
            .hide {
                display: none;
            }

            .show {
                display: block;
            }

            .nav-md .container.body .right_col {
                padding: 10px 20px 0;
                margin-left: 0px !important;
            }

            .breadcrumb {
                display: none;
            }

            .base-timer {
                position: relative;
                width: 150px;
                height: 150px;
                margin: auto;
            }

            .base-timer__svg {
                transform: scaleX(-1);
            }

            .base-timer__circle {
                fill: none;
                stroke: none;
            }

            .base-timer__path-elapsed {
                stroke-width: 7px;
                stroke: grey;
            }

            .base-timer__path-remaining {
                stroke-width: 7px;
                stroke-linecap: round;
                transform: rotate(90deg);
                transform-origin: center;
                transition: 1s linear all;
                fill-rule: nonzero;
                stroke: currentColor;
            }

            .base-timer__path-remaining.green {
                color: rgb(65, 184, 131);
            }

            .base-timer__path-remaining.orange {
                color: orange;
            }

            .base-timer__path-remaining.red {
                color: rgb(177, 21, 21);
            }

            .base-timer__label {
                position: absolute;
                width: 150px;
                height: 150px;
                top: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
            }
        </style>
        <link rel="stylesheet" href="{% static 'chapterPageBuilder/css/jquery-ui.css' %}">
    {% endblock sidebar %}
{% endblock %}

{% block content %}
      <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

    {% if previous.answers %}

        <p class="muted"><small>{% trans "The previous question" %}:</small></p>
        <p>{{ previous.previous_question }}</p>

        {% if previous.previous_outcome %}
            <div class="alert alert-success">
        {% else %}
            <div class="alert alert-warning">
        {% endif %}
    <p><small>
        {% trans "Your answer was" %} </small>
        <strong>
            {{ previous.previous_outcome|yesno:"correct,incorrect" }}
        </strong>
    </p>

    </div>

        {% include 'correct_answer.html' %}

        <p><strong>{% trans "Explanation" %}:</strong></p>
        <div class="well " style="background-color: #fcf8e3;">
            <p>{{ previous.previous_question.explanation }}</p>
        </div>

        <hr>

    {% endif %}


    <div class="" style="text-align:right; margin-bottom: 10px;">
        <a href="
		    {% if request.GET.iframe %}
		        {% url 'student_progress_detail' pk=sitting_id %}?iframe=1
		    {% else %}
                {% url 'student_progress_detail' pk=sitting_id %}
            {% endif %}
        " class="closelink"><i class="fa fa-times fa-2x" aria-hidden="true"></i></a>
    </div>

    {% if question %}
    <div class="col-md-12" style="padding: 0px!important;">
        <div class="row">
            <div class="col-md-10">
                {% if quiz.exam_paper %}
                <div class="col-lg-12 col-md-12 col-xs-12 ">
                    {% comment %}
                    <div class="pie degree" id="quiz-timer" data-timer="{{ remaining_time }}">
                        <span class="block-timer"></span>
                        <span id="time"></span>
                        <!-- <span id="time1">0</span> -->
                    </div>
                    {% endcomment %}
                    <div id="app" class="quiz-timer" data-timer="{{ remaining_time }}"></div>
                </div>
    
    
            {% endif %}
          <div class="col-md-12" style="margin-top: 25px;">
              <div class="row">
                  <div class="col-md-1 button-for-height">
                    {% if has_previous %}
                    <div class=" button-prev-quiz text-center ">
                        <a href="javascript:void(0)" id="prevBtn">
                            <button class="btn btn-secondary btn-sm" title="Previous Question" id="previous-btn"><i class="fa fa-arrow-circle-left"style="font-size: 20px;"></i> <br> Prev</button>
                        </a>
                    </div>
                {% endif %}
    
                  </div>
    
                  <div class="col-md-10 text-center">
                      <div class="row">
                        <div class="col-md-6 text-left">
                            <p>
                                <small class="muted"><strong>
                                    {% trans "Question category" %}:
    
                                </strong>
                                </small>
                                <strong>{{ question.category }}</strong>
                            </p>
    
                        </div>
                        <div class="col-md-6 text-right">
                            {% if progress %}
                            <div style="float: right;">
                               <span><b>{% trans "Remaining Question:" %} <span style="color: #eea236;">
                                {{ sitting.get_remaining_question.remaining_count }}
                               </span></b></span> &nbsp;&nbsp; <span><b>{% trans "Total Question:" %} <span style="color: #eea236;">  {{ progress.2 }}     </span> </b></span>
                                <!-- {% trans "Question" %} {{ question_number }} {% trans "of" %} {{ progress.2 }} -->
                            </div>
                        {% endif %}
                          </div>
                      </div>
                            <div class="quiz-questions"
                                                            >
            <div id="step-1">
            <div class="privew1">
            <div class="questionsBox">
            <div class="questions">{{ question_number }})&nbsp; {{ question.content }}</div>
    
    
            {% if question.figure %}
            <div class="quiz-ques-image">
    
                <img src="{{ question.figure.url }}" alt="{{ question.content }}"/>
    
    
            </div>
    
            {% endif %}
            <form action="" method="POST" id="quizForm">
                {% csrf_token %}
            <input type=hidden name="question_id" value="{{ question.id }}">
            <ul class="list-group">
    
                {% for answer in form.answers %}
                    <li class="list-group-item">
                        {{ answer }}
                    </li>
                {% endfor %}
    
            </ul>
             {% if    question_number == progress.2  %}
            <input type="submit" value="{% trans 'Complete' %}" class="btn btn-large btn-block
                btn-success" id="completeQuizBtn">
             {% else   %}
             <input type="submit" value="{% trans 'Submit' %}" class="btn btn-large btn-block
             btn-warning" >
             {% endif %}
    
    
            </form>
    
            </div>
            </div>
    
            </div>
                            </div>
                  </div>
                  <div class="col-md-1 nextbutton-for-height  ">
                    {% if has_next %}
                    <div class="button-next-quiz text-center" >
                        <a href="javascript:void(0)" id="nextBtn">
                            <button class="btn btn-secondary btn-sm" title="Next Question" id="next-btn"><i class="fa fa-arrow-circle-right" style="font-size: 20px;"></i> <br> Next</button>
                        </a>
                    </div>
                {% endif %}
                  </div>
              </div>
          </div>
            </div>
            <div class="col-md-2">
                  <ul  class="nav nav-pills">
                    <li class="active">
                <a  href="#1a" data-toggle="tab" style="padding: 5px!important;">All Question</a>
                    </li>
                    <li><a href="#2a" data-toggle="tab" style="padding: 5px!important;" >Incomplete</a>
                    </li>
                  
                </ul>
                <div class="tab-content clearfix" style="border:2px solid #f0ad4e; margin:10px 0;padding:0px 10px; border-radius:5px">
                    <div class="tab-pane active" id="1a">
                        <ul class="incomplete-qts">

                        {% for question in sitting.get_questions %}
                            {% getQuizQuestionIndex sitting question.id as qindex %}
                            {% quizQuestion_check_if_answered sitting question.id as is_answered %}
                            <li {% if qindex == question_number %} style = "background:#ddd" {% endif %} >
                                <b>
                                    {% if is_answered %}
                                        <i class="fa fa-check" aria-hidden="true" style="color:rgb(32, 163, 32); "></i>
                                    {% endif %}
                                </b> &nbsp;
                                <b>
                                    {% if not qindex == question_number %}
                                        <a href="javascript:void(0)" class="quizlinkBtn" data-value="{{ qindex }}">
                                            {{ qindex }}) {{ question }}
                                        </a>
                                    {% else %}
                                        {{ qindex }}) {{ question }}
                                    {% endif %}
                                </b>
                            </li>

                          {% endfor %}

                        </ul>
                      </div>
                      <div class="tab-pane" id="2a">
                        <ul class="incomplete-qts">
                            {% for question in sitting.get_questions %}
                                {% getQuizQuestionIndex sitting question.id as qindex %}
                                {% quizQuestion_check_if_answered sitting question.id as is_answered %}

                                {% if not is_answered %}
                                    <li {% if qindex == question_number %} style = "background:#ddd" {% endif %} >
                                        <b>
                                            {% if not qindex == question_number %}
                                                <a href="javascript:void(0)" class="quizlinkBtn" data-value="{{ qindex }}">
                                                    {{ qindex }}) {{ question }}
                                                </a>
                                            {% else %}
                                                {{ qindex }}) {{ question }}
                                            {% endif %}
                                        </b>
                                    </li>
                                {% endif %}
                              {% endfor %}
                        </ul>
                      </div>
            
                  </div>
            </div>
        </div>
    </div>
  

    {% endif %} 

    <div class="hide" id="dialog-confirm" title="Confirm Submit?">
        <p>
            <span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>
            This is the final submission. Are you sure to end the quiz?
            <span class="text-danger">There are still {{ sitting.get_remaining_question.remaining_count }} questions left.</span>

        </p>
    </div>
{% endblock %}
    <hr>


    {% block customjss %}
        <script src="{% static 'vendorsx/jquery/dist/jquery.min.js' %}"></script>
        <script src="{% static 'chapterPageBuilder/js/jquery-ui.min.js' %}"></script>

        <script>
            function updateFunctionTimeElapsed() {
                    $.ajax({
                        url: "{% url 'quiz_update_time_taken' %}",
                        method: 'post',
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'sitting_id': '{{ sitting_id }}',
                            'quiz_id': '{{ quiz.id }}',
                            'remaining_time': parseInt(timeLeft)
                        },
                        success: function (data) {
                            if (data.url != 0 || data.url != '0') {
                                clearInterval(cuentaAtras)
                                window.location.href = data.url;
                            }
                        },
                        error: function (e) {
                            console.log(e.responseText)
                        }
                    })
            }

            {% if quiz.exam_paper %}
                $('form').on('submit', function (e) {
                    updateFunctionTimeElapsed();
                });
                $('#previous-btn').on('click', function (e) {
                    updateFunctionTimeElapsed();
                });
                $('#next-btn').on('click', function (e) {
                    updateFunctionTimeElapsed();
                });
            {% endif %}
        </script>
        <script>
            const FULL_DASH_ARRAY = 283;
            const WARNING_THRESHOLD = 10;
            const ALERT_THRESHOLD = 5;

            const COLOR_CODES = {
                info: {
                    color: "green"
                },
                warning: {
                    color: "orange",
                    threshold: WARNING_THRESHOLD
                },
                alert: {
                    color: "red",
                    threshold: ALERT_THRESHOLD
                }
            };

            const TIME_LIMIT = '{{ quiz.duration }}';
            let timePassed = '{{ quiz.duration }}' - '{{ remaining_time }}';
            let timeLeft = TIME_LIMIT - timePassed;
            let timerInterval = null;
            let remainingPathColor = COLOR_CODES.info.color;

            {% if quiz.exam_paper %}
            document.getElementById("app").innerHTML = `
                <div class="base-timer">
                  <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g class="base-timer__circle">
                      <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                      <path
                        id="base-timer-path-remaining"
                        stroke-dasharray="283"
                        class="base-timer__path-remaining ${remainingPathColor}"
                        d="
                          M 50, 50
                          m -45, 0
                          a 45,45 0 1,0 90,0
                          a 45,45 0 1,0 -90,0
                        "
                      ></path>
                    </g>
                  </svg>
                  <span id="base-timer-label" class="base-timer__label">${formatTime(
                timeLeft
            )}</span>
                </div>
                `;

            setCircleDasharray()

            startTimer();
            {% endif %}
            function onTimesUp() {
                clearInterval(timerInterval);
            }

            function startTimer() {
                timerInterval = setInterval(() => {
                    timePassed = timePassed += 1;
                    timeLeft = TIME_LIMIT - timePassed;
                    document.getElementById("base-timer-label").innerHTML = formatTime(
                        timeLeft
                    );
                    setCircleDasharray();
                    setRemainingPathColor(timeLeft);

                    if (timeLeft === 0) {
                        onTimesUp();
                    }
                }, 1000);
            }

            function formatTime(time) {
                let hours = Math.floor(time / 60 / 60);
                let minutes = Math.floor((time / 60) % 60);
                let seconds = time % 60;

                if (seconds < 10) {
                    seconds = `0${seconds}`;
                }
                if (minutes < 10) {
                    minutes = `0${minutes}`;
                }
                if (hours < 10) {
                    hours = `0${hours}`;
                }

                return `${hours}:${minutes}:${seconds}`;
            }

            function setRemainingPathColor(timeLeft) {
                const {alert, warning, info} = COLOR_CODES;
                if (timeLeft <= alert.threshold) {
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.remove(warning.color);
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(alert.color);
                } else if (timeLeft <= warning.threshold) {
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.remove(info.color);
                    document
                        .getElementById("base-timer-path-remaining")
                        .classList.add(warning.color);
                }
            }

            function calculateTimeFraction() {
                const rawTimeFraction = timeLeft / TIME_LIMIT;
                return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
            }

            function setCircleDasharray() {
                const circleDasharray = `${(
                    calculateTimeFraction() * FULL_DASH_ARRAY
                ).toFixed(0)} 283`;
                document
                    .getElementById("base-timer-path-remaining")
                    .setAttribute("stroke-dasharray", circleDasharray);
            }
        </script>
        <script>
            // FIFO queue to limit selected answers to 2 (op_limit).
            var multi_ans_arr = [];         /////// The queue; contains id of selected elements
            $.each($("input[name='answers']:checked"), function () {
                multi_ans_arr.push(this.id)
            });
            let op_limit = 1;
            {% if question %}
                op_limit = parseInt("{{ question.get_num_correct_options }}");
            {% endif %}

            $("input[name='answers']").change(function(){
                if($(this).prop("checked")){
                    /////// if checked, see if queue(of length 2) is full, if its full, remove the oldest element
                    /////// also uncheck the removed element
                    if (multi_ans_arr.length >= op_limit){
                        $("#" + multi_ans_arr.shift()).prop('checked', false);
                    }
                    /////// push the new element(id) to the queue; id of the element is stored in the queue
                    multi_ans_arr.push($(this).attr('id'));
                } else {
                    /////// if unchecked, must remove this element from the queue, no matter if its old or new.
                    if (multi_ans_arr.includes(($(this).attr('id')))){
                        multi_ans_arr.splice(multi_ans_arr.indexOf($(this).attr('id')), 1);
                    }
                }
            });
        </script>

        <script>
            $(document).ready(function () {
                runQuizTimerInterval();

                // update query parameter on page load.
                if (history.pushState) {
                    var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?q={{ question_number }}';
                    window.history.pushState({path:newurl},'',newurl);
                }
            });
        </script>

        <script>
            $('#prevBtn').on('click', function (e) {
                e.preventDefault();
                newUrl = addParameterToURL('action=-1')
                $('#quizForm').attr('action', newUrl)
                $('#quizForm').submit()
            });

            $('#nextBtn').on('click', function (e) {
                e.preventDefault();
                newUrl = addParameterToURL('action=1');
                $('#quizForm').attr('action', newUrl);
                $('#quizForm').submit()
            });

            $('.quizlinkBtn').on('click', function (e) {
                e.preventDefault();
                newUrl = addParameterToURL('action=0&nq='+$(this).attr('data-value'));
                $('#quizForm').attr('action', newUrl);
                $('#quizForm').submit()
            });

            $('#completeQuizBtn').on('click', function (e) {
                e.preventDefault();
                $( "#dialog-confirm" ).dialog({
                    resizable: false,
                    height: "auto",
                    width: 400,
                    modal: true,
                    open: function(){
                      $( this ).removeClass( "hide" );
                    },
                    buttons: {
                        "Complete": function() {
                            newUrl = addParameterToURL('c=1');
                            $('#quizForm').attr('action', newUrl);
                            $('#quizForm').submit()
                        },
                        Cancel: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
            });

            function addParameterToURL(param){
                _url = location.href;
                _url += (_url.split('?')[1] ? '&':'?') + param;
                return _url;
            }
        </script>
    {% endblock %}

{% block footer %}



{% endblock footer %}
