{% load static %}
{% load crispy_forms_tags %}

{% block stylesheets %}
    <style>
        #pagination {
            display: inline-block;
            vertical-align: middle;
            border-radius: 4px;
            padding: 1px 2px 4px 2px;
            border-top: 1px solid #AEAEAE;
            border-bottom: 1px solid #FFFFFF;
            background-color: #DADADA;
            background-image: -webkit-linear-gradient(top, #DBDBDB, #E2E2E2);
            background-image: -moz-linear-gradient(top, #DBDBDB, #E2E2E2);
            background-image: -ms-linear-gradient(top, #DBDBDB, #E2E2E2);
            background-image: -o-linear-gradient(top, #DBDBDB, #E2E2E2);
            background-image: linear-gradient(top, #DBDBDB, #E2E2E2);
        }

        #pagination a, #pagination i {
            display: inline-block;
            vertical-align: middle;
            width: 22px;
            color: #7D7D7D;
            text-align: center;
            font-size: 10px;
            padding: 3px 0 2px 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -o-user-select: none;
            user-select: none;
        }

        #pagination a {
            margin: 0 2px 0 2px;
            border-radius: 4px;
            border: 1px solid #E3E3E3;
            cursor: pointer;
            box-shadow: inset 0 1px 0 0 #FFF, 0 1px 2px #666;
            text-shadow: 0 1px 1px #FFF;
            background-color: #E6E6E6;
            background-image: -webkit-linear-gradient(top, #F3F3F3, #D7D7D7);
            background-image: -moz-linear-gradient(top, #F3F3F3, #D7D7D7);
            background-image: -ms-linear-gradient(top, #F3F3F3, #D7D7D7);
            background-image: -o-linear-gradient(top, #F3F3F3, #D7D7D7);
            background-image: linear-gradient(top, #F3F3F3, #D7D7D7);
        }

        #pagination i {
            margin: 0 3px 0 3px;
        }

        #pagination a.current {
            border: 1px solid #E9E9E9;
            box-shadow: 0 1px 1px #999;
            background-color: #DFDFDF;
            background-image: -webkit-linear-gradient(top, #D0D0D0, #EBEBEB);
            background-image: -moz-linear-gradient(top, #D0D0D0, #EBEBEB);
            background-image: -ms-linear-gradient(top, #D0D0D0, #EBEBEB);
            background-image: -o-linear-gradient(top, #D0D0D0, #EBEBEB);
            background-image: linear-gradient(top, #D0D0D0, #EBEBEB);
        }
    </style>
{% endblock stylesheets %}
<!-- Model for Import CSV file -->
<div class="modal fade" id="exampleModal1" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h4 class="modal-title" id="exampleModalLabel"><b>CSV File Import</b>
                    <button type="button" class="close closeImportCSV" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </h4>
            </div>
            <div class="modal-body" id="import_csv_body" style="height: 60%;overflow:hidden">
                <form method="POST" id="form_import_csv" enctype="multipart/form-data">
                    {% csrf_token %} <br><br>
                    <label for="id_import_csv">Choose the CSV file to Import Course Data</label>
                    <input type="file" name="import_csv" id="id_import_csv" accept=".csv"><br><br>
                    <a target="_blank" class="text-center" href="{% static 'importCourse_sample.csv' %}"
                       style="padding-top: 2em;">
                        <h4><i class="fa fa-download" aria-hidden="true"></i> Download Sample CSV</h4>
                    </a><br>

                    <span class="button-info" style="cursor:pointer;padding:0.4em;color:#222"><b>Read Detail
                   Info...</b></span>
                    <ul class="info-text" style="display:none;background:azure;">
                        <li>- Course Name (required)</li>
                        <li>- Course Name should be unique within the center</li>
                        <li>- Course Provider (required)</li>
                        <li>- Course Level should be between 1 and 5</li>
                    </ul>

                    <div class="import-message"></div>
                    <div class="text-center">
                        <button class="btn btn-success" id="submitcsv" type="submit" style="margin:3em auto 2em auto">
                            <span id="submitspinner"></span>Submit File
                        </button>
                        <button class="btn btn-primary closeImportCSV" data-dismiss="modal" aria-label="Close"
                                style="margin:3em auto 2em auto">Close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- End of model -->

<div class="courseInfoListClass">
    <h2 class="tableHeader">
        {% if '/active' in request.path %}
            List of Courses
        {% else %}
            List of Inactive Courses
        {% endif %}
    </h2>

    <div class="col-md-12 text-right" style="padding-bottom: 20px ;">
        <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-12">
                <h5 class="text-left" style="padding-left: 10px; margin-bottom: 0;"><b>
                    <a id="cardButton" href="#card-view" style="cursor: pointer; color:black">Card View</a> &nbsp;
                    <a id="tableButton" href="#table-view" style="cursor: pointer">Table View</a></b>
                    <!-- <span class="view-inactive" style="padding-right: 10px;"><a href="
                                {% if '/mysessions' not in request.path %}
                                    {% url 'inninginfo_list_inactive' %}
                                {% else %}
                                    {% url 'teachers_mysession_list_inactive' %}
                                {% endif %}
                                ">View
                                        Inactive Sessions</a>
                                </span> -->
                </h5>

            </div>
            <div class="col-md-6 col-sm-6 col-xs-12">
                {% if 'students' not in request.path %}
                    <div class="btn-createnew">
                        {% if '/active' in request.path %}
                            <a href="{% url 'courseinfo_list_inactive' %}">
                                        <span class="text-right " style="float:right;color:#5A738E">
                                        <b>View Inactive Courses</b> 
                                        </span>
                            </a>
                        {% else %}
                            <a href="{% url 'courseinfo_list_active' %}">
                                        <span class="text-right " style="float:right;color:#5A738E">
                                        <b>  View Active Courses</b>
                                        </span>
                            </a>
                        {% endif %}
                    </div>
                {% endif %}

            </div>

            <!-- <span> <b>Show</b> </span>
            <label>
                <select name="QuizTable_length" aria-controls="QuizTable" class="form-control input-sm"
                        id="paginate_courses">
                    <option value="6">6</option>
                    <option value="12">12</option>
                    <option value="18">18</option>
                    <option value="24">24</option>
                    <option value="30">30</option>
                    <option value="36">36</option>
                </select>
            </label>
            <span> <b>Entries</b> </span> -->
        </div>


    </div>
    <hr class="header_hr">


    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="row">

            <div class="col-md-8 col-sm-6 col-xs-12">
                <form method="get" id="searchCourseForm">
                    <div class="col-md-4">
                        <input type="text" name="query" placeholder="Search Course" value="{{ request.GET.query }}"
                               class="form-control"/>
                    </div>
                    <button class="btn btn-default" type="submit">
                        <i class="fa fa-search"></i>&nbsp;Search
                    </button>
                </form>
            </div>
            {% comment %}
            {% if 'teachers' in request.path %}
                <div class="col-md-8 col-sm-6 col-xs-12">
                    <form method="get" action="">
                        <div class="col-md-4">
                            <input type="text" name="teacher_coursequery" placeholder="Search Course"
                                   value="{{ request.GET.query }}"
                                   class="form-control"/>
                        </div>
                        <button class="btn btn-default" type="submit">
                            <i class="fa fa-search"></i>&nbsp;Search
                        </button>
                    </form>
                </div>
            {% elif 'students' in request.path %}
                <div class="col-md-8 col-sm-6 col-xs-12">
                    <form method="get" action="">
                        <div class="col-md-4">
                            <input type="text" name="coursequery" placeholder="Search Course"
                                   value="{{ request.GET.query }}"
                                   class="form-control"/>
                        </div>
                        <button class="btn btn-default" type="submit">
                            <i class="fa fa-search"></i>&nbsp;Search
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="col-md-8 col-sm-6 col-xs-12">
                    <form method="get" action="">
                        <div class="col-md-4">
                            <input type="text" name="query" placeholder="Search Course" value="{{ request.GET.query }}"
                                   class="form-control"/>
                        </div>
                        <button class="btn btn-default" type="submit">
                            <i class="fa fa-search"></i>&nbsp;Search
                        </button>
                    </form>
                </div>
            {% endif %}
        {% endcomment %}

            <div class="col-md-4 col-sm-6 col-xs-12 btn-createnew">
                {% if 'students' not in request.path %}
                    <!-- {% if '/active' in request.path %}
                            <a href="{% url 'courseinfo_list_inactive' %}">
                                <button class="text-right btn btn-default btn-sm" style="float:right">
                                    View <span style="color: rgb(219, 0, 0); ">  <b>Inactive</b>  </span>courses
                                </button>
                            </a>
                        {% else %}
                            <a href="{% url 'courseinfo_list_active' %}">
                                <button class="text-right btn btn-default btn-sm" style="float:right">
                                    View <span style="color: rgb(48, 112, 55); ">  <b>Active</b>  </span>courses
                                </button>
                            </a>
                        {% endif %} -->
                    {% if '/active' in request.path %}
                        <a class="btn btn-success btn-sm" style="float: right;" href="
                    {% if '/teachers' in request.path %}
                        {% url 'teacher_courseinfo_create' %}
                    {% else %}
                        {% url 'courseinfo_create' %}
                    {% endif %}">Create new Course</a>
                        <a class="btn btn-primary btn-sm" style="float: right;" data-toggle="modal"
                           data-target="#exampleModal1"
                           id="importcsv-btn"><i class="fa fa-upload" aria-hidden="true"></i> Import</a>
                    {% endif %}

                {% endif %}
                <div style="float: right; margin-right:10px">


                    <span> <b>Show</b> </span>
                    <label>
                        <select name="QuizTable_length" aria-controls="QuizTable" class="form-control input-sm"
                                id="paginate_courses">
                            <option value="6">6</option>
                            <option value="12">12</option>

                            <option value="30">30</option>
                            <option value="60">60</option>
                        </select>
                    </label>
                    <span> <b> entries </b> </span></div>

            </div>

        </div>
    </div>
    <br/><br/><br/>

    <div class="container" id="divID">
        {% include 'WebApp/theme/alerts.html' %}
        <div class="col-md-12" id="cardView">
            {% for object in object_list %}
                <div class=" col-md-4 col-sm-6 col-xs-12 listcard" id="listCard">
                    <div class="gridContentsList">
                        <div class="card-header">

                            <a href="{% if '/students' in request.path %}
                                    {{ object.student_get_absolute_url }}
                                {% elif '/teachers' in request.path %}
                                    {{ object.teacher_get_absolute_url }}
                                {% else %}
                                {{ object.get_absolute_url }}
                                {% endif %}">
                                <img id="courseListImage" class="card-img-top" src="
                                {% if object.Course_Cover_File %}
                                    {{ object.Course_Cover_File.url }}
                                {% else %}
                                    {% static 'images/course.jpg' %}
                                {% endif %}" alt="Card image cap" width="100%" height="180px"
                                     style="object-fit: cover"/>
                            </a>
                        </div>
                        <div class="card-body" id="cardInfo">
                            <h2 class="card-title" style="height: 3.5em;">
                                <strong><a href="{% if '/students' in request.path %}
                                            {{ object.student_get_absolute_url }}
                                        {% else %}
                                            {{ object.get_absolute_url }}
                                        {% endif %}">{{ object.Course_Name|truncatechars:70 }} </a></strong>
                                {% if object.Use_Flag == False %}<i
                                        style="float: right;color: red;font-size: 10px;margin-top: 5px;">Deactivated</i>{% endif %}
                            </h2>

                            {% if object.get_teachers_of_this_course %}
                                <p style="height: 30px; overflow:auto">
                                    Teacher(s): &nbsp;
                                    {% for eachTeacher in object.get_teachers_of_this_course %}&nbsp;
                                        {{ eachTeacher.getFullName }}
                                    {% endfor %}

                                </p>
                            {% else %}
                                <p style="height: 30px; overflow:auto"> No Teacher </p>



                            {% endif %}







                            <hr/>
                            <h5 class="lectureDescription" style="padding-bottom: 5px;">
                                {% if object.Course_Description %}
                                    <p style="padding-left: 10px;
                padding-right: 10px;
                line-height: 1.5em;
                height: 3.5em;
                overflow-wrap:break-word;
                overflow: auto;
                white-space: normal;
                text-overflow: ellipsis;">
                                        {{ object.Course_Description }}
                                    </p>
                                {% else %}
                                    <p style="padding-left: 10px;
                padding-right: 10px;
                line-height: 1.5em;
                height: 3.5em;
                overflow-wrap:break-word;
                overflow: auto;
                white-space: normal;
                text-overflow: ellipsis;">
                                        No Description
                                    </p>
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            {% empty %}
                <b>NO COURSES ALLOCATED</b>

            {% endfor %}

            <div class=" col-md-12 col-sm-12 col-xs-12 text-center" id="pagination">

            </div>

        </div>
        <div class="col-md-12 col-sm-12 col-lg-12 col-xs-12">
            <div class="table-responsive" style="display:none;padding: 0;" id="tableView">

                <br>
                <span class="checkboxCheckedLength"></span>
                {% if object_list %}
                    <table class="table table-striped table-bordered bg-white nowrap" id="course_dataTable">
                        <thead class="thead-light bg-primary">
                        <tr class="tableTitleRow">

                            <td>ID</td>
                            <td>Course Name</td>
                            <td>Teachers</td>

                            <td>Course Provider</td>
                            <td>Level</td>

                            <td>Action</td>
                        </tr>
                        </thead>

                        {% for object in object_list %}

                            <tr>

                                <td style="vertical-align: middle;">{{ forloop.counter }}</td>
                                <td style="vertical-align: middle;"><strong><a
                                        href="{% if '/students' in request.path %}
                            {{ object.student_get_absolute_url }}
                        {% else %}
                            {{ object.get_absolute_url }}
                        {% endif %}">{{ object.Course_Name|truncatechars:70 }} </a></strong></td>

                                <td style="vertical-align: middle;">     {% if object.get_teachers_of_this_course %}
                                    <p style="height: 30px; overflow:auto">

                                        {% for eachTeacher in object.get_teachers_of_this_course %}&nbsp;
                                            {{ eachTeacher.getFullName }}
                                        {% endfor %}

                                    </p>
                                {% else %}
                                    <p style="height: 30px; overflow:auto"> No Teacher </p>



                                {% endif %}</td>
                                <td style="vertical-align: middle;">
                                    {{ object.Course_Provider }}


                                </td>
                                <td style="vertical-align: middle;">
                                    {{ object.Course_Level }}

                                </td>

                                <td class="text-center"><a class="btn btn-sm btn-info"
                                                           href="
                                    {{ object.get_update_url }}
                               ">Edit</a>
                            </tr>



                        {% endfor %}


                    </table>
                {% else %}
                    <p class="text-center"><b> NO COURSES HAS BEEN ALLOCATED </b></p>
                {% endif %}

            </div>

        </div>
    </div>

    <!-- jQuery -->
    <script src="{% static 'vendorsx/jquery/dist/jquery.min.js' %}"></script>

    <script>
        $(document).ready(function () {
            var table_main = $('#course_dataTable').DataTable({
                responsive: true,
                dom: 'lBfrtip',
                buttons: [],
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]]
            });

            $('.lectureDescription').each(function () {
                let trunc = truncateString($(this).find('p').text());
                $(this).find('p').text(trunc);
                // Animate loader off screen
                $(".se-pre-con").fadeOut("slow");

            });

            $(".button-info").click(function () {
                $("ul.info-text").toggle();
            });

            $('#form_import_csv').submit(function (e) {
                e.preventDefault();
                var formData = new FormData($('form').get(0));
                // csrf = $('#csrfmiddlewaretoken').get(0).files[0];
                csrf = $('input[name="csrfmiddlewaretoken"]').attr('value');
                formData.append("csrfmiddlewaretoken", csrf);
                if ($('#id_import_csv').val()) {
                    $('#submitspinner').html(`<i class="fa fa-spinner fa-spin"></i> `);
                    $('#submitcsv').attr('disabled', true);
                    $('.closeImportCSV').attr('disabled', true);
                    $.ajax({
                        type: "POST",
                        url: "{% url 'csv_import_course' %}",  // URL to your view that serves new info
                        data: formData,
                        cache: false,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            $('.import-message').addClass(response.class);
                            $('.import-message').removeClass(response.rmclass);
                            $('.import-message').html(response.message);
                        },
                        error: function () {
                            $('.import-message').addClass('text-danger');
                            $('.import-message').removeClass('text-sucess');
                            $('.import-message').html("Error while processing data please try again and verify the format.");
                        },
                        complete: function () {
                            $('#submitspinner').html(``);
                            $('#submitcsv').attr('disabled', false);
                            $('.closeImportCSV').attr('disabled', false);
                        }
                    });
                } else {
                    $('.import-message').addClass('text-danger');
                    $('.import-message').html("Please upload a csv file with defined format.");
                }
            });

            $('.closeImportCSV').click(function () {
                window.location.reload();
            });

            if ('{{ request.GET.paginate_by }}') {
                $('#paginate_courses').val('{{ request.GET.paginate_by }}')
            }

            if (window.location.href.indexOf("table-view") > -1) {
                document.getElementById('tableButton').click();
            }

            $('#paginate_courses').on('change', function () {
                {% comment %}
                if (window.location.href.indexOf("table-view") > -1) {
                    window.location.href = "{{ request.path }}?paginate_by=" + this.value + "#table-view";
                } else {
                    window.location.href = "{{ request.path }}?paginate_by=" + this.value;
                }
                {% endcomment %}
                init.call()
            })
        });

        const truncateString = (string, maxLength = 120) => {
            if (!string) return null;
            const showDots = string.length > maxLength;
            return `${string.substring(0, maxLength)}${showDots ? '...' : ''}`;
        };


    </script>
    <script>
        document.querySelector("#cardButton").addEventListener('click', cardView);
        document.querySelector("#tableButton").addEventListener('click', tableView);

        function cardView() {
            $("#cardButton").css('color', 'black');
            $("#tableButton").css('color', 'grey');
            document.querySelector('#cardView').style.display = "inline-block";
            document.querySelector('#tableView').style.display = "none";
        }

        function tableView() {
            $("#cardButton").css('color', 'grey');
            $("#tableButton").css('color', 'black');
            document.querySelector('#tableView').style.display = "block";
            document.querySelector('#cardView').style.display = "none";
        }

        var Pagination = {

            code: '',

            // --------------------
            // Utility
            // --------------------

            // converting initialize data
            Extend: function (data) {
                data = data || {};
                Pagination.size = data.size || 300;
                Pagination.page = data.page || 1;
                Pagination.step = data.step || 3;
            },

            // add pages by number (from [s] to [f])
            Add: function (s, f) {
                for (var i = s; i < f; i++) {
                    Pagination.code += '<a>' + i + '</a>';
                }
            },

            // add last page with separator
            Last: function () {
                Pagination.code += '<i>...</i><a>' + Pagination.size + '</a>';
            },

            // add first page with separator
            First: function () {
                Pagination.code += '<a>1</a><i>...</i>';
            },


            // --------------------
            // Handlers
            // --------------------

            // change page
            Click: function () {
                Pagination.page = +this.innerHTML;
                Pagination.Start();
            },

            // previous page
            Prev: function () {
                Pagination.page--;
                if (Pagination.page < 1) {
                    Pagination.page = 1;
                }
                Pagination.Start();
            },

            // next page
            Next: function () {
                Pagination.page++;
                if (Pagination.page > Pagination.size) {
                    Pagination.page = Pagination.size;
                }
                Pagination.Start();
            },


            // --------------------
            // Script
            // --------------------

            // binding pages
            Bind: function () {
                var a = Pagination.e.getElementsByTagName('a');
                for (var i = 0; i < a.length; i++) {
                    if (+a[i].innerHTML === Pagination.page) a[i].className = 'current';
                    a[i].addEventListener('click', Pagination.Click, false);
                }
            },

            // write pagination
            Finish: function () {
                Pagination.e.innerHTML = Pagination.code;
                Pagination.code = '';
                Pagination.Bind();
            },

            // find pagination type
            Start: function () {
                $('.listcard').css('display', 'none');
                showEntries = parseInt(document.getElementById('paginate_courses').value)
                for (var i = (Pagination.page * showEntries) - 1; i >= (Pagination.page * showEntries) - showEntries; i--) {
                    $($('.listcard')[i]).css('display', 'block')
                }

                if (Pagination.size < Pagination.step * 2 + 6) {
                    Pagination.Add(1, Pagination.size + 1);
                } else if (Pagination.page < Pagination.step * 2 + 1) {
                    Pagination.Add(1, Pagination.step * 2 + 4);
                    Pagination.Last();
                } else if (Pagination.page > Pagination.size - Pagination.step * 2) {
                    Pagination.First();
                    Pagination.Add(Pagination.size - Pagination.step * 2 - 2, Pagination.size + 1);
                } else {
                    Pagination.First();
                    Pagination.Add(Pagination.page - Pagination.step, Pagination.page + Pagination.step + 1);
                    Pagination.Last();
                }
                Pagination.Finish();
            },


            // --------------------
            // Initialization
            // --------------------

            // binding buttons
            Buttons: function (e) {
                var nav = e.getElementsByTagName('a');
                nav[0].addEventListener('click', Pagination.Prev, false);
                nav[1].addEventListener('click', Pagination.Next, false);
            },

            // create skeleton
            Create: function (e) {

                var html = [
                    '<a>&#9668;</a>', // previous button
                    '<span></span>',  // pagination container
                    '<a>&#9658;</a>'  // next button
                ];

                e.innerHTML = html.join('');
                Pagination.e = e.getElementsByTagName('span')[0];
                Pagination.Buttons(e);
            },

            // init
            Init: function (e, data) {
                Pagination.Extend(data);
                Pagination.Create(e);
                Pagination.Start();
            }
        };


        /* * * * * * * * * * * * * * * * *
        * Initialization
        * * * * * * * * * * * * * * * * */

        var init = function () {
            let pagesize = Math.ceil(document.getElementsByClassName('listcard').length / parseInt(document.getElementById('paginate_courses').value))

            Pagination.Init(document.getElementById('pagination'), {
                size: pagesize, // pages size
                page: 1,  // selected page
                step: 3   // pages before and after current
            });
        };

        document.addEventListener('DOMContentLoaded', init, false);

        $('#searchCourseForm').on('submit', function (e) {
            e.preventDefault()
            let queryString = $(this).find('input[name=query]').val().toLowerCase()
            $('.listcard').css('display', 'none')
            if (!queryString || queryString === "") {
                $('#pagination').css('display', 'block')
                init.call()
            } else {
                $('.listcard').each(function () {
                    if ($(this).find('.card-title').text().toLowerCase().includes(queryString)) {
                        $(this).css('display', 'block')
                    }
                    $('#pagination').css('display', 'none')
                })
            }

        })

    </script>
