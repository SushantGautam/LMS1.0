{% extends "base.html" %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'start' %}">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Session</li>
{% endblock %}
{% block content %}
<div class="page-header">
    <div class="page-title">
        <h2>List of Inactive Sessions</h2>
        <div>
            <a href="javascript:void(0)" class="btn btn-sm btn-outline-primary" title="List" data-toggle="tooltip"
                id="listButton">
                <i class="fa fa-th-list"></i>
            </a>
            <a href="javascript:void(0)" class="btn btn-sm btn-outline-primary ml-2" title="Grid" data-toggle="tooltip"
                id="cardButton">
                <i class="fa fa-th-large"></i>
            </a>
        </div>
    </div>
</div>


<form method="post" action="{% url 'inninginfo_inactive_delete_checked' %}">
    {% csrf_token %}
    <div class="row">
        <div class="col-lg-8 col-md-6 col-sm-6">
            <a href="{% url 'inninginfo_list' %}"><b>View Active Sessions</b></a>
        </div>
        <div class="col-lg-4 col-md-6 col-sm-6">
            {% if request.user.Is_CenterAdmin and '/mysessions' not in request.path %}
            <div class="pull-right">
                <a class="btn btn-success" href="{% url 'inninginfo_create' %}">Register New Session</a>
                <button class="btn btn-info btn-floating editCheckedInnings ml-2" type="button" data-toggle="modal"
                    data-target="#edit_checked_details_modal">
                    <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-floating deleteCheckedInnings ml-2" type="submit"
                    onclick="return confirm('Are you sure you want to delete ?')">
                    <i class="fa fa-trash"></i>
                </button>

            </div>
            {% endif %}
        </div>
    </div>
    <div class="table-responsive mt-3" id="listView">
        <table class="table table-striped nowrap" id="inning_dataTable">
            <thead class="thead-light">
                <tr class="tableTitleRow">
                    <th> <input type="checkbox" class="inningInfoCheckAll"> </th>
                    <th>ID</th>
                    <th>Session Name</th>
                    <th>Student Group</th>
                    <th>No. of Courses</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for object in object_list %}
                <tr>
                    <td>
                        <input type="checkbox" class="inningInfoCheckbox" name="inning_id[]" value="{{ object.pk }}">
                    </td>
                    <td style="vertical-align: middle;">{{ forloop.counter }}</td>
                    <td style="vertical-align: middle;"><B><a
                                href="{{ object.get_absolute_url }}">{{ object.Inning_Name }}</a></B></td>
                    <td style="vertical-align: middle;">{{ object.Groups }}</td>
                    <td style="vertical-align: middle;">{{ object.Course_Group.count }}</td>
                    <td style="vertical-align: middle;">{{ object.Start_Date }}</td>
                    <td style="vertical-align: middle;">{{ object.End_Date }}</td>
                    <td class="text-center">
                        <a class="btn btn-info btn-floating" href="{{ object.get_update_url }}">
                            <i class="fa fa-edit"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <span class="checkboxCheckedLength"></span>
    </div>
</form>

<div id="cardView" style="display:none;" class="mt-3">
    <div class="row">
        {% for object in object_list %}
        <div class="col-lg-4 col-sm-6 col-xs-12">
            <div class="card p-4">
                <h5><strong>Session : &nbsp;<a href="{{ object.get_absolute_url }}"
                            class="text-primary">{{ object.Inning_Name }}</a></strong>
                </h5>
                <hr>
                <span><b>Student Group &nbsp; : </b>&nbsp;{{ object.Groups }}</span>
                <b>Courses :</b>
                <span>
                    <p style="height:40px; overflow:auto;padding:0 10px">
                        {% for groups in object.Course_Group.all %}
                        {{ groups.Course_Code }}
                        {% endfor %}
                    </p>
                </span>
                <span><b>Start Date : </b>&nbsp;{{ object.Start_Date|date:'Y M d' }}</span>
                <span><b>End Date : </b>&nbsp;{{ object.End_Date|date:'Y M d' }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% include 'inning/inninginfo_form_common.html' %}

{% endblock %}
{% block javascript %}
<script type="text/javascript">
    $(document).ready(function () {
        $('.table').DataTable({
            dom: 'lBfrtip',
            responsive: true,
            buttons: [
                {
                    extend: 'csv',
                    text: '<span class="exportcsv"><i class="fa fa-paper-plane-o"></i> Export to CSV </span>',
                     title: 'Inactive Session List',
                },
                {
                    extend: 'print',
                    text: '<span class="print"><i class="fa fa-print"></i> Print </span>',
                    fieldSeparator: '\t'
                }]
        });
    });
</script>

<script>
    $(document).ready(function () {
        $("#listButton").addClass('active')
    });

    document.querySelector("#cardButton").addEventListener('click', cardView);
    document.querySelector("#listButton").addEventListener('click', listView);

    function cardView() {
        $("#cardButton").addClass('active')
        $("#listButton").removeClass('active')
        document.querySelector('#cardView').style.display = "inline-block";
        document.querySelector('#listView').style.display = "none";
    }

    function listView() {
        $("#listButton").addClass('active')
        $("#cardButton").removeClass('active')
        document.querySelector('#listView').style.display = "inline-block";
        document.querySelector('#cardView').style.display = "none";

    }
</script>

<script>
    $(document).ready(function () {
        $(".editCheckedInnings").on('click', function () {
            let seleced_innings = []
            $.each($('#inning_dataTable input[type="checkbox"]:checked').not('.inningInfoCheckAll'), function (index) {
                seleced_innings.push($(this).val())
            })
            $('#inning_ids').val(seleced_innings)
        });
    });

    $('#Student_Group').select2({
        width: '100%',
    });

    $('.inningInfoCheckAll').on('click', function () {
        $('#inning_dataTable input:checkbox').not(this).prop('checked', this.checked);
        checkboxChangeEvent()
    })

    $('.inningInfoCheckbox').on('click', function () {
        checkboxChangeEvent()
        if ($('.inningInfoCheckbox').length === $('.inningInfoCheckbox:checked').length) {
            $('.inningInfoCheckAll').prop('checked', 'checked');
        } else {
            $('.inningInfoCheckAll').prop('checked', false);
        }
    });

    function checkboxChangeEvent() {
        let checkBoxlength = $('#inning_dataTable input[type="checkbox"]:checked').not('.inningInfoCheckAll').length

        if (checkBoxlength > 0) {
            $('.checkboxCheckedLength').text(checkBoxlength + ' of ' + $('.inningInfoCheckbox').length + ' selected')
            $('.editCheckedInnings, .deleteCheckedInnings').removeAttr('disabled')
        } else {
            $('.checkboxCheckedLength').text('')
            $('.editCheckedInnings, .deleteCheckedInnings').prop('disabled', 'disabled')
        }
    }

    $('#editCheckedInnings').on('submit', function (e) {
        e.preventDefault()
        if (($('#start_Date').is(':disabled') && $('#end_Date').is(':disabled') && $('#Student_Group').is(':disabled'))
            || ($('#start_Date').val() == '' && $('#end_Date').val() == '' && $('#Student_Group').val() == '')
        ) {
            alert('Please input data and enable required fields to submit')
            return false
        }

        if ($('#start_Date').is(':disabled') || $('#end_Date').is(':disabled')) {
            var form = $(this);
            var url = form.attr('action');

            $.ajax({
                type: "POST",
                url: url,
                data: form.serialize(), // serializes the form's elements.
                success: function (data) {
                    location.reload(); // show response from the php script.
                },
                error: function (e) {
                    $('.error-div').empty()
                    $('.error-div').css('display', 'block')
                    $('.error-div').append(`
                        <p style="font-weight: bold; font-size: medium">${e.responseJSON.message}</p>
                    `)
                    $.each(e.responseJSON.inning_list, function (index) {
                        $('.error-div').append(`
                            <p style="font-size: small">${e.responseJSON.inning_list[index]['Inning_Name']}</p>
                        `)
                    })

                }
            });
        } else {
            start = new Date($('#start_Date').val()).getTime()
            end = new Date($('#end_Date').val()).getTime()
            if (end < start) {
                alert('End Date must be greater than Start Date.')
                return false
            } else {
                $(this).submit()
            }
        }
    });

    $('#changestudentgroup-btn').on('click', function () {
        toggleInput('#Student_Group')
        $("#changestudentgroup-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changestartdate-btn').on('click', function () {
        toggleInput('#start_Date')
        $("#changestartdate-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changeenddate-btn').on('click', function () {
        toggleInput('#end_Date')
        $("#changeenddate-btn").toggleClass('btn-outline-primary btn-primary')
    });

    function toggleInput(inputID) {
        if ($(inputID).is(':disabled')) {
            $(inputID).removeAttr('disabled');
        } else {
            $(inputID).prop('disabled', 'disabled')
        }
    }
    checkboxChangeEvent()
</script>
{% endblock %}