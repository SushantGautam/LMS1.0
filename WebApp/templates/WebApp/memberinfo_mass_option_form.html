{% load static %}
{% load crispy_forms_tags %}
{% load i18n %}

<!-- Modal -->
<div class="modal fade" id="edit_checked_details_modal" tabindex="-1" role="dialog"
    aria-labelledby="edit_checked_details_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary font-weight-bold" id="edit_checked_details_modal_title">
                    {% trans "Edit Selected Members" %}
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i class="ti-close"></i>
                </button>
            </div>
            <div class="error-div" style="display: none">

            </div>

            <div class="modal-body">
                <form method="post" id="editCheckedMembers" action="
                    {% if '/inactive' in request.path %}
                        {% url 'memberinfo_inactive_edit_checked' %}
                    {% else %}
                        {% url 'memberinfo_edit_checked' %}
                    {% endif %}
                    ">
                    {% csrf_token %}
                    <input type="hidden" name="member_ids[]" id="member_ids">
                    <div class="form-group">
                        <div class="row">
                            <div class="col-9">
                                <select class="select2" id="id_Member_Department" name="Member_Department">
                                    {% for x, y in partial_member_form.fields.Member_Department.choices %}
                                    <option value="{{ x }}"
                                        {% if partial_member_form.initial.Member_Department == x %}selected{% endif %}>
                                        {{ y }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <!-- {{ partial_member_form.Member_Department }} -->
                            </div>
                            <div class="col-3 text-center m-auto">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                    id="changedepartment-btn">{% trans "Change" %}</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-9">
                                <select class="select2" id="id_Member_Position" name="Member_Position">
                                    {% for x, y in partial_member_form.fields.Member_Position.choices %}
                                    <option value="{{ x }}"
                                        {% if partial_member_form.initial.Member_Position == x %}selected{% endif %}>
                                        {{ y }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <!-- {{ partial_member_form.Member_Position }} -->
                            </div>
                            <div class="col-3 text-center m-auto">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                    id="changememberposition-btn">{% trans "Change" %}</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-9">
                                <select class="select2" id="id_Member_Gender" name="Member_Gender">
                                    {% for x, y in partial_member_form.fields.Member_Gender.choices %}
                                    <option value="{{ x }}"
                                        {% if partial_member_form.initial.Member_Gender == x %}selected{% endif %}>
                                        {{ y }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <!-- {{ partial_member_form.Member_Gender }} -->
                            </div>
                            <div class="col-3 text-center m-auto">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                    id="changemembergender-btn">{% trans "Change" %}</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-9">
                                <!--
                                If the checkbox is selected then the checkbox value will be submitted else, hidden value is submitted
                                This is because if checkbox is enabled but not checked, then the html won't submit off value.
                                 -->
                                <input id='id_Is_Teacher_hidden' type='hidden' value='0' name='Is_Teacher'>
                                {{ partial_member_form.Is_Teacher }}
                                <label for="id_Is_Teacher" class="ml-3">{% trans "Is Teacher" %}</label>
                            </div>
                            <div class="col-3 text-center m-auto">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                    id="changeisteacher-btn">{% trans "Change" %}</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-9">
                                <input id='id_Is_Student_hidden' type='hidden' value='0' name='Is_Student'>
                                {{ partial_member_form.Is_Student }}
                                <label for="id_Is_Student" class="ml-3">{% trans "Is Student" %}</label>
                            </div>
                            <div class="col-3 text-center m-auto">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                    id="changeisstudent-btn">{% trans "Change" %}</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-9">
                                <input id='id_Use_Flag_hidden' type='hidden' value='0' name='Use_Flag'>
                                {{ partial_member_form.Use_Flag }}
                                <label for="id_Use_Flag" class="ml-3">{% trans "Status" %}</label>
                            </div>
                            <div class="col-3 text-center m-auto">
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                    id="changeActive-btn">{% trans "Change" %}</button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">{% trans "Save changes" %}</button>
                        <button type="button" class="btn btn-secondary ml-3"
                            data-dismiss="modal">{% trans "Close" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'vendors/bundle.js' %}"></script>

<script>
    $(document).ready(function () {

        $('#id_Member_Department').select2({
            placeholder: 'Select Department'
        });
        $('#id_Member_Position').select2({
            placeholder: 'Select Position'
        });
        $('#id_Member_Gender').select2({
            placeholder: 'Select Gender'
        });

        $(".editCheckedMembers").on('click', function () {
            let seleced_members = []
            $.each($('#member_dataTable input[type="checkbox"]:checked').not('.memberinfoCheckAll'), function (index) {
                seleced_members.push($(this).val())
            })
            $('#member_ids').val(seleced_members)
        });

        $(".deleteCheckedMembers").on('click', function (e) {
            e.preventDefault()
            let seleced_members = []
            $.each($('#member_dataTable input[type="checkbox"]:checked').not('.memberinfoCheckAll'), function (index) {
                seleced_members.push($(this).val())
            });
            $.ajax({
                type: "POST",
                url: "{% url 'memberinfo_inactive_delete_checked' %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'memberinfo_ids': seleced_members,
                }, // serializes the form's elements.
                success: function (data) {
                    location.reload(); // show response from the php script.
                },
                error: function (e) {
                    $('.error-div').empty()
                    $('.error-div').css('display', 'block')
                    $('.error-div').append(`
                        <p style="font-weight: bold; font-size: medium">${e.responseJSON.message}</p>
                    `)
                }
            });
        });
        
    });

    $('.memberinfoCheckAll').on('click', function () {
        $('#member_dataTable input:checkbox').not(this).prop('checked', this.checked);
        checkboxChangeEvent()
    });

    $('#member_dataTable').on('click', '.memberinfoCheckbox', function () {
        if ($('.memberinfoCheckbox').length === $('.memberinfoCheckbox:checked').length) {
            $('.memberinfoCheckAll').prop('checked', 'checked');
        } else {
            $('.memberinfoCheckAll').prop('checked', false);
        }
        checkboxChangeEvent()
    });

    function checkboxChangeEvent() {
        let checkBoxlength = $('#member_dataTable input[type="checkbox"]:checked').not('.memberinfoCheckAll').length
        if (checkBoxlength > 0) {
            $('.checkboxCheckedLength').text(checkBoxlength + ' of ' + $('.memberinfoCheckbox').length + ' selected')
            $('.editCheckedMembers, .deleteCheckedMembers').removeAttr('disabled')
        } else {
            $('.checkboxCheckedLength').text('')
            $('.editCheckedMembers, .deleteCheckedMembers').prop('disabled', 'disabled')
        }
    }

    checkboxChangeEvent();

    $('#changedepartment-btn').on('click', function () {
        toggleInput('#id_Member_Department')
        $("#changedepartment-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changememberposition-btn').on('click', function () {
        toggleInput('#id_Member_Position')
        $("#changememberposition-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changemembergender-btn').on('click', function () {
        toggleInput('#id_Member_Gender')
        $("#changemembergender-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changeisteacher-btn').on('click', function () {
        toggleInput('#id_Is_Teacher')
        toggleInput('#id_Is_Teacher_hidden')
        $("#changeisteacher-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changeisstudent-btn').on('click', function () {
        toggleInput('#id_Is_Student')
        toggleInput('#id_Is_Student_hidden')
        $("#changeisstudent-btn").toggleClass('btn-outline-primary btn-primary')
    });

    $('#changeActive-btn').on('click', function () {
        toggleInput('#id_Use_Flag')
        toggleInput('#id_Use_Flag_hidden')
        $("#changeActive-btn").toggleClass('btn-outline-primary btn-primary')
    });

    function toggleInput(inputID) {
        if ($(inputID).is(':disabled')) {
            $(inputID).removeAttr('disabled');
        } else {
            $(inputID).prop('disabled', 'disabled')
        }
    }

    $('#editCheckedMembers input, select').not('input[name=csrfmiddlewaretoken], #member_ids').attr('disabled', true)

    $(function () {
        $('#editCheckedMembers :checkbox').on('change', function () {
            if (this.checked == true) {
                $(this).val("on");
                $(this).parent().find('input[type=hidden]').val("on");
            } else {
                $(this).val("off");
                $(this).parent().find('input[type=hidden]').val("off");
            }
        });
    });

    // Form Submission

    $('#editCheckedMembers').on('submit', function (e) {
        e.preventDefault()
        if ($('#id_Member_Department').is(':disabled') && $('#id_Member_Position').is(':disabled') && $('#id_Member_Gender').is(':disabled')
            && $('#id_Is_Teacher').is(':disabled') && $('#id_Is_Student').is(':disabled') && $('#id_Use_Flag').is(':disabled')
        ) {
            alert('Please input data and enable required fields to submit')
            return false
        }

        var form = $(this);
        var url = form.attr('action');
        $.ajax({
            type: "POST",
            url: url,
            data: form.serialize(), // serializes the form's elements.
            success: function (data) {
                location.reload(); // show response from the php script.
            },
            error: function (e) {
                $('.error-div').empty()
                $('.error-div').css('display', 'block')
                $('.error-div').append(`
                        <p style="font-weight: bold; font-size: medium">${e.responseJSON.message}</p>
                    `)
                $.each(e.responseJSON.inning_list, function (index) {
                    $('.error-div').append(`
                            <p style="font-size: small">${e.responseJSON.inning_list[index]['Inning_Name']}</p>
                        `)
                })

            }
        });
    });
</script>