{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'start' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item">
    <a href="
    {% if object.Course_Code.Use_Flag %}
        {% url 'courseinfo_grid_active' %}
    {% else %}
        {% url 'courseinfo_grid_inactive' %}
    {% endif %}">
        {% trans "Course" %}
    </a>
</li>
<li class="breadcrumb-item"><a href="{{ object.Course_Code.get_absolute_url }}">{{ object.Course_Code }}</a></li>
<li class="breadcrumb-item"><a href="{{ object.Chapter_Code.get_absolute_url }}">{{ object.Chapter_Code }}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ object.Assignment_Topic }}</li>
{% endblock %}
{% block content %}
{% include 'assignment/assignmentinfo_detail.html' %}
{% endblock %}




{% block javascript %}
<!-- <script src="{% static 'vendorsx/jquery/dist/jquery.min.js' %}"></script>
<script src=" {% static 'vendorsx/jQuery-Smart-Wizard/js/jquery.smartWizard.js' %}"></script>
<script src="{% static 'vendorsx/moment/min/moment.min.js' %}"></script>
<script src="{% static 'vendorsx/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js' %}"></script> -->
<script>    $(".se-pre-con-ajax").fadeOut("fast");</script>

<script>
    document.getElementById('id_Assignment_Start_edit').value = new Date(document.getElementById('id_Assignment_Start_edit').value).toLocaleString("en-US")
    document.getElementById('id_Assignment_Deadline_edit').value = new Date(document.getElementById('id_Assignment_Deadline_edit').value).toLocaleString("en-US")
    // $('#id_Assignment_Deadline_edit').datetimepicker();
    // $('#id_Assignment_Start_edit').datetimepicker();
    $("#ajaxassignmentinfoform").submit(function (e) {
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $.ajax({
            url: "{% url 'assignmentinfo_edit_ajax' object.pk %}",  // URL to your view that serves new info
            data: {
                "csrfmiddlewaretoken": '{{ csrf_token }}',
                "Assignment_Topic": $('#id_Assignment_Topic_edit').val(),
                "Assignment_Start": new Date($('#id_Assignment_Start_edit').val()).toISOString(),
                "Assignment_Deadline": new Date($('#id_Assignment_Deadline_edit').val()).toISOString(),
                "Use_Flag": $('#id_Use_Flag').is(":checked"),
                "Course_Code": $('#id_Course_Code').val(),
                "Chapter_Code": $('#id_Chapter_Code').val(),
                "Register_Agent": $('#id_Register_Agent').val(),
                "Assignment_ID": '{{ object.id }}'
            },
            // get the form data
            type: $(this).attr('method'), // GET or POST
            success: function (response) {
                console.log('Success')
                location.reload()
            },
            error: function (err) {
                console.log('Error in posting assignment create form')
                $('.form-errors').empty().append(err.responseJSON.Message).css('display', 'block')
            }

        });
    });

    $('#id_Assignment_Deadline_edit').on('dp.change', function (event) {
        const result = document.querySelector('.result');
        var date = new Date();
        var deadline = new Date(event.target.value);
        var remaining = dateDifference(deadline, date);
        if (remaining < 0) {
            result.textContent = `Days Remaining : Invalid`;

        } else {
            result.textContent = `Days Remaining : ${remaining}`;

        }
        ;
    });
</script>

<script>
    $('#myModal').on('shown.bs.modal', function () {
        $('#myInput').trigger('focus')
    });

    $(document).on('click', '.confirm-delete', function () {
        ans = confirm('Are you sure you want to delete this Question?');
        if (ans == true) {
            $(`#deleteQuestion${this.id}`).submit();
        } else {
            return false;
        }
    });

    $(document).on('click', '.assignment-confirm-delete', function () {
        ans = confirm('Are you sure you want to delete this Assignment?');
        if (ans == true) {
            $(`#deleteAssignment${this.id}`).submit();
        } else {
            return false;
        }
    });

    $('#add-newquestion-btn').on('click', function () {
        if (submitted) {
            return false
        }
        $('#add_question_modal_body').empty();
        $('#add_question_modal_body').append(
            `<input type="hidden" name="Assignment_Code" id="id_Assignment_Code" value="{{ object.pk }}"
                           class="select form-control">`
        )
        $.ajax({
            type: "GET",
            url: "{% url 'questioninfo_create_ajax' %}",  // URL to your view that serves new info
            success: function (response) {
                $('#add_question_modal_body').append(response);
            },
            error: function () {
                submitted = false;
                console.log('Error in generating add question form')
            },
            complete: function () {
                $(".se-pre-con-ajax").fadeOut("fast");
            }
        });
    });

    $('.editquestion-btn').on('click', function () {
        if (submitted) {
            return false
        }
        $('#edit_question_modal_body').empty();
        $('#edit_question_modal_body').append(
            `<input type="hidden" name="Assignment_Code" id="id_Assignment_Code" value="{{ object.pk }}"
                           class="select form-control">`
        )
        $('#edit_question_modal_body').attr('data-questionpk', $(this).attr('data-questionpk'))
        $.ajax({
            type: "GET",
            url: `/questioninfo/edit/${$(this).attr('data-questionpk')}/ajax/`,  // URL to your view that serves new info
            success: function (response) {
                $('#edit_question_modal_body').append(response);
                $('#edit_question_modal_body').find('form')
            },
            error: function () {
                submitted = false;
                console.log('Error in generating edit question form')
            },
            complete: function () {
                $(".se-pre-con-ajax").fadeOut("fast");
            }
        });
    });





    var submitted = false;
    $(".qacontainer").on('click', '.submitAnswer', function (e) {
        e.preventDefault(); // avoid to execute the actual submit of the form.
        if (submitted) {
            return false
        }
        submitted = true;
        var answerdata = new FormData();
        if ($(`#id_Assignment_File${$(this).attr('data-id')}`).val()) {
            var answer_file = $(`#id_Assignment_File${$(this).attr('data-id')}`)[0].files[0];
        } else {
            var answer_file = 0;
        }

        if ($(`#id_Assignment_Answer${$(this).attr('data-id')}`).val()) {
            var answer_text = $(`#id_Assignment_Answer${$(this).attr('data-id')}`).val();
        } else {
            var answer_text = '';
        }

        if (answer_file == 0 && answer_text == '') {
            console.log('empty');
        } else {
            answerdata.append("Assignment_File", answer_file);
            answerdata.append("csrfmiddlewaretoken", '{{csrf_token}}');
            answerdata.append("Assignment_Answer", answer_text);
            answerdata.append("Question_Code", $(`#id_Question_Code${$(this).attr('data-id')}`).val());
            answerdata.append("Student_Code", $(`#id_Student_Code${$(this).attr('data-id')}`).val());

            $.ajax({
                url: $(this).attr('data-url'),  // URL to your view that serves new info
                data: answerdata,
                // get the form data
                type: 'post', // GET or POST
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log('Success')
                    location.reload()
                },
                error: function (e) {
                    submitted = false;
                    alert(e.responseJSON.msg)
                    console.log('Error in submitting file. ' + e.responseJSON.msg)
                }
            });
        }
    });
</script>

<script>
    $(".answerButton").click(function () {
        $(`#answerContent${this.id}`).toggle();
    });
</script>

<script>
    $(document).ready(function () {
        $('.deleteanswer').on('click', function () {
            var answerpk = this.value
            var result = confirm("Are you sure you want to delete this answer?");
            if (!result) {
                return false
            }
            $.ajax({
                method: 'POST',
                url: "{% url 'assignanswerinfo_delete' %}",  // URL to your view that serves new info
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    'answerpk': answerpk,
                },
                success: function (response) {
                    location.reload()
                },
                error: function (err) {
                    console.log(err.responseText)
                    location.reload()
                },
            });
        });
        $('.editanswer').click(function () {
            $(this).parent().children().css('display', 'none')
            $(this).parent().append(`
                <div class="editdiv">
                <form>
                    <textarea class="form-control rounded-0" rows="5" cols="100"
                              name="Assignment_Answer"
                              placeholder="Enter your Answer"
                              id="id_Assignment_Answer${$(this).attr('data-Question_Code')}" required>${$(this).parent().find('p').text()}</textarea>
                    <input type="hidden" value="${$(this).attr('data-Student_Code')}" name="Student_Code"
                    id=id_Student_Code${$(this).attr('data-Question_Code')}>
                    <input type="hidden" value="${$(this).attr('data-Question_Code')}" name="Question_Code"
                    id=id_Question_Code${$(this).attr('data-Question_Code')}>
                    <div class="form-group text-center">

                             <button class="btn btn-sm btn-primary cancelBtn" type="button" id="cancelButton{{ questions.pk }}">
                                Cancel
                            </button>
                            <button class="btn btn-sm btn-primary resetBtn" type="reset">Reset</button>

                            <button type="button" class="btn btn-sm btn-success submitAnswer"
                                    id="answer${$(this).attr('data-Question_Code')}"
                                    data-id="${$(this).attr('data-Question_Code')}"
                                    data-url="{% url 'assignanswerinfo_create_ajax' %}?editanswer=${this.value}">Submit
                            </button>
                    </div>
                    </form>
                </div>
                `)
        })

        $('.qacontainer').on('click', '.cancelBtn', function () {
            $(this).closest('.editdiv').parent().children().css('display', 'block')
            $(this).closest('.editdiv').remove()
        })
        //$('.qacontainer').on('click', '.resetBtn', function () {
        //  $(this).closest('.editdiv').find('textarea').val('')
        //})
    })
        // $('input[type=datetime-local]').each(function () {
        //    $(this).val(`${newdate.getFullYear()}-${('0' + newdate.getMonth()).substr(-2)}-${('0' + newdate.getDate()).substr(-2)}T${('0' + newdate.getHours()).substr(-2)}:${('0' + newdate.getMinutes()).substr(-2)}`)
        // })
</script>
{% endblock %}