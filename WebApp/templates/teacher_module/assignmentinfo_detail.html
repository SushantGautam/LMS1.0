{% extends "teacher_module/base.html" %}
{% load static %}
{% load i18n %}
{% load model_template_relation %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'teacher_home' %}">{% trans "Home" %}</a></li>
<li class="breadcrumb-item"><a href="
        {% if object.Course_Code.Use_Flag %}
            {% url 'teacher_mycourses_list_active' %}
        {% else %}
            {% url 'teacher_mycourses_list_inactive' %}
        {% endif %}
    ">{% trans "My Courses" %}</a></li>
<li class="breadcrumb-item"><a href="{{ object.Course_Code.teacher_get_absolute_url }}">{{ object.Course_Code }}</a>
</li>
<li class="breadcrumb-item"><a href="{{ object.Chapter_Code.teacher_get_absolute_url }}">{{ object.Chapter_Code }}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">{{ object.Assignment_Topic }}</li>
{% endblock %}

{% block content %}
<div class="modal fade" id="exampleModal1" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true" id="create_session_modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">
                    {% trans "Answer" %}Answer
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="color: black;height: -webkit-fill-available;">
                <div id="answercontent">

                </div>
                <hr>
                <div id="StudentScore">

                </div>

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="create_session_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary font-weight-bold">{% trans "Answer" %} </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i class="ti-close"></i>
                </button>
            </div>
            <div class="modal-body" style="color: black;height: -webkit-fill-available;">
                <div id="answercontent">
                </div>
                <hr>
                <div id="StudentScore">
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editAssignmentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title text-primary font-weight-bold">{% trans "Edit Assignment" %}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i class="ti-close"></i>
                </button>
            </div>
            <div class="modal-body px-0" id="editAssignment_modal_body">
                <form method="post" id="ajaxassignmentinfoform">
                    {% csrf_token %}
                    <div class="alert alert-danger form-errors" style="display: none">
                    </div>
                    <div class="form-group has-feedback">
                        <div id="div_id_Assignment_Topic_edit" class="form-group">
                            <label for="id_Assignment_Topic_edit" class="control-label ">
                                {% trans "Assignment Topic" %} *
                            </label>
                            <div class="controls">
                                <input type="text" name="Assignment_Topic" maxlength="500" id="id_Assignment_Topic_edit"
                                    class="textinput textInput form-control" required="required"
                                    value="{{ object.Assignment_Topic }}">
                            </div>
                        </div>
                    </div>
                    <!--{% comment %}
                    <div class="form-group has-feedback">
                        <div id="div_id_Assignment_Start_edit" class="form-group">
                            <label for="id_Assignment_Start_edit" class="control-label ">
                                Assignment Start *
                            </label>
                            <div class="controls ">
                                <input type="text" name="Assignment_Start_edit" class="form-control"
                                    id="id_Assignment_Start_edit" value="{{ object.Assignment_Start|date:'c' }}" min=""
                                    max="9999-12-31">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12 form-group has-feedback">
                        <div id="div_id_Assignment_Deadline_edit" class="form-group">
                            <label for="id_Assignment_Deadline_edit" class="control-label ">
                                Assignment Deadline *
                            </label>
                            <div class="controls ">
                                <input type="text" name="Assignment_Deadline_edit" class="form-control"
                                    id="id_Assignment_Deadline_edit" value="{{ object.Assignment_Deadline|date:'c' }}"
                                    min="{{ datetime|date:'Y-m-d' }}" max="9999-12-31">
                            </div>
                        </div>
                    </div>
                    {% endcomment %}-->
                    <div>
                        <label>{% trans "Publish" %}</label><br>
                        <input type="checkbox" id="id_Use_Flag" class="js-switch" name="Use_Flag" 
                        {% if object.Use_Flag == False %} &nbsp; {% elif object.Use_Flag == True %} checked {% endif %}><br>
                        <br>
                    </div>
                    {% if assigned_session|length > 0 %}
                    <div>
                        <table class="table" id="inning_dataTable">
                            <tr>
                                <th><input type="checkbox" name="sessiondataAll" class="inningInfoCheckAll" checked></th>
                                <th>{% trans "S.No" %}</th>
                                <th>{% trans "Session Name" %}</th>
                                <th>{% trans "Start Date" %}</th>
                                <th>{% trans "End Date" %}</th>
                                {# <th></th>#}
                            </tr>
                    
                            {% for session in assigned_session %}
                            {% if object %}
                            {% getSessionMap object 'assignmentinfo' session as sessionmap %}
                            {% endif %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="sessiondata" class="inningInfoCheckbox" checked>
                                </td>
                                <td class="counter">{{ forloop.counter }}</td>
                                <td class="session_id"><input type="text" class="form-control" value="{{ session.Inning_Name }}"
                                        data-value="{{ session.id }}" readonly required></td>
                                <td class="session_start_date">
                                    <input type="text" name="Start_Date" class="form-control" max="9999-12-31" autocomplete="off"
                                        value="{{ sessionmap.0.Start_Date|date:'c' }}" required>
                                </td>
                                <td class="session_end_date">
                                    <input type="text" name="End_Date" class="form-control" value="{{ sessionmap.0.End_Date|date:'c' }}"
                                        max="9999-12-31" autocomplete="off" required>
                                </td>
                                {# <td title="Copy Date in all selected fields" class="date_copybtn"><i class="fa fa-copy"></i>#}
                                    {# </td>#}
                            </tr>
                            {% endfor %}
                    
                        </table>
                    </div>
                    {% endif %}
                    <div class="result text-center"></div>

                    <input type="hidden" name="Register_Agent" id="id_Register_Agent" value="{{ request.user.id }}"
                        class="select form-control">
                    <input type="hidden" name="Course_Code" id="id_Course_Code" value="{{ object.Course_Code.id }}"
                        class="select form-control">
                    <input type="hidden" name="Chapter_Code" id="id_Chapter_Code" value="{{ object.Chapter_Code.id }}"
                        class="select form-control">
                    <input type="hidden" name="today_date" id="id_today_date" value="{{ datetime|date:'Y-m-d' }}"
                        class="select form-control">

                    <div class="submitButton text-center col-md-12">
                        <button class="btn btn-primary" type="submit">{% trans "Submit" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="add_question_modal" tabindex="-1" role="dialog" aria-labelledby="add_question_modalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title text-primary font-weight-bold">{% trans "Add Question" %}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i class="ti-close"></i>
                </button>
            </div>
            <div class="modal-body modal-auto" id="add_question_modal_body">
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 col-md-12 col-sm-12 col-xs-12 ">
        <div class="text-center">
            <div class="page-title">
                <h2 class="text-primary">Assignment Information</h2>
            </div>
        </div>
        <hr/>
        <div class="page-header">
            <div class="page-title pb-3">
                <h3 class="d-flex align-items-center">
                    {{ object.Assignment_Topic }}
                </h3>
            </div>
        </div>
        <div class="card p-2">
            <div class="d-flex justify-content-between align-items-center mx-2 mt-2 mb-3">
                <h4 class="text-primary mb-0">{% trans "List of Questions" %}</h4>
                {% if not "students" in request.get_full_path %}
                <div>
                    <button type="button" class="btn btn-sm btn-success" data-toggle="modal" data-target="#add_question_modal"
                        id="add-newquestion-btn">
                        {% trans "Add Question" %}
                    </button>
                </div>
                {% endif %}
            </div>
            <div>
                {% for question in questions %}
                <div class="accordion mb-4" id="questionList{{ question.pk }}">
                    <div class="card shadow-none border">
                        <div class="card-header justify-content-between" id="headingOne">
                            <div class="d-flex align-items-center pr-3">
                                <figure class="avatar avatar-sm">
                                    <span class="avatar-title rounded-circle"> {{ forloop.counter }}</span>
                                </figure>
                                <h5 class="text-secondary m-0 pl-3 cursor-pointer">
                                    {{ question.Question_Title }}
                                </h5>
                            </div>
                            <div class="d-flex" style="min-width: 120px;">
                                <div class="row align-items-center">
                                    <button class="btn btn-primary btn-sm mr-3" type="button" data-toggle="collapse"
                                    data-target="#answer-collapse-{{ question.id }}" aria-expanded="false" aria-controls="collapseExample">
                                    Answers
                                </button>
                                {% if '/students' not in request.path %}
                                <button class="btn editquestion-btn btn-info btn-floating mr-3" data-toggle="modal" data-target="#editQuestionModal"
                                    data-questionpk="{{ question.pk }}" id="editquestion-btn{{ question.pk }}">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <div class="modal fade" id="editQuestionModal" tabindex="-1" role="dialog"
                                    aria-labelledby="editQuestionLabel" aria-hidden="true" id="editquestion-btn{{ questions.pk }}">
                                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header text-center">
                                                <h5 class="modal-title text-primary font-weight-bold">Edit Question</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <i class="ti-close"></i>
                                                </button>
                                            </div>
                                            <div class="modal-body modal-auto" id="edit_question_modal_body">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% if '/teachers' in request.path %}
                                <button id="{{ question.pk }}" class="btn btn-floating btn-danger confirm-delete">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <form method="post" action="{% url 'teacher_questioninfo_delete' assignment=object.pk pk=question.pk %}"
                                    id="deleteQuestion{{ question.pk }}">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ question.pk }}" name="question_id">
                                    <input type="hidden" value="{{ object.pk }}" name="assignment_id">
                                    <input type="hidden" value="{{ object.Course_Code.id }}" name="course_id">
                                    <input type="hidden" value="{{ object.Chapter_Code.id }}" name="chapter_id">
                                </form>
                                {% else %}
                                <button id="{{ question.pk }}" class="btn btn-floating btn-danger confirm-delete"> <i class="fa fa-trash"></i> </button>
                                <form method="post" action="{% url 'webapp_questioninfo_delete' assignment=object.pk pk=questions.pk %}"
                                    id="deleteQuestion{{ questions.pk }}">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ questions.pk }}" name="question_id">
                                    <input type="hidden" value="{{ object.pk }}" name="assignment_id">
                                    <input type="hidden" value="{{ object.Course_Code.id }}" name="course_id">
                                    <input type="hidden" value="{{ object.Chapter_Code.id }}" name="chapter_id">
                                </form>
                                {% endif %}
                                {% endif %}
                                </div>
                                <a data-toggle="collapse" data-target="#question{{ question.pk }}" aria-expanded="true" aria-controls="collapseOne"
                                    href="javascript:void(0)" class="ml-4">
                                    <figure class="avatar avatar-sm">
                                        <span class="avatar-title rounded-circle">
                                            <i class="fa fa-chevron-down"></i>
                                        </span>
                                    </figure>
                                </a>
                            </div>
                        </div>
                        <div id="question{{ question.pk }}" class="collapse" aria-labelledby="headingOne"
                            data-parent="#questionList{{ question.pk }}">
                            <div class="row m-0">
                                <div class="col-lg-9 col-md-8 p-3">
                                    {% if question.Question_Description %}
                                    <p class="mb-1">{% trans "Question Description" %} : {{ question.Question_Description | safe }}</p>
                                    {% else %}
                                    <p class="mb-1">{% trans "No Decription Given" %}</p>
                                    {% endif %}
                                    {% if question.Question_Media_File %}
                                    <p class="mb-1">{% trans "Question Media" %} : </p>
                                    <div class="text-center">
                                        {% if question.extension == '.jpg' or question.extension == '.png' %}
                                        <a href="{{ question.Question_Media_File.url }}" target="_blank">
                                        <img class="card-img-top w-auto" height="300px" src="{{ question.Question_Media_File.url }}">
                                        </a>
                                        {% else %}
                                        <a href="{{ question.Question_Media_File.url }}" target="_blank"><b style="color:#017a9b">
                                                {% trans "Click to view attatched file" %}</b></a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-lg-3 col-md-4 border-top p-3 border-left">
                                    {% if question.Question_Score %}
                                    <p>{% trans "Question Score" %} : {{ question.Question_Score }}</p>
                                    {% endif %}
                                
                                    {% if question.Answer_Type %}
                                    <p>
                                        {% trans "Answer Type" %} : {% if question.Answer_Type == 'S' %}
                                        {% trans "Short Answer" %}
                                        {% elif question.Answer_Type == 'F' %}
                                        {% trans "File Upload" %}
                                        {% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="answer-div collapse p-2 border-top" id="answer-collapse-{{ question.id }}">
                            <div class="py-3">
                                <table class="table table-data table-striped table-bordered bg-white nowrap" style="width: 100%;">
                                    <thead>
                                        <tr class="tableTitleRow">
                                            <th>S.No.</th>
                                            <th>S.No.</th>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Total Marks</th>
                                            <th>Marks Obtained</th>
                                            <th>Answer</th>
                                            <th>Submitted on</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in students_list %}
                                        {% getAssignmentAnswer Assignment student question as answer %}
                                        <tr>
                                            <td class="counterCell" style=" padding-top: 15px;"></td>
                                            <td>{{ forloop.counter }}</td>
                                            <td style=" padding-top: 15px;">{{ student.username }}</td>
                                            <td>{{ student.get_full_name }}</td>
                                            <td>{{ question.Question_Score }} </td>
                                            <td id="Score_{{ answer.pk }}" data-answer_id="{{ answer.id }}"
                                                data-assignment_max_score="{{ answer.Question_Code.Question_Score }}">
                                                {% if answer %}
                                                {% if answer.Assignment_Score is None %}
                                                Not graded
                                                {% else %}
                                                {{ answer.Assignment_Score }}
                                                {% endif %}
                                                <span class="edit_assignment_score" data-assignment_score="{{ answer.Assignment_Score }}">
                                                    <i class="fa fa-edit"></i>
                                                </span>
                                                {% else %}
                                                Not Submitted
                                                {% endif %}
                                            </td>

                                            <td>{{ answer.Assignment_Answer|safe }}</td>
                                            <td>{% if answer %}
                                                Submitted on {{ answer.Updated_DateTime|date:'M d, Y ' }}
                                                {% elif not answer %}
                                                Not Submitted
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                            <span style="display: none;" id="answer_{{ answer.id }}">{{ answer.Assignment_Answer|safe }}</span>
                                                <button class="btn btn-sm btn-primary showanswer" data-toggle="modal"
                                                {#  data-target="#create_session_modal" value="{{ answer.id }}" #}
                                                    data-target="#exampleModal1"
                                                    value="{{ answer.id }}"
                                                    data-question_score="{{ answer.Question_Code.Question_Score }}"
                                                    data-student_Score="{{ answer.Assignment_Score }}"
                                                    data-answer_file="{{ answer.Assignment_File }}"
                                                    data-assignment_feedback="{{ answer.Assignment_Feedback }}"
                                                    {% if not answer %}
                                                        disabled
                                                    {% endif %}>
                                                    View Answer
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 ">
        <div class="card">
            <div class="px-4 pt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-primary m-0">{% trans "Assignment Information" %}</h5>
                    <div class="d-inline-block dropdown">
                        <a href="javascript:void(0)" class="btn btn-outline-light btn-floating btn-sm"
                            data-toggle="dropdown">
                            <i class="ti-more-alt"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            {% if '/student' not in request.get_full_path %}
                            <a href="javascipt:void(0)" class="dropdown-item text-primary" data-toggle="modal"
                                data-target="#editAssignmentModal" id="editAssignment-btn">
                                {% trans "Edit Assignment" %}
                            </a>
                            {% if '/teachers' in request.path %}
                            <a href="javascipt:void(0)" class="dropdown-item text-danger assignment-confirm-delete"
                                id="{{ object.pk }}">{% trans "Delete Assignment" %}</a>
                            <form method="post" action="{% url 'teacher_assignmentinfo_delete' pk=object.pk %}"
                                id="deleteAssignment{{ object.pk }}">
                                {% csrf_token %}
                                <!-- <input type="hidden" value="{{question.pk}}" name="question_id"> -->
                                <input type="hidden" value="{{ object.pk }}" name="assignment_id">
                                <input type="hidden" value="{{ object.Course_Code.id }}" name="course_id">
                                <input type="hidden" value="{{ object.Chapter_Code.id }}" name="chapter_id">
                            </form>
                            {% else %}
                            <a href="javascipt:void(0)" class="dropdown-item text-danger assignment-confirm-delete"
                                id="{{ object.pk }}">{% trans "Delete Assignment" %}</a>
                            <form method="post" action="{% url 'assignmentinfo_delete' pk=object.pk %}"
                                id="deleteAssignment{{ object.pk }}">
                                {% csrf_token %}
                                <!-- <input type="hidden" value="{{question.pk}}" name="question_id"> -->
                                <input type="hidden" value="{{ object.pk }}" name="assignment_id">
                                <input type="hidden" value="{{ object.Course_Code.id }}" name="course_id">
                                <input type="hidden" value="{{ object.Chapter_Code.id }}" name="chapter_id">
                            </form>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!--<p>
                    {% trans "Assignment Start Date" %} : {{ object.Assignment_Start|date:'d M, Y h:i A' }}
                </p>
                <p>
                    {% trans "Assignment End Date" %} : {{ object.Assignment_Deadline|date:'d M, Y h:i A' }}
                </p>-->
                <p>
                    {% trans "Course Name" %} : {{ object.Course_Code }}
                </p>
                <p>
                    {% trans "Chapter Name" %} : {{ object.Chapter_Code }}
                </p>
                <p>
                    {% trans "Status" %} :{% if object.Use_Flag is True %}
                    <span class="badge badge-success">{% trans "Published" %}</span>
                    {% elif object.Use_Flag is False %}
                    <span class="badge badge-danger">{% trans "Not Published" %}</span>
                    {% endif %}
    
                    <!--{% now "Y-m-d H:i" as todays_datewithtime %}
                    {% if object.Assignment_Start and todays_datewithtime < object.Assignment_Start|date:"Y-m-d H:i" %}
                        <span class="badge badge-info">{% trans "Upcoming" %}</span>
                        {% elif object.Assignment_Deadline and todays_datewithtime > object.Assignment_Deadline|date:"Y-m-d
                        H:i" %}
                        <span class="badge badge-danger">{% trans "Expired" %}</span>
                        {% else %}
                        <span class="badge badge-success">{% trans "Active" %}</span>
                        {% endif %}-->
                </p>
    
                <p>
                    {% trans "Register Agent" %} : {{ object.Register_Agent }}
                </p>
            </div>
            {% if 'teacher' in request.path %}
            <ul class="text-center">
                <li class="p-2 border-top">
                    <a class="btn btn-info" href="{% url 'teacher_assignment_answers' object.pk %}">
                        {% trans "View Assignment Submissions" %}
                    </a>
                </li>
            </ul>
            {% endif %}
        </div>
        <div class="card">
            <div class="row align-items-center px-4 pt-3">
            <b>Session:</b>
            <select id="select_session" class="form-control-sm d-inline w-50 ml-3">
                {% for x in session_list %}
                {% for session in x %}
                <option value="{{ session.pk }}" {% if session.pk == inning.pk %} selected {% endif %}> {{ session }}
                </option>
                {% endfor %}
                {% endfor %}
                <option value="-1" {% if not inning %} selected {% endif %}> All Sessions
                </option>
            </select>
            </div>
            <div class="mt-3">
                {% if assigned_session %}
                <table class="table table-striped">
                    <tr>
                        <th>Session</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        {% if '/students' not in request.path %}
                        <th>Assignment Status</th>
                        <th>Action</th>
                        {% endif %}
                    </tr>
                    {% for sessions in assigned_session %}
                    <tr>
                        <td>
                            {{ sessions }}
                            {% if '/students' not in request.path and '/teachers' not in request.path %}
                            {% if sessions.is_active %}
                            <span class="badge badge-success">Active</span>
                            {% else %}
                            <span class="badge badge-danger">Inactive</span>
                            {% endif %}
                            {% endif %}
                        </td>
                        {% getSessionMap object 'assignmentinfo' sessions as sessionmap %}
                        <td class="start-date dateconFullMonth">{{ sessionmap.0.Start_Date|date:"d M, Y h:i A" }}</td>
                        <td class="end-date dateconFullMonth">{{ sessionmap.0.End_Date|date:"d M, Y h:i A" }}</td>
                        {% if '/students' not in request.path %}
                        <td>
                            {% now "Y-m-d H:i" as todays_datewithtime %}
                            {% if sessionmap.0.Start_Date and todays_datewithtime < sessionmap.0.Start_Date|date:"Y-m-d H:i" %}
                                <span class="badge badge-info">Upcoming</span>
                                {% elif sessionmap.0.End_Date and todays_datewithtime > sessionmap.0.End_Date|date:"Y-m-d H:i" %}
                                <span class="badge badge-danger">Expired</span>
                                {% else %}
                                <span class="badge badge-success">Active</span>
                                {% endif %}
                        </td>
                        {% endif %}
                        {% if '/students' not in request.path %}
                        <td>
                            <button type="button" class="btn btn-sm btn-primary inningmap-btn" data-toggle="modal"
                                data-target="#inningmap_form_modal" data-sessionid="{{ sessions.id }}"
                                data-objectid="{{ object.id }}">
                                Change
                            </button>
                        </td>
                        {% endif %}
                    </tr>

                    {% endfor %}
                </table>
                {% else %}
                Not Assigned to any Sessions
                {% endif %}
            </div>
        </div>
    </div>
</div>


{% include 'inning/inningmapFormModal.html' %}

{% endblock %}

{% block javascript %}

<script src=" {% static 'vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js' %}"></script>
<script src="{% static 'vendors/moment/min/moment.min.js' %}"></script>
<script src="{% static 'vendors/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js' %}"></script>
<script> $(".se-pre-con-ajax").fadeOut("fast");</script>

<script>
    $(document).ready(function () {

          $(".start-date ").each(function(){
           // console.log($(this).text());
            $(this).text(new Date($(this).text()+ " UTC ").toLocaleString("en-US"))
            //console.log($(this).text());
            //console.log(new Date($(this).text() + " UTC "));
        })

        $(".end-date ").each(function(){
           // console.log($(this).text());
            $(this).text(new Date($(this).text()+ " UTC ").toLocaleString("en-US"))
            //console.log($(this).text());
            //console.log(new Date($(this).text() + " UTC "));
        })

        /* document.getElementById('id_Start_Date').value = new Date(document.getElementById('id_Start_Date').value).toLocaleString("en-US")
        document.getElementById('id_End_Date').value = new Date(document.getElementById('id_End_Date').value).toLocaleString("en-US")
        $('#id_End_Date').datetimepicker();
        $('#id_Start_Date').datetimepicker(); */
    })

    function inningMapDataLoad($element, sessionid, objectid, formaction) {
        if ($element.closest('tr').find('.start-date').text() != "") {
            document.getElementById('id_Start_Date').value = new Date($element.closest('tr').find('.start-date').text()).toLocaleString("en-US")
        }
        if ($element.closest('tr').find('.end-date').text() != "") {
            document.getElementById('id_End_Date').value = new Date($element.closest('tr').find('.end-date').text()).toLocaleString("en-US")
        }
        //$('#id_End_Date').datetimepicker();
       // $('#id_Start_Date').datetimepicker();

        s = $("#id_Start_Date").val()
             e = $("#id_End_Date").val()

        $("#id_Start_Date").daterangepicker({
            startDate: s,

            singleDatePicker: true,
            timePicker: true,
            locale: {
                format: 'M/DD/YYYY hh:mm A'
            }
        });

        $("#id_End_Date").daterangepicker({
            startDate: e,
            singleDatePicker: true,
            timePicker: true,
            locale: {
                format: 'M/DD/YYYY hh:mm A'
            }

        });

        $('#sessionid').val(sessionid)
        $('#objectid').val(objectid)
        $('#inningmapForm').attr('action', formaction)
    }

    $('#inningmapForm').on('submit', function (e) {
        e.preventDefault();
        $.ajax({
            type: 'post',
            data: {
                "csrfmiddlewaretoken": '{{ csrf_token }}',
                "sessionid": $('#sessionid').val(),
                "objectid": $('#objectid').val(),
                "Start_Date": $('#id_Start_Date').val() != '' ? new Date($('#id_Start_Date').val()).toISOString() : '',
                "End_Date": $('#id_End_Date').val() != '' ? new Date($('#id_End_Date').val()).toISOString() : '',
            },
            url: $(this).attr('action'),  // URL to your view that serves new info
            success: function (data) {
                console.log(data)
                location.reload();
            },
            error: function (err) {
                console.log(err.responseJSON)
                $('.form-errors').empty().append(err.responseJSON.message).css('display', 'block')
            }
        });
    })
</script>

<script>
    $("#ajaxassignmentinfoform").submit(function (e) {
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $.ajax({
            url: "{% url 'assignmentinfo_edit_ajax' object.pk %}",  // URL to your view that serves new info
            data: {
                "csrfmiddlewaretoken": '{{ csrf_token }}',
                "Assignment_Topic": $('#id_Assignment_Topic_edit').val(),
                //"Assignment_Start": new Date($('#id_Assignment_Start_edit').val()).toISOString(),
                //"Assignment_Deadline": new Date($('#id_Assignment_Deadline_edit').val()).toISOString(),
                "Use_Flag": $('#id_Use_Flag').is(":checked"),
                "Course_Code": $('#id_Course_Code').val(),
                "Chapter_Code": $('#id_Chapter_Code').val(),
                "Register_Agent": $('#id_Register_Agent').val(),
                "Assignment_ID": '{{ object.id }}'
            },
            // get the form data
            type: $(this).attr('method'), // GET or POST
            success: function (response) {
                console.log('Success')
                location.reload()
            },
            error: function (err) {
                console.log('Error in posting assignment create form')
                $('.form-errors').empty().append(err.responseJSON.Message).css('display', 'block')
            }
        });
    });

    $('#id_Assignment_Deadline_edit').on('dp.change', function (event) {
        const result = document.querySelector('.result');
        var date = new Date();
        var deadline = new Date(event.target.value);
        var remaining = dateDifference(deadline, date);
        if (remaining < 0) {
            result.textContent = `Days Remaining : Invalid`;

        } else {
            result.textContent = `Days Remaining : ${remaining}`;

        }
        ;
    });
</script>

<script>
    $('#editAssignment-btn').on('click', function () {
        $('#editAssignment_modal_body').empty();
        $.ajax({
            type: "GET",
            url: "{% url 'assignmentinfo_edit_ajax_chapter_id' object.Chapter_Code.id object.pk %}",  // URL to your view that serves new info
            success: function (response) {
                let url = '/assignmentinfo/edit/{{ object.pk }}/ajax/';
                $('#editAssignment_modal_body').append(response);
                $('#ajaxassignmentinfoform').attr('action', url);
                $('#editAssignment_modal_body').append(`
                        <input type="hidden" name="Register_Agent" id="id_Register_Agent" value="{{ request.user.id }}"
                               class="select form-control">
                        <input type="hidden" name="Course_Code" id="id_Course_Code" value="{{ object.Course_Code.id }}"
                               class="select form-control">
                        <input type="hidden" name="Chapter_Code" id="id_Chapter_Code"
                               value="{{ object.Chapter_Code.id }}" class="select form-control">
                    `)

                Switchery(document.querySelector('.js-switch'));
            },
            error: function () {
                console.log('Error in generating assignment edit form')
            },
            complete: function () {
                $(".se-pre-con-ajax").fadeOut("fast");
            }
        });
    });
</script>

<script>
    $('#myModal').on('shown.bs.modal', function () {
        $('#myInput').trigger('focus')
    });

    $(document).on('click', '.confirm-delete', function () {
        ans = confirm('Are you sure you want to delete this Question?');
        if (ans == true) {
            $(`#deleteQuestion${this.id}`).submit();
        } else {
            return false;
        }
    });

    $(document).on('click', '.assignment-confirm-delete', function () {
        ans = confirm('Are you sure you want to delete this Assignment?');
        if (ans == true) {
            $(`#deleteAssignment${this.id}`).submit();
        } else {
            return false;
        }
    });

    $('#add-newquestion-btn').on('click', function () {
        if (submitted) {
            return false
        }
        $('#add_question_modal_body').empty();
        $('#edit_question_modal_body').empty();
        $('#add_question_modal_body').append(
            `<input type="hidden" name="Assignment_Code" id="id_Assignment_Code" value="{{ object.pk }}"
                           class="select form-control">`
        )
        $.ajax({
            type: "GET",
            url: "{% url 'questioninfo_create_ajax' %}",  // URL to your view that serves new info
            success: function (response) {
                $('#add_question_modal_body').append(response);
            },
            error: function () {
                submitted = false;
                console.log('Error in generating add question form')
            },
            complete: function () {
                $(".se-pre-con-ajax").fadeOut("fast");
            }
        });
    });

    $('.editquestion-btn').on('click', function () {
        if (submitted) {
            return false
        }
        $('#edit_question_modal_body').empty();
        $('#edit_question_modal_body').append(
            `<input type="hidden" name="Assignment_Code" id="id_Assignment_Code" value="{{ object.pk }}"
                           class="select form-control">`
        )
        $('#edit_question_modal_body').attr('data-questionpk', $(this).attr('data-questionpk'))
        $.ajax({
            type: "GET",
            url: `/questioninfo/edit/${$(this).attr('data-questionpk')}/ajax/`,  // URL to your view that serves new info
            success: function (response) {
                $('#edit_question_modal_body').append(response);
                $('#edit_question_modal_body').find('form')
            },
            error: function () {
                submitted = false;
                console.log('Error in generating add question form')
            },
            complete: function () {
                $(".se-pre-con-ajax").fadeOut("fast");
            }
        });
    });


    var submitted = false;
    $(".qacontainer").on('click', '.submitAnswer', function (e) {
        e.preventDefault(); // avoid to execute the actual submit of the form.
        if (submitted) {
            return false
        }
        submitted = true;
        var answerdata = new FormData();
        if ($(`#id_Assignment_File${$(this).attr('data-id')}`).val()) {
            var answer_file = $(`#id_Assignment_File${$(this).attr('data-id')}`)[0].files[0];
        } else {
            var answer_file = 0;
        }

        if ($(`#id_Assignment_Answer${$(this).attr('data-id')}`).val()) {
            var answer_text = $(`#id_Assignment_Answer${$(this).attr('data-id')}`).val();
        } else {
            var answer_text = '';
        }

        if (answer_file == 0 && answer_text == '') {
            console.log('empty');
        } else {
            answerdata.append("Assignment_File", answer_file);
            answerdata.append("csrfmiddlewaretoken", '{{csrf_token}}');
            answerdata.append("Assignment_Answer", answer_text);
            answerdata.append("Question_Code", $(`#id_Question_Code${$(this).attr('data-id')}`).val());
            answerdata.append("Student_Code", $(`#id_Student_Code${$(this).attr('data-id')}`).val());

            $.ajax({
                url: $(this).attr('data-url'),  // URL to your view that serves new info
                data: answerdata,
                // get the form data
                type: 'post', // GET or POST
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log('Success')
                    location.reload()
                },
                error: function (e) {
                    submitted = false;
                    alert(e.responseJSON.msg)
                    console.log('Error in submitting file. ' + e.responseJSON.msg)
                }
            });
        }
    });
</script>

<script>
    $(".answerButton").click(function () {
        $(`#answerContent${this.id}`).toggle();
    });
    $(".moreButton").click(function () {
        $(`#questionContent${this.id}`).toggle();
    });
</script>

<script>
    $(document).ready(function () {
        $('.deleteanswer').on('click', function () {
            var answerpk = this.value
            var result = confirm("Are you sure you want to delete this answer?");
            if (!result) {
                return false
            }
            $.ajax({
                method: 'POST',
                url: "{% url 'assignanswerinfo_delete' %}",  // URL to your view that serves new info
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    'answerpk': answerpk,
                },
                success: function (response) {
                    location.reload()
                },
                error: function (err) {
                    console.log(err.responseText)
                    location.reload()
                },
            });
        });

        $('.editanswer').click(function () {
            $(this).parent().children().css('display', 'none')
            $(this).parent().append(`
                <div class="editdiv">
                <form>
                    <textarea class="form-control rounded-0" rows="5" cols="100"
                              name="Assignment_Answer"
                              placeholder="Enter your Answer"
                              id="id_Assignment_Answer${$(this).attr('data-Question_Code')}" required>${$(this).parent().find('p').text()}</textarea>
                    <input type="hidden" value="${$(this).attr('data-Student_Code')}" name="Student_Code"
                    id=id_Student_Code${$(this).attr('data-Question_Code')}>
                    <input type="hidden" value="${$(this).attr('data-Question_Code')}" name="Question_Code"
                    id=id_Question_Code${$(this).attr('data-Question_Code')}>
                    <div class="form-group text-center">

                             <button class="btn btn-sm btn-primary cancelBtn" type="button" id="cancelButton{{ questions.pk }}">
                                Cancel
                            </button>
                            <button class="btn btn-sm btn-primary resetBtn" type="reset">Reset</button>

                            <button type="button" class="btn btn-sm btn-success submitAnswer"
                                    id="answer${$(this).attr('data-Question_Code')}"
                                    data-id="${$(this).attr('data-Question_Code')}"
                                    data-url="{% url 'assignanswerinfo_create_ajax' %}?editanswer=${this.value}">Submit
                            </button>
                    </div>
                    </form>
                </div>
                `)
        })

        $('.qacontainer').on('click', '.cancelBtn', function () {
            $(this).closest('.editdiv').parent().children().css('display', 'block')
            $(this).closest('.editdiv').remove()
        })
        //$('.qacontainer').on('click', '.resetBtn', function () {
        //  $(this).closest('.editdiv').find('textarea').val('')
        //})
    })
</script>


<script>
    $('table').on('click', '.showanswer', function () {
        $('#StudentScore').empty();
        $('#answercontent').empty();
        $(this).addClass('clickedShowAnswer');
        let answer_id = this.value;
        let question_score = this.dataset.question_score;
        let short_answer = $(`#answer_${answer_id}`).html();
        let file_answer = this.dataset.answer_file;

        if (short_answer) {
            $('#answercontent').html(`${short_answer}`);
        }
        if (file_answer) {
            $('#answercontent').append(`
                    <a href="/media/${file_answer}" target="_blank">   <button  class="btn btn-sm btn-info " style="text-align: center;color:black">
                        <b>View File</b>
                    </button>
                    </a>
                `)
        }
        $('#StudentScore').html(`
                <form id="StudentScoreForm">
                <div>
                    <p><b>FeedBack</b></p>
                    <p>
                        <textarea name="assignment_feedback" class="form form-control" rows="5" id="assignment_feedback" style="resize: none; width: 100%"></textarea>
                    </p>
                </div>
                <div>
                <b>Score</b>
                <input type="number" min="0" class="form form-control" id="studentScoresubmit" style="width:50%;"
                value="${$(this).closest('tr').find('.edit_assignment_score').attr('data-assignment_score')}"
                max="${question_score}" >Full Score: <b>${question_score} </b><br><br>
                    <button type="submit" class="btn btn-sm btn-info " tyle="text-align: center;color:black">Submit Score</button>
                </div>
                </form>
                    <input type="hidden" id="answerpk" value="${answer_id}">

            `);
        $('#studentScoresubmit').val($(this).closest('tr').find('.edit_assignment_score').attr('data-assignment_score'));
        $('#assignment_feedback').val($(this).attr('data-assignment_feedback'));
    });

    $('#exampleModal1').on('hidden.bs.modal', function () {
        $('.clickedShowAnswer').removeClass('clickedShowAnswer')
    });

       // $('#create_session_modal').on('hidden.bs.modal', function () {
         //   $('.clickedShowAnswer').removeClass('clickedShowAnswer')
        // })

    $('td').on('click', '.edit_assignment_score', function (e) {
        let assg_score = $(this).attr('data-assignment_score') == "None" ? '' : $(this).attr('data-assignment_score')
        let max = $(this).closest('td').attr('data-assignment_max_score')
        $(this).closest('td').empty().append(`
            <form method="post">
                <input type="number" value="${assg_score}" data-original="${assg_score}" min="0" max="${max}">
                <button type="submit" style="color:green" class="assignment_score_submitBtn"><i class="fa fa-check" aria-hidden="true"></i></button>
                <button type="button" style="color:red" class="assignment_score_closeBtn"><i class="fa fa-times" aria-hidden="true"></i></button>
            </form>
            `)
    });

    $('td').on('click', '.assignment_score_closeBtn', function (e) {
        let assg_score = $(this).parent().find('input').attr('data-original') == "" ? 'None' : $(this).parent().find('input').attr('data-original')
        let assg_display = assg_score == 'None' ? 'Not Graded' : assg_score
        $(this).closest('td').empty().append(`
            ${assg_display}
            <span class="edit_assignment_score" data-assignment_score="${assg_score}">
                <i class="fa fa-edit"></i>
            </span>
           `)
    });

    $('td').on('click', '.assignment_score_submitBtn', function (e) {
        e.preventDefault()
        answer_pk = $(this).closest('td').attr('data-answer_id')
        stu_score = $(this).closest('td').find('input').val()
        if (parseInt(stu_score) > parseInt($(this).closest('td').attr('data-assignment_max_score')) || parseInt(stu_score) < 0) {
            alert('Score must be in between 0 and ' + parseInt($(this).closest('td').attr('data-assignment_max_score')))
            return false
        }
        submitscoreajax(fromtd = true, answer_pk = answer_pk, stu_score = stu_score)
    })

    $('#StudentScore').on('submit', 'form', function (e) {
        e.preventDefault()
        submitscoreajax()
    })

    function submitscoreajax(fromtd = false, answer_pk = null, stu_score = null) {
        if (!fromtd) {
            var answer_pk = $('#answerpk').val();
            var stu_score = $('#studentScoresubmit').val() ? $('#studentScoresubmit').val() : 0;
            if (parseInt(stu_score) < 0) {
                alert('Score cannot be less than 0');
                return false
            }
            var feedback = $('#assignment_feedback').val();
        }
        $.ajax({
            url: '/teachers/submitStudentscore/' + answer_pk + '/' + stu_score + '/',
            method: 'post',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'assignment_feedback': feedback,
                'stu_score': stu_score,
            },
            success: function (data) {
                $('#Score_' + answer_pk).html(stu_score).css("text-shadow", "2px 2px 5px red;");
                $('#Score_' + answer_pk).append(`
                     <span class="edit_assignment_score" data-assignment_score="${stu_score}">
                            <i class="fa fa-edit"></i>
                        </span>
                     `)
                $('#Score_' + answer_pk).css("animation", "glowing 5000ms 1");

                if (!fromtd) {
                    $('#exampleModal1').modal('toggle');
                    $('.clickedShowAnswer').attr('data-assignment_feedback', feedback);
                    var currentRow = $('.clickedShowAnswer').closest("tr");
                    var data = $('.table-data').DataTable().row(currentRow).data();
                    // Here data gives all the values of td in array. Feedback array index is 9 in datatable.
                    data[9] = " " + feedback;
                }
            },
            error: function (e) {
                console.log(e.responseText)
                return false
            }
        })
    }

    $('#select_chapter').change(function () {
        $('#select_assignment option').hide();
        $('#select_assignment option[data-chapter="' + $(this).val() + '"]').show();
        // add this code to select 1'st of streets automaticaly
        // when city changed
        if ($('#select_assignment option[data-chapter="' + $(this).val() + '"]').length) {
            $('#select_assignment option[data-chapter="' + $(this).val() + '"]').first().prop('selected', true);
        }
        // in case if there's no corresponding street:
        // reset select element
        else {
            $('#select_assignment').val('');
        }
    });

    $('#change_assignment_button').on('click', function () {
        window.location.href = "/teachers/courseinfo/{{ object.Course_Code.pk }}/chapterinfo/{{ object.Chapter_Code.pk }}/assignmentinfo/" + $('#select_assignment').val();
    })

</script>

<script type="text/javascript">

    $(document).ready(function () {

        var table_main = $('.table-data').DataTable({
            responsive: true,
            stateSave: false,
            dom: 'lBfrtip',

            buttons: [
                {
                    extend: 'csv',
                    text: '<span class="exportcsv"><i class="fa fa-paper-plane-o"></i> Export to CSV </span>',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6, 7]
                    }
                },
                // {
                //     extend: 'print',
                //     text: '<span class="print"><i class="fa fa-print"></i> Print </span>',
                //     fieldSeparator: '\t'
                // }
            ],
            "columnDefs": [
                {
                    "targets": [0,6],
                    "visible": false,
                    "searchable": true,
                },
                {
                    "orderable": false,
                    "targets": [8],
                }
            ]
        });

        $("#select_session").on("change", function () {
            {% if 'iframe' in request.GET %}
            {% if '/teachers' in request.path %}
            if (this.value != -1) {
                window.location.href = `/teachers/courseinfo/{{ object.Course_Code.pk }}/chapterinfo/{{ object.Chapter_Code.pk }}/assignmentinfo/{{ object.pk }}//inning/${this.value}/?iframe=1`
            } else {
                window.location.href = `/teachers/courseinfo/{{ object.Course_Code.pk }}/chapterinfo/{{ object.Chapter_Code.pk }}/assignmentinfo/{{ object.pk }}/?iframe=1`
            }
            {% endif %}
            {% else %}
            {% if '/teachers' in request.path %}
            if (this.value != -1) {
                window.location.href = `/teachers/courseinfo/{{ object.Course_Code.pk }}/chapterinfo/{{ object.Chapter_Code.pk }}/assignmentinfo/{{ object.pk }}/inning/${this.value}/`
            } else {
                window.location.href = `/teachers/courseinfo/{{ object.Course_Code.pk }}/chapterinfo/{{ object.Chapter_Code.pk }}/assignmentinfo/{{ object.pk }}/`
            }
            {% endif %}
            {% endif %}
        });
    });

    $('.downloadallfiles').on('click', function () {
        let q_id = $(this).attr('data-question_id');
        let answer_id_list = []
        {% for answer in Answers %}
        if (q_id == '{{ answer.Question_Code.id }}') {
            {% if answer.Assignment_File %}
            answer_id_list.push('{{ answer.id }}')
            {% endif %}
        }
        {% endfor %}
        if (answer_id_list.length > 0) {
            $.ajax({
                url: "{% url 'downloadAssignmentAnswers' %}",
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'list_of_ids': answer_id_list,
                    'question_id': q_id,
                    'assignment_id': '{{ Assignment.pk }}',
                },
                success: function (response) {
                    window.open(response.link, '_blank');
                   // {% comment %}
                    /*setTimeout(function () {
                        $.ajax({
                            url: "{% url 'deletedownloadAssignmentAnswers' %}",
                            type: 'GET',
                            data: {
                                'question_id': q_id,
                                'assignment_id': '{{ Assignment.pk }}',
                            },
                            success: function (data) {
                                console.log(data)
                            }
                        })
                    }, 3000)*/
                   // {% endcomment %}
                },
                error: function (e) {
                    console.log(e);
                }
            });
        } else {
            alert('No Answers to download')
        }
    })

</script>


<script>
    $('.show-answer-btn').on('click', function () {
        question_id = $(this).attr('data-questionid');
        if ($('.questions_table_div[data-question_id=' + question_id + ']').hasClass('hidden')) {
            $(this).text('Hide Answer')
        } else {
            $(this).text('Show Answer')
        }

        $('.assignment_answers_div').find('.questions_table_div[data-question_id=' + question_id + ']').toggleClass('hidden');
        $('.assignment_answers_div').find('.questions_table_div[data-question_id=' + question_id + ']').toggleClass('shown');

        if ($('.questions_table_div').hasClass('shown')) {
            $('.assignment_answers_div').removeClass('hidden');
        } else {
            $('.assignment_answers_div').addClass('hidden');
        }
    })

    $('.inningmap-btn').on('click', function () {
        inningMapDataLoad($(this), $(this).attr('data-sessionid'), $(this).attr('data-objectid'), '{% url 'assignmentinninginfomap' %}')
    })
</script>
{% endblock %}


