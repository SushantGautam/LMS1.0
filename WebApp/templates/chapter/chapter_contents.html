{% load staticfiles %}

<html>
<head>
    <meta name="viewport" content="width=device-width, intial-scale=1.0">

    <!-- Bootstrap -->
    <link href="{% static 'vendorsx/bootstrap/dist/css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="{% static 'vendorsx/font-awesome/css/font-awesome.min.css' %}" rel="stylesheet">

    <link href="{% static 'lightbox/css/lightbox.css' %}" rel="stylesheet"/>

    <link href="{% static 'chapterPageBuilder/css/style.css' %}" rel="stylesheet">
    <link href="{% static 'chapterPageBuilder/css/style-content.css' %}" rel="stylesheet">


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.css">
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.js"></script>

    <style>
        .button-position {
            height: 20px;
            width: 20px;
            margin: 5px;
            padding: 5px !important;
            background-color: white;
            z-index: 999;
            top: 50%;
            position: absolute;

            display: none;
            transition: all 1s ease;
            -webkit-transition: all 0.3s ease;
        }

        .button-position:hover {
            cursor: pointer;
        }

        .overall-contents:hover .button-position {
            display: block;
        }

        .overall-contents:hover .content-title {
            display: block;
        }

        .overall-contents {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            margin: auto;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        #container {
            background-color: white;
            color: black;

        }

        body {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .content-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
            display: none;
            transition: all 0.3s ease;
            -webkit-transition: all 0.3s ease;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .content-title1 {

            transition: all 0.3s ease;
            -webkit-transition: all 0.3s ease;
            position: relative;
            top: 0;
            left: 0;;
        }

        .overall-contents:hover .content-title1 {
            display: block;
        }

        .content-footer1 {
            color: white;
            width: 100px;
            /* padding-top: 10px; */
            font-size: 1.2rem;
            font-weight: 200;
            /* padding-right: 20px; */
            position: absolute;
            bottom: 10%;
            left: 45%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            z-index: 99;
            /* padding: 10px; */
            height: 30px;
            line-height: 30px;
            display: none;
            transition: all 0.3s ease;
            -webkit-transition: all 0.3s ease;


        }

        .overall-contents:hover .content-footer1 {
            display: block;
        }

        .page-slide {
            position: absolute;

        }

        .progress {
            margin-top: 5px;
            height: 5px;
        }

    </style>

</head>

<body>
<div class="container-fluid">
    <!-- For Title -->


    <div class="row overall-contents">
        <div id="prev-btn" class="button-position" style="left:0;">
            <i class="fa fa-backward"></i>
        </div>
        <div id="next-btn" class="button-position" style="right:0;">
            <i class="fa fa-forward"></i>
        </div>

        <div id="container" style="position: relative;">

            <div class="content-title1  text-center">
                    <span id="chaptertitle" class="content-title">
                        <!-- Chapter title goes here -->
                        {{ chapter }}
                    </span>
            </div>

            <div id="page-contents"></div>

        </div>
        <div class="progress">
            <div class="progress-bar progress-bar-striped bg-success" style="width: 0%;" role="progressbar"
                 aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <div class="content-footer1 text-center">
            Page <span id="currentpage"></span> of <span id="totalpages"></span>
        </div>

    </div>
    {% if "teachers" in request.path %}
        {% include "chapter/Content_Viewer_WebSocket_teacher.html" %}
    {% elif "students" in request.path %}
        {% include "chapter/Content_Viewer_WebSocket_students.html" %}
    {% endif %}

    <div style="position: absolute; bottom: 0; min-height: 20px; padding: 20px;" id="fadeOutUp">
    </div>

    <div id="closechatopen">
        <a class="float">
            <i class="fa fa-file-text my-float"></i>
        </a>
    </div>
    <!-- For Footer -->

    <div class="row page-slide">

    </div>


    <div class="chatonly" style="display: none">
        <div class="container bootstrap snippet">
            <div class="row">


                <div class="col-md-8 bg-white ">
                    <div class="row upbarchat">

                        <div class="col-sm-4">
                            <span> Quick Quiz  <i class="fa fa-pencil"></i></span>
                        </div>
                        <div class="col-sm-4">
                            <span> Quick Survey  <i class="fa fa-pencil"></i></span>
                        </div>
                        <div class="col-sm-4">
                            <span> Force Screen Sync <input id="forceScreen" type="checkbox"></span>
                        </div>


                    </div>
                    <div class="chat-message" id="chat-box-content">
                        <ul class="chat">
                            <li class="left clearfix">
                    	<span class="chat-img pull-left">
                    		<img src="https://bootdey.com/img/Content/user_3.jpg" alt="User Avatar">
                    	</span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <strong class="primary-font">John Doe</strong>
                                        <small class="pull-right text-muted"><i class="fa fa-clock-o"></i> 12 mins
                                            ago</small>
                                    </div>
                                    <p>
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                    </p>
                                </div>
                            </li>
                            <li class="right clearfix">
                    	<span class="chat-img pull-right">
                    		<img src="https://bootdey.com/img/Content/user_1.jpg" alt="User Avatar">
                    	</span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <strong class="primary-font">Sarah</strong>
                                        <small class="pull-right text-muted"><i class="fa fa-clock-o"></i> 13 mins
                                            ago</small>
                                    </div>
                                    <p>
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur bibendum
                                        ornare dolor, quis ullamcorper ligula sodales at.
                                    </p>
                                </div>
                            </li>

                        </ul>
                    </div>
                    <div class="chat-box bg-white">
                        <div class="input-group">
                            <input id="chatmessageinput" class="form-control border no-shadow no-rounded"
                                   placeholder="Type your message here" required>
                            <span class="input-group-btn">
            			<button class="btn btn-success no-rounded" type="button"
                                onclick="sendMessageWritten()">Send</button>
            		</span>
                        </div><!-- /input-group -->
                    </div>
                </div>
                <div class="col-md-4 bg-white ">
                    <div class="row upbarchat">

                        <div class="col-sm-4">
                            <span> Notification <input id="forceScreen" type="checkbox"></span>
                        </div>
                        <div class="col-sm-4">
                            <span>Sound <input id="forceScreen" type="checkbox"></span>
                        </div>
                        <div class="col-sm-4 text-danger danger">
                            <span id="closechatbox">Close <i class="fa fa-close"></i></span>
                        </div>

                    </div>

                    <!-- =============================================================== -->
                    <!-- member list -->
                    <div style="
    height: 55vh;
">
                        <ul class="friend-list">
                            <li class="active bounceInDown">
                                <a href="#" class="clearfix">
                                    <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                                    <div class="friend-name">
                                        <strong>John Doe</strong>
                                    </div>
                                    <div class="last-message text-muted">Hello, Are you there?</div>
                                    <small class="time text-muted">Just now</small>
                                    <small class="chat-alert label label-danger">1</small>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="clearfix">
                                    <img src="https://bootdey.com/img/Content/user_2.jpg" alt="" class="img-circle">
                                    <div class="friend-name">
                                        <strong>Jane Doe</strong>
                                    </div>
                                    <div class="last-message text-muted">Lorem ipsum dolor sit amet.</div>
                                    <small class="time text-muted">5 mins ago</small>
                                    <small class="chat-alert text-muted"><i class="fa fa-check"></i></small>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="clearfix">
                                    <img src="https://bootdey.com/img/Content/user_3.jpg" alt="" class="img-circle">
                                    <div class="friend-name">
                                        <strong>Kate</strong>
                                    </div>
                                    <div class="last-message text-muted">Lorem ipsum dolor sit amet.</div>
                                    <small class="time text-muted">Yesterday</small>
                                    <small class="chat-alert text-muted"><i class="fa fa-reply"></i></small>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="clearfix">
                                    <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                                    <div class="friend-name">
                                        <strong>Kate</strong>
                                    </div>
                                    <div class="last-message text-muted">Lorem ipsum dolor sit amet.</div>
                                    <small class="time text-muted">Yesterday</small>
                                    <small class="chat-alert text-muted"><i class="fa fa-reply"></i></small>
                                </a>
                            </li>

                        </ul>
                    </div>

                </div>

                <!--=========================================================-->
                <!-- selected chat -->

            </div>
        </div>
    </div>


</div>
</body>
</html>

<!-- jQuery -->
<script src="{% static 'vendorsx/jquery/dist/jquery.min.js' %}"></script>
<script src="{% static 'lightbox/js/lightbox.js' %}"></script>

<script type="text/javascript">
    var roomName = "ChapterChat{{chapter.id}}";
    var chatSocket = new WebSocket("ws://" + location.host + "/ws/" + roomName + '/');
    chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
        setTimeout(function () {
            chatSocket = new WebSocket("ws://" + location.host + "/ws/" + roomName + '/');
        }, 5000);
    };


    lightbox.option({
        'resizeDuration': 200,
        'wrapAround': true
    });

    document.addEventListener('visibilitychange', function () {
        pauseAllVideos(); // change tab text for demo
    })
    $(document).keydown(function (e) {
        if ($('#lightbox').css('display') == 'none') {
            if (e.keyCode == '39') {
                $('#next-btn').click();
                return false
            }
            if (e.keyCode == '37') {
                $('#prev-btn').click();
                return false
            }
            //UP
            if (e.keyCode == '38') {
                $('body').animate({scrollTop: 0}, 100);
                return false;
            }
            //DOWN
            if (e.keyCode == '40') {
                $('body').animate({scrollTop: $(document).height()}, 100);
                return false;
            }

            if (e.keyCode == '70') {
                var hasFocus = $('#chatmessageinput').is(':focus');
                if (hasFocus) {
                    return false
                }

                toggleFullScreen();
                return false;
            }

        }
    });


    $('#closechatbox').off().click(function () {
        $('.chatonly').hide();
        $('#closechatopen').show();
    });

        $('#closechatopen').off().click(function () {
        $('.chatonly').show();
        $('#closechatopen').hide();
    });


    $('#next-btn').off().click(function () {
        pauseAllVideos();
        $("#page-contents > .coursepages ").each(function () {
            if ($(this).css("display") == "block") {
                res = this.id.match(/[0-9]+/);
            }
        });
        if (res < $("#page-contents > div ").length) {
            getProgressWidth();
            $('#page' + res).css("display", "none");
            res++;
            $('#page' + res).css("display", "block")
        }
        $('#currentpage').text(res);
    });

    $('#prev-btn').off().click(function () {
        pauseAllVideos();
        $("#page-contents > div ").each(function () {
            if ($(this).css("display") == "block") {
                res = this.id.match(/[0-9]+/);
            }
        });
        if ((res - 1) > 0) {
            let w = (parseFloat($('.progress-bar')[0].style.width)) - (100 / parseFloat('{{data.numberofpages}}'));
            $('.progress-bar').css('width', w + '%')
            $('#page' + res).css("display", "none");
            res--;
            $('#page' + res).css("display", "block")
        }
        $('#currentpage').text(res);
    });

    var data = {{ data | safe}};
    // console.log(data)

    container_height = $('body').height() - $('.content-title1').height() - $('.content-footer1').height()
    $('#container').css('height', container_height * 100 / $('body').height() + "%")

    function pauseAllVideos() {
        $('iframe').each(function () {
            $(this).attr('src', $(this).attr('src'));
            // console.log($(this)[0])
            // $(this)[0].contentWindow.postMessage('{"event":"command","func":"' + 'pauseVideo' + '","args":""}', '*');
        });
        $('video').each(function () {
            this.pause();
        });
    }

    function loaddata(data) {
        $('#totalpages').text(data.numberofpages);
        $('#currentpage').text(1);
        $.each(data.pages, function (key, value) {
            $.each(value, function (count) {
                // Create modal
                $('#page-contents').append(`
                <div id="page${key}" class = 'coursepages' role="dialog" style="display: none;">

                </div>`)
                // -------------------------------

                $.each(value[count], function (div, div_value) {
                    var now = Math.floor(Math.random() * 900000) + 100000;
                    if (div == 'textdiv') {
                        $.each(div_value, function (css, css_value) {
                            css_string = JSON.stringify(css_value)
                            $('#page' + key).append(`
                                <div style = "overflow:hidden; font-size:1.5rem; position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height:${css_value.height}; width:${css_value.width}; padding:10px">
                                    ${css_value.content}
                                </div>
                            `);
                            // $('#page' + key).append(css_value.content);

                        });
                    }
                    if (div == 'pic') {
                        $.each(div_value, function (css, css_value) {
                            src = css_value['background-image']
                            // imgsrc = src.match(/(["'])(?:(?=(\\?))\2.)*?\1/);
                            $('#page' + key).append(`
                                <div style = 'position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height:${parseFloat(css_value.height)}%; width:${parseFloat(css_value.width)}%'>
                                <a href = ${src} data-lightbox="roadtrip"> <img src = ${src} style = "height:100%; width:100%; object-fit:cover"></img>  </a>      
                                </div>
                            `);
                            // $('#page' + key).append(css_value.div);
                        });
                    }

                    if (div == 'btn-div') {
                        $.each(div_value, function (css, css_value) {
                            link = "";
                            if (css_value.hasOwnProperty('link')) {
                                link = "href = " + css_value.link;
                            }
                            $('#page' + key).append(`
                            <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                <a ${link} target="_blank"><button>${css_value.btn_name}</button</a>
                            </div>
                        `)
                        });
                    }

                    if (div == 'pdf') {
                        $.each(div_value, function (css, css_value) {
                            $('#page' + key).append(`
                            <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                <object data="${css_value.link}#toolbar=0" type="application/pdf" width="100%" height="100%">
                                    alt : PDF File
                                </object>
                                <div class = "iframefullscreenbtn">CLick to fullscreen</div>
                            </div>
                        `)
                        });
                    }

                    if (div == 'video') {
                        $.each(div_value, function (css, css_value) {
                            if (css_value.hasOwnProperty('online_link')) {
                                var embed = `<div id = '${now}' style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                    <iframe width="100%" height="94%" src="${css_value.online_link}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

                                    </div>`
                                //     <script>
                                //     var options = {
                                //         url: "${css_value.link}",
                                //         width: "${css_value.width}",
                                //         height: "${css_value.height}"
                                //     };

                                //     var videoPlayer = new Vimeo.Player('${now}', options);
                                // `
                            } else {
                                var embed = `
                                <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                    <video width="100%" height="100%" controlsList="nodownload" controls>
                                        <source src="${css_value.local_link}" type="video/mp4">
                                        <source src="${css_value.local_link}" type="video/ogg">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                `
                            }
                            $('#page' + key).append(embed)
                        });
                    }

                    if (div == '_3d') {
                        $.each(div_value, function (css, css_value) {
                            $('#page' + key).append(`
                            <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                <iframe src="${css_value.link}" width="100%" height="100%">
                                </iframe>
                                <div class = "iframefullscreenbtn">CLick to fullscreen</div>
                            </div>
                        `)
                        });
                    }
                });
            });
        });
    }

    // for small screen sizes
    function loadsmalldata(data) {
        $('#totalpages').text(data.numberofpages);
        $('#currentpage').text(1);
        $.each(data.pages, function (key, value) {
            $.each(value, function (count) {
                // Create modal
                $('#page-contents').append(`
                <div id="page${key}" class = 'coursepages' role="dialog" style="display: none;">

                </div>`)
                // -------------------------------

                $.each(value[count], function (div, div_value) {
                    var now = Math.floor(Math.random() * 900000) + 100000;
                    if (div == 'textdiv') {
                        $.each(div_value, function (css, css_value) {
                            css_string = JSON.stringify(css_value)
                            $('#page' + key).append(`
                                <div style = "font-size:1.5rem;">
                                    ${css_value.content}
                                </div>
                            `);
                            // $('#page' + key).append(css_value.content);

                        });
                    }
                    if (div == 'pic') {
                        $.each(div_value, function (css, css_value) {
                            src = css_value['background-image']
                            // imgsrc = src.match(/(["'])(?:(?=(\\?))\2.)*?\1/);
                            $('#page' + key).append(`
                                <div>
                                <a href = ${src} data-lightbox="roadtrip"> <img src = ${src} style = "height:100%; width:100%; object-fit:cover"></img>  </a>      
                                </div>
                            `);
                            // $('#page' + key).append(css_value.div);
                        });
                    }

                    if (div == 'btn-div') {
                        $.each(div_value, function (css, css_value) {
                            link = "";
                            if (css_value.hasOwnProperty('link')) {
                                link = "href = " + css_value.link;
                            }
                            $('#page' + key).append(`
                            <div>
                                <a ${link} target="_blank"><button>${css_value.btn_name}</button</a>
                            </div>
                        `)
                        });
                    }

                    if (div == 'pdf') {
                        $.each(div_value, function (css, css_value) {
                            $('#page' + key).append(`
                            <div>
                                <object data="${css_value.link}" type="application/pdf" width="100%" height="100%">
                                    alt : PDF File
                                </object>
                            </div>
                        `)
                        });
                    }

                    if (div == 'video') {
                        $.each(div_value, function (css, css_value) {
                            if (css_value.hasOwnProperty('online_link')) {
                                var embed = `<div id = '${now}'>
                                    <iframe width="100%" height="94%" src="${css_value.online_link}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

                                    </div>`
                                //     <script>
                                //     var options = {
                                //         url: "${css_value.link}",
                                //         width: "${css_value.width}",
                                //         height: "${css_value.height}"
                                //     };

                                //     var videoPlayer = new Vimeo.Player('${now}', options);
                                // `
                            } else {
                                var embed = `
                                <div>
                                    <video width="100%" height="100%" controlsList="nodownload" controls>
                                        <source src="${css_value.local_link}" type="video/mp4">
                                        <source src="${css_value.local_link}" type="video/ogg">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                `
                            }
                            $('#page' + key).append(embed)
                        });
                    }

                    if (div == '_3d') {
                        $.each(div_value, function (css, css_value) {
                            $('#page' + key).append(`
                            <div>
                                <iframe src="${css_value.link}" width="100%" height="100%">
                                </iframe>
                            </div>
                        `)
                        });
                    }
                });
            });
        });
    }

    function toggleFullScreen() {
        if ((document.fullScreenElement && document.fullScreenElement !== null) ||
            (!document.mozFullScreen && !document.webkitIsFullScreen)) {
            if (document.documentElement.requestFullScreen) {
                document.documentElement.requestFullScreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullScreen) {
                document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
            }
        } else {
            if (document.cancelFullScreen) {
                document.cancelFullScreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitCancelFullScreen) {
                document.webkitCancelFullScreen();
            }
        }
    }


    $(document).ready(function () {
        function Layout(x) {
            if (x.matches) {
                $('#page-contents').empty();
                loadsmalldata(data)
            } else {
                $('#page-contents').empty();
                loaddata(data)
            }

            $('#page1').css('display', 'block');
        }

        var x = window.matchMedia("(max-width: 767px)")
        Layout(x)
        x.addListener(Layout) // Attach listener function on state changes
        getProgressWidth();
    });


    function sendMessageWritten() {
        if ($('#chatmessageinput').val()) {
            chatSocket.send(
                JSON.stringify({
                    chat_message: $('#chatmessageinput').val(),
                    sender_id: "{{  user.id }}",
                    sender_name: "{{  user.First_Name }} {{  user.Last_Name }}",
                    sender_icon: "{{  user.Member_Avatar }}",
                })
            );
        }
    };

    $('#chatmessageinput').keypress(function (event) {
        if (event.keyCode == 13 && !event.shiftKey) {
            sendMessageWritten();
        }
    });


    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        if ("page" in data) {


            {% if "students" in request.path %}
                HandlePageInStudents(data);
            {% endif %}



        } else if ("chat_message" in data) {
            $("#chatmessageinput").val("");
            $("#chat-box-content").append("<h4>" + data.sender_name + data.sender_id + ": " + data.chat_message + "</h4>");
            $("#fadeOutUp").html('<h3 id="messageChatUp" style="position: relative">' + data.sender_name + data.sender_id + ": " + data.chat_message + '</h3>');
            $("#messageChatUp").animate({
                top: -300,
                opacity: 0
            }, 3000, "linear", function () {
            })
        }
    };

    function getProgressWidth() {
        let w = (parseFloat($('.progress-bar')[0].style.width)) + (100 / parseFloat('{{data.numberofpages}}'));
        $('.progress-bar').css('width', w + '%')
    }

    $(document).ready(function () {
        $('.iframefullscreenbtn').on('click', function () {
            // check if fullscreen mode is available
            if (document.fullscreenEnabled ||
                document.webkitFullscreenEnabled ||
                document.mozFullScreenEnabled ||
                document.msFullscreenEnabled) {

                // which element will be fullscreen
                var iframe = $(this).parent().find('object')[0] || $(this).parent().find('iframe')[0];
                // Do fullscreen
                if (iframe.requestFullscreen) {
                    iframe.requestFullscreen();
                } else if (iframe.webkitRequestFullscreen) {
                    iframe.webkitRequestFullscreen();
                } else if (iframe.mozRequestFullScreen) {
                    iframe.mozRequestFullScreen();
                } else if (iframe.msRequestFullscreen) {
                    iframe.msRequestFullscreen();
                }
            } else {
                document.querySelector('.error').innerHTML = 'Your browser is not supported';
            }
        });
    })
</script>



