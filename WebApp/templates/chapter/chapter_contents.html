{% load staticfiles %}
{% load define_action %}
{% load i18n %}


{% if  "teachers" in request.path %}
    {% define 1 as ifteacher %}
{% else %}
    {% define 0 as ifteacher %}
{% endif %}

{% block head %}
    <head>
        <link rel="icon"
              type="image/png"
              href="/static/images/logo.png"/>
        <meta name="viewport" content="width=device-width, intial-scale=1.0">

        <!-- Bootstrap -->
        <link href="{% static 'vendorsx/bootstrap/dist/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'vendorsx/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css' %}" rel="stylesheet">

        <!-- Font Awesome -->
        <link href="{% static 'vendorsx/font-awesome/css/font-awesome.min.css' %}" rel="stylesheet">
        <link href="{% static 'build/css/theme.min.css' %}" rel="stylesheet">
        <link href="{% static 'lightbox/css/lightbox.css' %}" rel="stylesheet"/>

        <link href="{% static 'chapterPageBuilder/css/style-content.css' %}" rel="stylesheet">

        {% if not connection_offline %}
            <link rel="stylesheet" href="{% static 'chapterPageBuilder/SummerNote/summernote.css' %}">
        {% endif %}
        <link rel="stylesheet" href="{% static 'chapterPageBuilder/js/owl-carousel/assets/owl.carousel.css' %}">

        <script type="text/javascript" crossorigin="anonymous"
                src="{% static 'vendorsx/jquery/jquery3.4.1.min.js' %}"></script>
        <link rel='manifest' href='/manifest.webmanifest'>


        <!-- Loads <model-viewer> for modern browsers: -->
        <script type="module" crossorigin="anonymous"
                src="{% static '3D_Viewer/model-viewer.js' %}">
        </script>

        <!-- Loads <model-viewer> for old browsers like IE11: -->
        <script nomodule crossorigin="anonymous"
                src="{% static '3D_Viewer/model-viewer-legacy.js' %}">
        </script>


    </head>
{% endblock head %}


<body>
<div class="se-pre-con"></div>

{% block sidenav %}
    <div id="mySidenav" class="sidenav" style="z-index: 9999; position:relative; height: 100vh">
        <div id="closenave" style="right:0px" style="right:0px"><a id="closenav" href="javascript:void(0)" style="
    right: 25px;
    position: absolute;">

            <i class="fa fa-lg fa-angle-double-left " style="font-size: 45px;"></i></a></div>
        <script>
            $('#closenav').on('click mouseover', function () {
                closeNav()
            });
        </script>
        <a href="
    {% if '/teachers' in request.path %}
        {% url 'teacher_chapterinfo_detail' course.pk chapter.pk %}
    {% elif '/students' in request.path %}
        {% url 'student_chapterinfo_detail' course.pk chapter.pk %}
    {% else %}
        {% url 'chapterinfo_detail' course.pk chapter.pk %}
    {% endif %}
    " class="back-btn-content" style="position: absolute; top:19px;left:0px; font-size:20px">
            <div class="closebtn" onclick="Print.postMessage('closeViewer')"><i style="
    background-color: #d6768c;
    border-radius: 50%;
    padding: 0.5px 2px;
" class="fa fa-times-circle"></i></div>
        </a>

        {% if '/teachers' in request.path %}
            <a href="{% url 'teachers_newChapterBuilder' course.pk chapter.pk %}">
                <div class="editbtn" title=""><i style="
    color: #3c8dbc;
    padding: 0.5px 2px;
    text-shadow: 2px 2px #f9f5f5;
" class="fa fa-pencil"></i></div>
            </a>
        {% elif '/teachers' not in request.path and '/students' not in request.path %}
            <a href="{% url 'newChapterBuilder' course.pk chapter.pk %}">
                <div class="editbtn" title=""><i style="
    color: #3c8dbc;
    padding: 0.5px 2px;
    text-shadow: 2px 2px #f9f5f5;
" class="fa fa-pencil"></i></div>
            </a>
        {% endif %}


        <div class="profile clearfix" style="padding: inherit;">

            <div class="profile_pic">
                <img src="{{ request.user.Avatar }}" alt="..." class="img-circle profile_img">
            </div>

            <div class="profile_info">

                <span>{% trans 'Welcome' %},</span>
                <h2>{{ request.user }}</h2>
            </div>

        </div>
        <div class="white-hr"></div>


        <div style="
    overflow-x: auto;min-height: 100%;">
            <h4 style=" color:white ;text-align:center">{% trans 'Chapter List' %}</h4>
            {% for chapterobj in chapterList %}


                {% if "teachers" in request.path %}
                    <a class="focus-page"
                       {% if chapterobj.pk == chapter.pk %}style=" background-color: #647ca8;"{% endif %}
                       href="{% url 'teacher_contentviewer' course.pk chapterobj.pk %}">{{ chapterobj.Chapter_No }}. {{ chapterobj.Chapter_Name }}</a>
                {% elif "students" in request.path %}
                    <a class="focus-page"
                       {% if chapterobj.pk == chapter.pk %}style=" background-color: #647ca8;"{% endif %}
                       href="{% url 'student_contentviewer' course.pk chapterobj.pk %}">{{ chapterobj.Chapter_No }}. {{ chapterobj.Chapter_Name }}</a>

                {% else %}
                    <a class="focus-page" {% if chapterobj.pk == chapter.pk %}style="
    background-color: #647ca8;
"{% endif %}
                       href="{% url 'contentviewer' course.pk chapterobj.pk %}">{{ chapterobj.Chapter_No }}. {{ chapterobj.Chapter_Name }}</a>

                {% endif %}
            {% endfor %}
            <br><br><br>

        </div>
        <div id="sidebar-buttom" class="side-bar-content hidden-small"
             style="position: sticky;
    left: 0px;
    right: 0px;
    bottom: 0px;
    background: #71675b;
    width: 240px;
    border-top: 1px solid white;">

            <ul style="display: inline-block; list-style:none; padding: 0px !important">
                <li style="display: inline-block;">
                    <a id="togglefull" data-toggle="tooltip" data-placement="top" title="" onclick="toggleFullScreen()"
                       data-original-title="FullScreen">
                        <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
                    </a>

                </li>
                <li style="display: inline-block;">
                    <a class="profileBtn" data-toggle="tooltip" data-placement="top" title="" href="
                    {% if '/teachers' in request.path %}
                        {% url 'teacher_user_profile' %}
                    {% elif '/students' in request.path %}
                        {% url 'student_user_profile' %}
                    {% else %}
                    /profile/
                    {% endif %}
                    "
                       data-original-title="Profile">
                        <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                    </a>

                </li>
                <li style="display: inline-block;">
                    <a class="apkdownloadBtn" data-toggle="tooltip" data-placement="top" title=""
                       href="https://we.tl/t-TveNDiCeqW" target="_blank"
                       data-original-title="Download u-LMS Android App">
                        <span class="glyphicon glyphicon-phone" aria-hidden="true"></span>
                    </a>

                </li>
                <li style="display: inline-block;">
                    <a class="logoutBtn" data-toggle="tooltip" data-placement="top" title="" href="/logout"
                       data-original-title="Logout">
                        <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
                    </a>

                </li>

            </ul>


        </div>
    </div>

    <script>
        $(document).ready(function () {
            $(document).bind('click', function (e) {
                if (!$(e.target).is('#mysidenav') && $('#mySidenav').width() > 0) {
                    $('#mySidenav').css('width', 0);
                }
            });
            $('#mysidenav a').on('click', function (e) {
                e.stopPropagation();
            });
        });

        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
            document.getElementById("mySidenav").style.height = "100%";
            {#document.getElementById("sidebar-buttom").style.display = "block";#}
            document.getElementById("hamburg-nav").style.display = "none";
            document.getElementById("closenav").style.display = "none";
            setTimeout(function () {
                document.getElementById("hamburg-nav").style.display = "block";
                document.getElementById("closenav").style.display = "block";
            }, 500);
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            {#document.getElementById("sidebar-buttom").style.display = "none";#}

        }
    </script>


{% endblock sidenav %}

<div class="container-fluid">
    <!-- For Title -->


    <div class="row overall-contents">
        <div id="prev-btn" class="button-position" style="left:0; font-size: 45px;">
            <i class="fa fa-arrow-circle-left " aria-hidden="true"></i>
        </div>
        <div id="next-btn" class="button-position" style="right:0px; font-size: 45px;">
            <i class="fa fa-arrow-circle-right " aria-hidden="true"></i>
        </div>

        <div id="container" class="container12" style="">

            <div class="content-title1  text-center">

                    <span id="chaptertitle" class="content-title">
                        <!-- Chapter title goes here -->
                         {{ chapter }}
              </span>
            </div>

            {% if not connection_offline %}
                <span class="glyphicon glyphicon-th" id="hamburg-nav"

                      style="font-size: 25px;cursor:pointer;top:20px;left: 20px;z-index: 121;position: fixed;color:#339af0;"
                ></span>
            {% endif %}
            <div id="page-contents" class="page-contents"></div>


        </div>
        <div class="progress progress-striped">
            <div class="progress-bar progress-bar-striped" style="width: 0%;" role="progressbar"
                 aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        {% if ifteacher %}
            {% include "chapter/content-viewer-moules/QuickSurvey.html" %}
            {% include "chapter/Content_Viewer_WebSocket_teacher.html" %}
        {% else %}
            {% include "chapter/Content_Viewer_WebSocket_students.html" %}
        {% endif %}



        <div class="container custom-carousel thumbnail-slider notranslate" style="position:fixed; bottom:10px">
            <div id="thumbnail-slider" class="owl-carousel owl-theme thumbnail-container">
            </div>
        </div>

        <div class="content-footer1 text-center">
            Page <span id="currentpage"></span> of <span id="totalpages"></span>
        </div>


        <!-- For Footer -->

        <div style="position: absolute; bottom: 0; min-height: 20px; padding: 20px;" id="fadeOutUp">
        </div>


        <!-- For Footer -->

        <div class="row page-slide">
        </div>


    </div>

    {% block chatui %}
        <div class="chatonly" style="display: none">
            <div class=" full-chat-container  bootstrap snippet">


                <div class="row upbarchat">
                    <div class="col-md-6 col-sm-6 col-xs-6" style="padding-left: 0px!important;">
                        <ul class="chat-nav " style="padding-left: 0px;">
                            {% if ifteacher %}
                                <li id="QuickQuiz" data-toggle="modal" data-target="#quiz_create_popup"> {% trans 'Quick Quiz' %}
                                    <i
                                            class="fa fa-pencil"></i></li>

                                <li id="QuickSurvey" data-toggle="modal" data-target="#survey_content_modal">{% trans 'Quick Survey' %}
                                    <i class="fa fa-pencil"></i></li>
                                <li>Force Screen Sync <input id="forceScreen" type="checkbox"></li>
                            {% else %}
                                <li id="followteacher" class="offline-followteacher">{% trans 'Teacher Offline' %}<i class="fa fa-book"> </i></li>
                            {% endif %}
                            <li> Notify <input id="notificationOnChat" type="checkbox" checked></li>
                            <li id="chatsoundArea">Sound <input id="chatsound" type="checkbox" checked></li>
                            <li id="speakContent">
                                <div onClick="speakContent()"><i class="fa fa-music"> </i> {% trans 'Speak' %}</div>
                            </li>
                            {% if '/teachers' in request.path %}
                                <li id="chapterProgressView">
                                    <a href="{% url 'chapter_student_progress' course.pk chapter.pk %}?iframe=1">
                                        <div>
                                            <i class="fa fa-tasks"> </i> {% trans 'Progress' %}
                                        </div>
                                    </a>
                                </li>
                                <li id="attendanceView">
                                    <a href="{% url 'teacher_courseinfo_detail_attendance' course.pk %}?iframe=1">
                                        <div>
                                            <i class="fa fa-tasks"> </i> {% trans 'Attendance' %}
                                        </div>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6 col-sm-6 col-xs-6 "
                         style="padding-right: 9px!important; padding-left:0px!important">
                        <div class="col-md-8 col-sm-8 col-xs-9">
                        <span id="reloadcontent" class="text-center" style="margin-bottom: 5px;"> <i
                                class="fa fa-refresh"> {% trans 'Reload Content' %}  </i></span>
                            <div style=" margin-top:5px">
                                <span id="google_translate_element"></span>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-3">
                        <span id="closechatbox" style="float:right; color:rgb(119, 42, 42) "> <i
                                class="fa fa-3x fa-close"></i></span>

                        </div>


                    </div>

                </div>


                <div class="row" style="
                  margin-right: 0px!important;
                  margin-left: 0px!important;
              ">


                    <div class="{{ ifteacher|yesno:'col-md-8 col-sm-8 col-xs-8,col-md-12' }}  bg-white "
                         style="{{ ifteacher|yesno:' ,width: -webkit-fill-available;width: -moz-available;' }} ">

                        <div class="row upbarchat">


                        </div>
                        <div class="chat-message">
                            <ul class="chat" id="chat-box-content">
                                <li class="left clearfix">
                                  <span class="chat-img pull-left">
                                      <img class="chat-avatar" src="https://bootdey.com/img/Content/user_3.jpg"
                                           alt="User Avatar">
                                  </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font" style="text-transform: uppercase;">{% trans 'UBL Bot' %}</strong>
                                            <small class="pull-right text-muted"><i class="fa fa-clock-o"></i> 12 mins ago</small>
                                        </div>
                                        <p>
                                            {% trans 'Hello! Try sending a message to everyone online now.' %}
                                        </p>
                                    </div>
                                </li>
                                <li class="right clearfix">
                                  <span class="chat-img pull-right">
                                      <img class="chat-avatar" src="https://bootdey.com/img/Content/user_1.jpg"
                                           alt="User Avatar">
                                  </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font" style="text-transform: uppercase;">{% trans 'UBL Bot' %}</strong>
                                            <small class="pull-right text-muted"><i class="fa fa-clock-o"></i> 13
                                                mins
                                                ago</small>
                                        </div>
                                        <p>
                                            {% trans 'Your messages history are cleared on page reload for now.' %}
                                        </p>
                                    </div>
                                </li>

                            </ul>
                        </div>

                    </div>
                    {% if "teachers" in request.path %}
                        <div class="col-md-4 col-sm-4 col-xs-4 bg-white ">


                            <!-- =============================================================== -->
                            <!-- member list -->
                            <div class="friend-list-height" style="overflow: auto;">


                                <ul id="friend-list" class="friend-list">
                                    {#                                    <li class="active ">#}
                                    {#                                        <a href="#" class="clearfix">#}
                                    {#                                            <div class="phead"><span class="time text-muted" style="font-size: 12px;">Just now</span>#}
                                    {##}
                                    {#                                                <span class="chat-alert label label-danger">1</span></div>#}
                                    {#                                            <br>#}
                                    {#                                            <img src="https://bootdey.com/img/Content/user_1.jpg" alt=""#}
                                    {#                                                 class="img-circle">#}
                                    {##}
                                    {##}
                                    {#                                            <h5>BOT</h5>#}
                                    {##}
                                    {#                                        </a>#}
                                    {##}
                                    {##}
                                    {#                                    </li>#}
                                    {#                                    <li class=" ">#}
                                    {#                                        <a href="#" class="clearfix">#}
                                    {#                                            <div class="phead"><span class="time text-muted" style="font-size: 12px;">Just now</span>#}
                                    {##}
                                    {#                                                <span class="chat-alert label label-danger">1</span></div>#}
                                    {#                                            <br>#}
                                    {#                                            <img src="https://bootdey.com/img/Content/user_1.jpg" alt=""#}
                                    {#                                                 class="img-circle">#}
                                    {##}
                                    {##}
                                    {#                                            <h5>BOT</h5>#}
                                    {##}
                                    {#                                        </a>#}
                                    {##}
                                    {#                                    </li>#}
                                    {#                                    <li class=" ">#}
                                    {#                                        <a href="#" class="clearfix">#}
                                    {#                                            <div class="phead"><span class="time text-muted" style="font-size: 12px;">Just now</span>#}
                                    {##}
                                    {#                                                <span class="chat-alert label label-danger">1</span></div>#}
                                    {#                                            <br>#}
                                    {#                                            <img src="https://bootdey.com/img/Content/user_1.jpg" alt=""#}
                                    {#                                                 class="img-circle">#}
                                    {##}
                                    {##}
                                    {#                                            <h5>BOT</h5>#}
                                    {##}
                                    {#                                        </a>#}
                                    {##}
                                    {#                                    </li>#}
                                    {#                                    <li class=" ">#}
                                    {#                                        <a href="#" class="clearfix">#}
                                    {#                                            <div class="phead"><span class="time text-muted" style="font-size: 12px;">Just now</span>#}
                                    {##}
                                    {#                                                <span class="chat-alert label label-danger">1</span></div>#}
                                    {#                                            <br>#}
                                    {#                                            <img src="https://bootdey.com/img/Content/user_1.jpg" alt=""#}
                                    {#                                                 class="img-circle">#}
                                    {##}
                                    {##}
                                    {#                                            <h5>BOT</h5>#}
                                    {##}
                                    {#                                        </a>#}
                                    {##}
                                    {#                                    </li>#}


                                </ul>
                            </div>


                        </div>
                    {% endif %}


                </div>

                <div class="row" style="
                  margin-right: 0px!important;
                  margin-left: 0px!important;">
                    <div class="chat-box bg-white">
                        <div class="input-group notranslate">
                            <input id="chatmessageinput"
                                   class="form-control border no-shadow no-rounded"
                                   placeholder="Type your message here" required>
                            <span class="input-group-btn">
                                <button style="padding: 17px;margin:0px" class="btn btn-success no-rounded"
                                        type="button"
                                        onclick="sendMessageWritten()">{% trans 'Send' %}</button>
                            </span>
                        </div><!-- /input-group -->
                    </div>
                </div>


                <!--=========================================================-->
                <!-- selected chat -->

            </div>
        </div>

        <div class="closechatopen float" id="closechatopen" style=" z-index: 500!important;">

            <i class="fa fa-comments my-float"></i>

        </div>

    {% endblock chatui %}

    <div id="examiframeholder slideInLeft">
        <div id="closeiframebtn" class="closeiframebtn">
            <button>
                <i class="fa fa-close" aria-hidden="true">
                </i>

            </button>
        </div>
        <div id="iframeholder"></div>
    </div>

</body>

<!-- jQuery -->
<script src="{% static 'vendorsx/jquery/dist/jquery.min.js' %}"></script>
<script src="{% static 'lightbox/js/lightbox.js' %}"></script>
<script src="{% static 'vendorsx/bootstrap/dist/js/bootstrap.min.js' %}"></script>
<script src="{% static 'vendorsx/moment/min/moment.min.js' %}"></script>
<script src="{% static 'vendorsx/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js' %}"></script>

<script src="{% static 'js/modernizr.js' %}"></script>
<link href="https://unpkg.com/cloudinary-video-player@1.3.4/dist/cld-video-player.min.css"
      rel="stylesheet">
<script src="https://unpkg.com/cloudinary-core@2.6.3/cloudinary-core-shrinkwrap.min.js"
        type="text/javascript"></script>
<script src="https://unpkg.com/cloudinary-video-player@1.3.4/dist/cld-video-player.min.js"
        type="text/javascript"></script>

{% if not connection_offline %}
    <script src="{% static 'chapterPageBuilder/SummerNote/summernote.min.js' %}"></script>
{% endif %}

<script type="text/javascript">
    {% if not data %}
        alert("No contents in this page. Returning back to previous page...");
        window.history.go(-1);
    {% endif %}


    var currentpage = 1;
    var studystarttime = Date.now() / 1000 | 0; // Floors the value
    var roomName = "chapterchat{{chapter.id}}";

    {% if not connection_offline %}
        {% block chatwebsocket %}
            var chatSocket;

            function startWebsocket() {
                var webSProtocal = '';

                if (location.protocol === 'https:') {
                    webSProtocal = "wss://";
                } else {
                    webSProtocal = "ws://";
                }

                var locationhost = location.host;
                if (locationhost === 'ulms.me') {
                    locationhost = "ulms.me:9002";
                }


                chatSocket = new WebSocket(webSProtocal + locationhost + "/ws/" + roomName + '/');
                chatSocket.onclose = function () {
                    // connection closed, discard old websocket and create a new one in 5s
                    chatSocket = null;
                    console.log("Websocket restarting. . . ")
                    try {
                        setTimeout(startWebsocket, 5000)
                    } catch (error) {
                    }

                }
            }

            try {
                startWebsocket();
            } catch (error) {
            }

            // Connection opened
            chatSocket.addEventListener('open', function (event) {
                chatSocket.send(
                    JSON.stringify({
                        sender_id: "{{  user.id }}",
                        sender_name: "{{  user }}",
                        sender_icon: "{{  user.Avatar }}",
                        {% if ifteacher %}
                            isteacher: 1,
                            page: currentpage,
                            force: $('#forceScreen').prop("checked") ? 1 : 0,
                        {%  endif %}
                    })
                );
            });
        {% endblock %}

    {% endif %}
    lightbox.option({
        'resizeDuration': 200,
        'wrapAround': true
    });

    // $('a').on('click', 'img', function(){
    //     console.log('hdjsf')
    //     if($(this).hasAttribute('data-lightbox')){
    //         return false;
    //     }
    // }).dblclick(function () {
    //     window.location = this.href;
    //     return false;
    // });
    document.addEventListener('visibilitychange', function () {
        pauseAllVideos(); // change tab text for demo
    })
    $(document).keydown(function (e) {
        if ($('#lightbox').css('display') == 'none' && $(document.activeElement)[0] == $('body')[0] && !$(document.activeElement).hasClass('modal-open')) {
            if (e.keyCode == '39') {
                $('#next-btn').click();
                return false
            }
            if (e.keyCode == '37') {
                $('#prev-btn').click();
                return false
            }
            //UP
            if (e.keyCode == '38') {
                $('body').animate({scrollTop: 0}, 100);
                return false;
            }
            //DOWN
            if (e.keyCode == '40') {
                $('body').animate({scrollTop: $(document).height()}, 100);
                return false;
            }

            if (e.keyCode == '70') {
                var hasFocus = $('input, textarea').is(':focus') || $('.note-editable').is(':focus');
                if (hasFocus) {
                    return
                }

                toggleFullScreen();
                return false;
            }

        }
    });

    {% if not connection_offline %}
        $('#closechatbox').on('click mouseover', function (e) {
            $('#closechatopen').show();
            $('.chatonly').hide();

        });

        $('#closechatopen').on('click mouseover', function () {
            $('.chatonly').show();
            $('#closechatopen').hide();

            {%  if ifteacher %}
                updatePageByTeacher();
                updateStudentOnlineBox("");
            {% endif  %}
        });
    {% endif %}

    {% if data %}
        var data = {{ data | safe}};
    {% endif %}

    function pauseAllVideos() {
        $('iframe').each(function () {
            $(this).attr('src', $(this).attr('src'));
            // console.log($(this)[0])
            // $(this)[0].contentWindow.
            // stMessage('{"event":"command","func":"' + 'pauseVideo' + '","args":""}', '*');
        });
        $('video').each(function () {
            this.pause();
        });
    }

    $(document).ready(function () {
        $('#hamburg-nav').on('click mouseover', function () {
            openNav();
        });

        $('#container').click(function () {
            $('.chatonly').hide();
            $('.closechatopen').show();
            $('.closenav').click();
        });
        $('#page-contents').on('click', '.iframefullscreenbtn', function () {
            // check if fullscreen mode is available
            if (document.fullscreenEnabled ||
                document.webkitFullscreenEnabled ||
                document.mozFullScreenEnabled ||
                document.msFullscreenEnabled) {

                // which element will be fullscreen
                var iframe = $(this).parent().find('object')[0] || $(this).parent().find('iframe')[0];
                // Do fullscreen
                if (iframe.requestFullscreen) {
                    iframe.requestFullscreen();
                } else if (iframe.webkitRequestFullscreen) {
                    iframe.webkitRequestFullscreen();
                } else if (iframe.mozRequestFullScreen) {
                    iframe.mozRequestFullScreen();
                } else if (iframe.msRequestFullscreen) {
                    iframe.msRequestFullscreen();
                }
            } else {
                document.querySelector('.error').innerHTML = 'Your browser is not supported';
            }
        });

    });

    $('.page-contents').on('click', '.chapterbuttons', function (e) {
        if ($(this).hasClass('btn-div')) {
            return
        }
        e.preventDefault()
        let link = $(this).find('a')[0].href;
        if (link) {
            {% if '/students' in request.path %}
                loadexam(link)
            {% else %}
                loadexam(link, 1)
            {% endif %}
        }
    })

    function loadexam(link, ShowCloseBoxonInit = false) {

        $('#examiframeholder').addClass('examiframeholder')
        $('#iframeholder').append(`
            <iframe src = ${link} height = 100% width = 100%></iframe>
        `);
        $('iframe').on('load', function () {
            if ($(this).contents().find('#survey_already_taken').is(':visible')) {
                $('#closeiframebtn').css('display', 'block')
            }
            if (link != this.contentWindow.location.href && link + '/' != this.contentWindow.location.href) {
                $('#closeiframebtn').css('display', 'block')
            }
            if (ShowCloseBoxonInit) {
                $('#closeiframebtn').css('display', 'block')
            }
        });
    }

    $('#chapterProgressView').on('click', function (e) {
        e.preventDefault()
        var link = $(this).find('a')[0].href
        loadexam(link, true)
    })

    $('#attendanceView').on('click', function (e) {
        e.preventDefault()
        var link = $(this).find('a')[0].href
        loadexam(link, true)
    })

    $('#closeiframebtn').click(function () {
        $('#examiframeholder').removeClass('examiframeholder')
        $('#closeiframebtn').css('display', 'none')
        $('#iframeholder').empty();
    })

    function loaddata(data, currentpage = 1) {
        window.currentpage = currentpage
        $('#totalpages').text(data.numberofpages);
        $('#currentpage').text(window.currentpage);
        $.each(data.pages, function (key, value) {
            if (key == window.currentpage) {
                $.each(value, function (count) {
                    // Create modal
                    $('#page-contents').empty();
                    $('#page-contents').append(`
                    <div id="page${key}" class = 'coursepages' role="dialog">

                    </div>`)
                    // -------------------------------

                    $.each(value[count], function (div, div_value) {
                        var now = Math.floor(Math.random() * 900000) + 100000;
                        if (div == 'textdiv') {
                            $.each(div_value, function (css, css_value) {
                                css_string = JSON.stringify(css_value)
                                content = css_value.content;

                                $('#page' + key).append(`
                                    <div class = "textdiv" style = "overflow:hidden; position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height:${css_value.height}; width:${css_value.width}; padding:10px; z-index:100">
                                        ${content}
                                    </div>
                                `);
                                // $('#page' + key).append(css_value.content);

                            });
                        }
                        if (div == 'pic') {
                            $.each(div_value, function (css, css_value) {
                                if (css_value.hasOwnProperty('background-image')) {
                                    src = css_value['background-image']
                                    // imgsrc = src.match(/(["'])(?:(?=(\\?))\2.)*?\1/);
                                    $('#page' + key).append(`
                                        <div style = 'position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height:${parseFloat(css_value.height)}%; width:${parseFloat(css_value.width)}%'>
                                        <a href = ${src} data-lightbox="roadtrip"> <img src = ${src} style = "height:100%; width:100%;" class="image-fitting"></img>  </a>
                                        </div>
                                    `);
                                } else if (css_value.hasOwnProperty('link')) {
                                    $('#page' + key).append(`
                                        <div style = 'position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height:${parseFloat(css_value.height)}%; width:${parseFloat(css_value.width)}%'>
                                        <iframe style="width:100%;height:100%;" src="${css_value.link}"
                                            frameborder="0" allowfullscreen scrolling="no" allow="autoplay; fullscreen"></iframe>
                                        </div>
                                    `);
                                }

                                // $('#page' + key).append(css_value.div);
                            });
                        }

                        if (div == 'btn-div') {
                            $.each(div_value, function (css, css_value) {
                                link = "";
                                if (css_value.hasOwnProperty('link')) {
                                    link = "href = " + css_value.link;
                                }
                                font_size = convertFont(css_value.font_size)
                                $('#page' + key).append(`
                                <div class = "chapterbuttons btn-div" style = "z-index: 1;position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                    <a ${link} target="_blank">
                                        <button class="custom-btn-only"style="width:100%; height:100%">
                                            <div class="row text-center" width=100%>
                                                <span class="resizable-text-only" style = "font-size: ${font_size}">${css_value.btn_name} </span>
                                            </div>
                                        </button>
                                    </a>
                                </div>
                            `)
                            });
                        }

                        if (div == 'quizdiv') {
                            let quizpk;
                            $.each(div_value, function (css, css_value) {
                                link = "";
                                if (css_value.hasOwnProperty('link')) {
                                    quizpk = (css_value.link.split('/')[2]).match(/\d+/)[0];
                                    {% if '/teachers' in request.path %}
                                        link = "href = /quiz/markingfilter/" + quizpk + '?iframe=1'
                                    {% elif '/students' not in request.path and '/teachers' not in request.path %}
                                        link = "href = /quiz/detail/" + quizpk + '?iframe=1'
                                    {% else %}
                                        link = "href = " + css_value.link + '?iframe=1';
                                    {% endif %}
                                }
                                font_size = convertFont(css_value.font_size)
                                $('#page' + key).append(`
                                <div class = "chapterbuttons" style = "z-index: 1;position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                    {% if not connection_offline %}
                                        <a ${link}>
                                            <button class="custom-btn-only"style="width:100%; height:100%">
                                                <div class="row text-center" width=100%>
                                                    <span class="resizable-text-only" style = "font-size: ${font_size}">
                                    ${css_value.quiz_btn_name} </span>
                                                </div>
                                                <div class="row text-center">
                                                    <span style = "font-size: 1em;">${css_value.quiz_name}</span>
                                                </div>
                                            </button>
                                        </a>
                                    {% else %}
                                        <button class="custom-btn-only"style="width:100%; height:100%" disabled>
                                            <div class="row text-center" width=100%>
                                                <span class="resizable-text-only" style = "font-size: ${font_size}">Quiz</span>
                                            </div>
                                            <div class="row text-center">
                                                <span style = "font-size: 1em; color: red">Please use online viewer to play quiz</span>
                                            </div>
                                        </button>
                                    {% endif %}
                                </div>
                            `)
                            });
                        }

                        if (div == 'surveydiv') {
                            let surveypk;
                            $.each(div_value, function (css, css_value) {
                                link = "";
                                if (css_value.hasOwnProperty('link')) {
                                    surveypk = (css_value.link.split('/')[4]).match(/\d+/)[0];
                                    {% if '/teachers' in request.path %}
                                        link = "href = /teachers/surveyinfodetail/detail/" + surveypk + '?iframe=1'
                                    {% elif '/students' not in request.path and '/teachers' not in request.path %}
                                        link = "href = /survey/surveyinfo/detail/" + surveypk + '?iframe=1'
                                    {% else %}
                                        link = "href = " + css_value.link + '?iframe=1';
                                    {% endif %}
                                }
                                font_size = convertFont(css_value.font_size)
                                $('#page' + key).append(`
                                <div class = "chapterbuttons" style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width}; background-color:#DDDDDD">
                                    {% if not connection_offline %}
                                        <a ${link} target="_blank">
                                            <button class="custom-btn-only"style="width:100%; height:100%">
                                                <div class="row text-center" width=100%>
                                                <span class="resizable-text-only" style = "font-size: ${font_size}">
                                    ${css_value.survey_btn_name} </span>
                                                </div>
                                                <div class="row text-center">
                                                        <span class = "survey-name " style = "font-size:1em">
                                                ${css_value.survey_name}
                                                </div>
                                            </button>
                                        </a>
                                    {% else %}
                                        <button class="custom-btn-only"style="width:100%; height:100%" disabled>
                                            <div class="row text-center" width=100%>
                                             <span class="resizable-text-only" style = "font-size: ${font_size}">Survey </span>
                                            </div>
                                            <div class="row text-center">
                                                    <span class = "survey-name " style = "font-size:1em; color: red">Please use online viewer to take survey.</span>
                                            </div>
                                        </button>
                                    {% endif %}
                                </div>
                            `)
                            });
                        }

                        if (div == 'pdf') {
                            $.each(div_value, function (css, css_value) {
                                $('#page' + key).append(`
                                <div class="iframefullscreen" style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                    <div class = "iframefullscreenbtn"><i class="fa fa-credit-card"></i></div>
                                        <iframe src="/static/pdfjs/web/viewer.html?file=../../..${encodeURIComponent(css_value.link)}" type="application/pdf" width="100%" height="100%">
                                        alt : PDF File
                                    </iframe>
                                </div>
                            `)
                            });
                        }

                        if (div == 'video') {
                            $.each(div_value, function (css, css_value) {
                                if (css_value.hasOwnProperty('online_link')) {
                                    var embed = `<div id = '${now}' style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                        <iframe width="100%" height="94%" src="${css_value.online_link}" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

                                        </div>`
                                } else {
                                    if (css_value.local_link.includes('/media/chapterBuilder/')) {
                                        var embed = `
                                    <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                        <video controls muted"
                                            class="videodim">
                                            <source src="${css_value.local_link}"  type="video/mp4">
                                        </video>
                                    </div>
                                    `
                                    } else {
                                        var embed = `
                                    <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                        <video controls muted id="video${now}"
                                            class="videodim cld-video-player cld-video-player-skin-dark example-player"
                                            data-cld-public-id="${css_value.local_link}" data-public_id="${css_value.local_link}" data-cld-source-types='["mp4", "ogg", "webm"]'>
                                            <source src="${css_value.local_link}"  type="video/mp4">
                                        </video>
                                    </div>
                                    `
                                    }
                                }
                                $('#page' + key).append(embed)
                                if (!css_value.hasOwnProperty('online_link') && !css_value.local_link.includes('/media/chapterBuilder')) {
                                    play("#video" + now)
                                }
                            });
                        }

                        if (div == 'audio') {
                            $.each(div_value, function (css, css_value) {
                                if (css_value.hasOwnProperty('online_link')) {
                                    var embed = `<div id = '${now}' style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                        <iframe width="100%" height="94%" src="${css_value.online_link}" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

                                        </div>`
                                } /*else {
                                    if (css_value.local_link.includes('/media/chapterBuilder/')) {
                                        var embed = `
                                    <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                        <audio controls muted"
                                            class="videodim">
                                            <source src="${css_value.local_link}"  type="video/mp4">
                                        </audio>
                                    </div>
                                    `
                                    } else {
                                        var embed = `
                                    <div style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">
                                        <video controls muted id="audio${now}"
                                            class="audiodim cld-video-player cld-video-player-skin-dark example-player"
                                            data-cld-public-id="${css_value.local_link}" data-public_id="${css_value.local_link}" data-cld-source-types='["mp4", "ogg", "webm"]'>
                                            <source src="${css_value.local_link}"  type="audio/mp4">
                                        </video>
                                    </div>
                                    `
                                    }
                                }*/
                                $('#page' + key).append(embed)
                                if (!css_value.hasOwnProperty('online_link') && !css_value.local_link.includes('/media/chapterBuilder')) {
                                    play("#audio" + now)
                                }
                            });
                        }

                        if (div == '_3d') {
                            $.each(div_value, function (css, css_value) {
                                $('#page' + key).append(`
        <div  style = "position:absolute; top: ${css_value.tops}; left: ${css_value.left}; height: ${css_value.height}; width: ${css_value.width};">

                                  <div>  <model-viewer class="D3onViewer" ondblclick="requestFullscreen()"
                                        src="${css_value.link}"
                                        alt="Here is a 3D Object."
                                        auto-rotate
                                        camera-controls
                                        style = "height: 100%;width: 100%;">
                                                <div class="custom-poster" slot="poster"></div>

                                    </model-viewer></div>

                                </div>
                            `)
                            });
                        }

                        if (div == 'backgroundcolor') {
                            $('#container').css('background-color', div_value)
                        }
                    });
                });
                $('.textdiv span').each(function () {
                    let fontsize = $(this)[0].style.fontSize
                    if (fontsize) {
                        convertedFont = convertFont(fontsize)
                        $(this)[0].style.fontSize = convertedFont;
                    }
                })
            }
        });
    }

    function convertFont(font) {
        let unit = font.slice(-2)
        if (unit == 'px') {
            return parseFloat(font) / 16 + 'em'
        } else if (unit == 'em') {
            return parseFloat(font) + 'em'
        } else if (unit == 'rem') {
            return font
        } else if (unit == 'pt') {
            return parseFloat(font) / 12 + 'em'
        } else {
            return font
        }

    }

    function toggleFullScreen() {
        if ((document.fullScreenElement && document.fullScreenElement !== null) ||
            (!document.mozFullScreen && !document.webkitIsFullScreen)) {
            if (document.documentElement.requestFullScreen) {
                document.documentElement.requestFullScreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullScreen) {
                document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
            }
        } else {
            if (document.cancelFullScreen) {
                document.cancelFullScreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitCancelFullScreen) {
                document.webkitCancelFullScreen();
            }
        }
    }


    function setThumbnails() {
        $.each(data.pages, function (key, value) {
            if (value[0]['thumbnail'] == "") {
                $('.thumbnail-container').append(`<div class = 'thumbnails items' value = ${key} style="position:relative">
                       <div class="key-holder" style="position:absolute; top:0px ; left:3px"> ${key} </div> <img  class="thumb-img" src = "{% static 'images/blankpage.jpg' %}"></img>
                </div>
            `);
            } else {
                $('.thumbnail-container').append(`<div class = 'thumbnails items' value = ${key}>
                        <div class="key-holder" style="position:absolute;top:0px;left:3px;font-size: large;font-weight:700;text-shadow: 2px 2px 6px #ffffff;"> ${key} </div>
                        <img  class="thumb-img" src = "${value[0]['thumbnail']}" onError="this.onerror=null;this.src='{% static 'images/blankpage.jpg' %}';"></img>
                </div>
                `);
            }
        });
    }

    var x = window.matchMedia("(max-width: 567px)")

    function Layout(x) {
        if (x.matches) {
            $('#page-contents').empty();
            loaddata(data, window.currentpage);
            $('#page-contents div').each(function () {
                $(this).removeAttr('style')
                $(this).css('padding', '10px')
            })
        } else {
            $('#page-contents').empty();
            loaddata(data, window.currentpage)
        }
        $('.thumbnails').removeAttr('style').removeClass('active');
        $('.thumbnails[value=' + window.currentpage + ']').css({
            'border': '1px solid red'
        }).addClass('active');
    }

    $(document).ready(function () {
        setThumbnails();
        $('.owl-carousel').owlCarousel({
            nav: true,
            // slideBy: 5,
            rewind: true,
            dots: false,
            items: parseInt($('#totalpages').text()),
            navText: ["<i class=' fa fa-chevron-circle-left'></i>",
                "<i class='fa  fa-chevron-circle-right'></i>"],
            responsive: {
                0: {
                    items: 1
                },
                300: {
                    items: 2

                },
                400: {
                    items: 3
                },
                600: {
                    items: 5
                },
                1000: {
                    items: 8
                }
            }
        })
        Layout(x)
        x.addListener(Layout) // Attach listener function on state changes
        getProgressWidth();

        $('#next-btn').off().click(function () {
            pauseAllVideos();
            if (currentpage < data.numberofpages) {
                currentpage = parseInt(currentpage) + 1;
                changePage(currentpage)

            }
        });

        $('#prev-btn').off().click(function () {
            pauseAllVideos();
            if (currentpage != 1) {
                currentpage = parseInt(currentpage) - 1;
                changePage(currentpage)
            }
        });

        $('.thumbnails').on('click', function () {
            pauseAllVideos();
            currentpage = parseInt($(this).attr('value'));
            changePage(currentpage)


        });

        {% if not connection_offline %}
            $('#chatmessageinput').summernote({
                toolbar: []
            });
            $('#chatmessageinput').parent().find('.note-statusbar').remove();
        {% endif %}
    });


    function changePage(page_number) {
        {% if not connection_offline %}
            {% if '/students' in request.path %}
                chapterProgressStopFunction()
                chapterProgressFunction()
            {% elif '/teachers' in request.path %}
                teacherchapterProgressFunction()
            {% endif %}
        {% endif %}
        if (page_number >= parseInt($('#totalpages').text())) {
            $('#next-btn').css('visibility', 'hidden')
        } else {
            $('#next-btn').css('visibility', 'visible')
        }
        if (page_number <= 1) {
            $('#prev-btn').css('visibility', 'hidden')
        } else {
            $('#prev-btn').css('visibility', 'visible')
        }
        Layout(x)
        $('#currentpage').text(parseInt(page_number));
        getProgressWidth();
        document.querySelector("#thumbnail-slider > div.owl-stage-outer > div > div:nth-child(" + page_number + ") > div").scrollIntoView();
        {% if ifteacher %}
            updatePageByTeacher();
        {% else %}
            // updatePageByStudent(); //TBI
        {% endif %}
        localStorage.setItem("ChapterPageNumber_{{chapter.id}}", page_number); //save page number

        try {
            speechSynthesis.cancel();
        } catch (e) {
        }

    }


    function getProgressWidth() {
        let w = (window.currentpage / parseFloat('{{data.numberofpages}}')) * 100;
        $('.progress-bar').css('width', w + '%')
    }

</script>


<script src="{% static 'chapterPageBuilder/js/owl-carousel/owl.carousel.js' %}"></script>


<script>
    let idleTimer = null;
    let idleState = false;

    function showFoo(time) {
        clearTimeout(idleTimer);
        if (idleState == true) {
            $("#prev-btn , #hamburg-nav, #next-btn , .closebtn, .editbtn, .closechatopen , .content-title1 , .thumbnail-slider , .content-footer1 , #thumb-next-btn , #thumb-prev-btn , .float").removeClass("inactive");

        }
        idleState = false;
        idleTimer = setTimeout(function () {
            $("#prev-btn , #hamburg-nav, #next-btn,  .closebtn, .editbtn, .content-title1 , .thumbnail-slider , .content-footer1, #thumb-next-btn , #thumb-prev-btn, .float").addClass("inactive");

            idleState = true;
        }, time);
    }

    showFoo(2000);

    $(window).on("mouseover touchstart click", function () {
        showFoo(2000);
    });

    $(window).load(function () {
        // Animate loader off screen
        $(".se-pre-con").fadeOut("slow");


        // retrieve slide number
        if (parseInt(localStorage.getItem("ChapterPageNumber_{{chapter.id}}")) >= 1) {
            currentpage = parseInt(localStorage.getItem("ChapterPageNumber_{{chapter.id}}"));
            changePage(currentpage)

        }


        // save chapter number for course
        localStorage.setItem("chapter_for_course" + {{ course.pk }}, {{ chapter.pk }});


    });

    function fontResize() {
        if (window.innerWidth > 567) {
            var perc = parseInt($('.container12').width()) / 80;
            $('.container12').css('font-size', perc);
        }

    }

    $(document).ready(function () {
        fontResize();
    });
    $(window).resize(function () {
        fontResize();
    });
</script>

{% if not connection_offline %}
    <script>
        function sendMessageWrittenToTeachers() {
            if ($('.note-editable').html()) {
                chatSocket.send(
                    JSON.stringify({
                        chat_message: $('.note-editable').html(),
                        sender_id: "{{  user.id }}",
                        sender_name: "{{  user }}",
                        sender_icon: "{{  user.Avatar }}",
                        {% if ifteacher %}
                            isteacher: 1,
                        {%  endif %}
                        SendOnlyToTeachers: 1,
                    })
                );
            }
            $('.note-editable').html("");
        }

        function sendMessageWrittenToStudents() {
            if ($('.note-editable').html()) {
                chatSocket.send(
                    JSON.stringify({
                        chat_message: $('.note-editable').html(),
                        sender_id: "{{  user.id }}",
                        sender_name: "{{  user }}",
                        sender_icon: "{{  user.Avatar }}",
                        {% if ifteacher %}
                            isteacher: 1,
                        {%  endif %}
                        SendOnlyToStudents: 1,
                    })
                );
            }
            $('.note-editable').html("");
        }


        function sendMessageWritten() {
            if ($('.note-editable').html()) {
                chatSocket.send(
                    JSON.stringify({
                        chat_message: $('.note-editable').html(),
                        sender_id: "{{  user.id }}",
                        sender_name: "{{  user }}",
                        sender_icon: "{{  user.Avatar }}",
                        {% if ifteacher %}
                            isteacher: 1,
                        {%  endif %}
                    })
                );
            }
            $('.note-editable').html("");
        };

        $(document).keydown(function (event) {
            if ($('.note-editable').is(":focus")) {
                if (event.keyCode == 13 && !event.shiftKey) {
                    if ($('.note-editable').html() != '""') {
                        sendMessageWritten();

                    }
                    ;
                }
            }

        });



        {% if ifteacher %}

            $('#forceScreen').change(function () {
                updatePageByTeacher();
            });

            var OnlineMem = [];
            function updateStudentOnlineBox(Newdata = null) {
                if (Newdata.sender_id) {
                    OnlineMem[Newdata.sender_id] = {
                        sender_name: Newdata.sender_name,
                        sender_icon: Newdata.sender_icon,
                        isteacher: Newdata.isteacher,
                        lastUpdate: new Date().toISOString(),
                    };
                }

                $('#friend-list').html('');
                for (var eachuser in OnlineMem) {
                    $('#friend-list').append(`<li class=" ">
                                        <a href="#" class="clearfix">
                                            <img src="` + OnlineMem[eachuser].sender_icon + `" alt="" class="img-circle"><br>

` + OnlineMem[eachuser].sender_name + `<br>
                             <time style=" font-size: 8px;"  class="timeago" datetime= "` + OnlineMem[eachuser].lastUpdate + `"> </time>


                                        </a>

                                    </li>`)
                }
                $('time.timeago').timeago();
            }

        {%  endif %}



        // function changeThumbScroll() {
        //     document.querySelector("#thumbnail-slider > li.thumbnails.active").scrollIntoView();

        // };


        chatSocket.onmessage = function (e) {


            var data = JSON.parse(e.data);

            {% if ifteacher %}
                updateStudentOnlineBox(data);
            {% endif %}
            if ("page" in data) {


                {% if not  ifteacher %}
                    HandlePageInStudents(data);
                {% endif %}



            } else if ("chat_message" in data) {

                {% if ifteacher %}
                    if ("SendOnlyToStudents" in data) return 0;
                {%  else %}
                    if ("isteacher" in data) teacherOnline();
                    if ("SendOnlyToTeachers" in data) return 0;
                {%  endif %}

                if (data.sender_id =={{ user.id }}) {
                    AddSelfMessageToChat(data);
                } else {
                    AddOtherMessageToChat(data);
                }

                displayNotif(data);

            }
        };

        function displayNotif(data) {
            if ($('#notificationOnChat').prop('checked')) {
                $("#fadeOutUp").html('<h3 id="messageChatUp" style="position: relative">' + data.sender_name + ": " + data.chat_message + '</h3>');

                $("#messageChatUp").animate({
                    top: -300,
                    opacity: 0
                }, 3000, "linear", function () {
                })
            }

        }

        $(document).ready(function () {
            // var chatdetails = `{{chat_details |safe }}`
            {% for chat in chat_details %}
                chat_data = `{{chat|escapejs}}`

                var details = JSON.parse(chat_data)
                if (details.sender_id == '{{ request.user.id }}') {

                    if ('SendOnlyToTeachers' in details && window.location.href.indexOf("/teachers") > -1) {
                        AddSelfMessageToChat(details)
                    }
                    if ('SendOnlyToStudents' in details && window.location.href.indexOf("/students") > -1) {
                        AddSelfMessageToChat(details)
                    }
                    if (!('SendOnlyToTeachers' in details) && !('SendOnlyToStudents' in details)) {
                        AddSelfMessageToChat(details)
                    }
                } else {
                    if ('SendOnlyToTeachers' in details && window.location.href.indexOf("/teachers") > -1) {
                        AddOtherMessageToChat(details)
                    }
                    if ('SendOnlyToStudents' in details && window.location.href.indexOf("/students") > -1) {
                        AddOtherMessageToChat(details)
                    }
                    if (!('SendOnlyToTeachers' in details) && !('SendOnlyToStudents' in details)) {
                        AddOtherMessageToChat(details)
                    }
                }
            {% endfor %}
        })
    </script>


    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'id,zh-CN,cs,ko,nl,en,et,fr,ne,ru,vi'
            }, 'google_translate_element');
        }


    </script>
    <script type="text/javascript"
            src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.3/jquery.timeago.min.js"></script>


    <script>
        function CheckIfToScrollChat() {
            var isScrolledToBottom = 0;
            var out = document.getElementById("chat-box-content");
            isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + 1;
            return isScrolledToBottom;
        }

        function AddOtherMessageToChat(data) {
            if ('currenttime' in data) {
                datetimevalue = data.currenttime.split('-')
                var currenttime = new Date(Date.UTC(datetimevalue[0], parseInt(datetimevalue[1]) - 1, datetimevalue[2], datetimevalue[3], datetimevalue[4], datetimevalue[5], datetimevalue[6])).toISOString()
            } else {
                var currenttime = new Date().toISOString()
            }
            var CheckIfToScrollChatx = CheckIfToScrollChat()
            $("#chat-box-content").append(`<li class="left clearfix">
                    	<span class="chat-img pull-left">
                    		<img class="chat-avatar" src="` + data.sender_icon + `" alt="` + data.sender_id + `">
                    	</span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <strong class="primary-font"> ` + data.sender_name + "&nbsp;" + ` </strong>
                                  <small class="pull-right text-muted">  <i class="fa fa-clock-o"></i> <time   class="timeago" datetime= ` + currenttime + `></time>    </small>
                                    </div>
                                    <p>
                                        ` + data.chat_message + `
                                    </p>
                                </div>
                            </li>`);
            $('time.timeago').timeago();

            if ($('#chatsound').prop('checked')) soundAlert.play();
            $('time.timeago').timeago();
            if (CheckIfToScrollChatx) {
                var out = document.getElementById("chat-box-content");
                var out = document.getElementById("chat-box-content");
                out.scrollTop = out.scrollHeight - out.clientHeight;
            }


        }


        function AddSelfMessageToChat(data) {
            if ('currenttime' in data) {
                datetimevalue = data.currenttime.split('-')
                var currenttime = new Date(Date.UTC(datetimevalue[0], parseInt(datetimevalue[1]) - 1, datetimevalue[2], datetimevalue[3], datetimevalue[4], datetimevalue[5], datetimevalue[6])).toISOString()
            } else {
                var currenttime = new Date().toISOString()
            }
            var CheckIfToScrollChatx = CheckIfToScrollChat()
            $("#chat-box-content").append(`<li class="right clearfix">
                    	<span class="chat-img pull-right">
                    		<img class="chat-avatar" src=" {{ request.user.Avatar }}" alt="` + data.sender_id + `">
                    	</span>
                                <div class="chat-body clearfix">
                                    <div class="header">
                                        <strong class="primary-font"> You </strong>
                                   <div class="pull-right text-muted">         <i class="fa fa-clock-o"></i> <time   class="timeago" datetime= ` + currenttime + `></time> </div>
                                    </div>
                                    <p>
                                        ` + data.chat_message + `
                                    </p>
                                </div>
                            </li>`);
            $('time.timeago').timeago();
            if (CheckIfToScrollChatx) {
                var out = document.getElementById("chat-box-content");
                out.scrollTop = out.scrollHeight - out.clientHeight;

            }
        }

        jQuery(document).ready(function () {
            $('time.timeago').timeago();


        });


        window.soundAlert = new Audio('data:audio/ogg;base64,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')


        $('#reloadcontent').click(function () {
            jQuery('#\\:1\\.container').contents().find('#\\:1\\.restore').click();
            setTimeout(function () {
                history.go(0);
            }, 1000);


        });
        var availablevoices;

        try {
            speechSynthesis.onvoiceschanged = function () {
                availablevoices = window.speechSynthesis.getVoices();

            };
        } catch (e) {
        }


        function speakContent() {

            if (speechSynthesis.speaking) speechSynthesis.cancel();

            var text = $('#container').children(":visible").text();
            var msg = new SpeechSynthesisUtterance();
            msg.onstart = function () {
                $('#speakContent').html('<div onClick="speechSynthesis.cancel();"><i class="fa fa-pause"> </i> Stop</div>');
            };
            msg.onend = function () {

                $('#speakContent').html('<div onClick="speakContent()"><i class="fa fa-music"> </i> Speak</div>');
            };
            msg.onerror = function () {

                $('#speakContent').html('<div onClick="speakContent()"><i class="fa fa-music"> </i> Speak</div>');
            };

            selectedTranslation = document.getElementsByClassName('goog-te-combo')[0].value ? document.getElementsByClassName('goog-te-combo')[0].value : 0;
            if (selectedTranslation) {
                if (selectedTranslation === "id") msg.lang = selectedTranslation;
                else if (selectedTranslation === "zh-CN") msg.lang = selectedTranslation;
                else if (selectedTranslation === "cs") msg.lang = selectedTranslation;
                else if (selectedTranslation === "ko") msg.lang = selectedTranslation;
                else if (selectedTranslation === "nl") msg.lang = selectedTranslation;
                else if (selectedTranslation === "en") msg.lang = "en-GB";
                else if (selectedTranslation === "et") msg.lang = selectedTranslation;
                else if (selectedTranslation === "fr") msg.lang = selectedTranslation;
                else if (selectedTranslation === "ne") msg.lang = "hi";
                else if (selectedTranslation === "ru") msg.lang = selectedTranslation;
                else if (selectedTranslation === "vi") msg.lang = selectedTranslation;
                else msg.lang = "en-GB";
            }
            msg.rate = 1;
            msg.pitch = 1;
            msg.text = text;
            speechSynthesis.speak(msg);

        }


        window.addEventListener('beforeunload', function (e) {

            // the absence of a returnValue property on the event will guarantee the browser unload happens
            $(".se-pre-con").fadeIn("slow", function () {
                $(".se-pre-con").fadeOut("slow");

            });
            speechSynthesis.cancel();

        });


    </script>

    <script>
        // This is the service worker with the Advanced caching

        // Add this below content to your HTML page, or add the js file to your page at the very top to register service worker

        // Check compatibility for the browser we're running this in
        if ("serviceWorker" in navigator) {
            if (navigator.serviceWorker.controller) {
                console.log("[PWA Builder] active service worker found, no need to register");
            } else {
                // Register the service worker
                navigator.serviceWorker
                    .register("/pwabuilder-sw.js", {
                        scope: "/"
                    })
                    .then(function (reg) {
                        console.log("[PWA Builder] Service worker has been registered for scope: " + reg.scope);
                    });
            }
        }

    </script>

    <script>
        var params = new URLSearchParams(location.search);
        $(document).ready(function () {

            if (params.get('mobileViewer') == 1) {
                // $('.logoutBtn, .apkdownloadBtn, .profileBtn').remove();
                $('#sidebar-buttom, #hamburg-nav, .closebtn, #reloadcontent').remove()

                $(document).on('click tap taphold swipe touchmove touchend', function () {
                    toggleFullScreen();
                    $(document).unbind('click tap taphold swipe touchstart touchmove touchend')
                });
            }
        });
        //params.get('mobileViewer')
    </script>

    <!-- Chapter Progress save feature -->
    {% if not connection_offline %}
        {% if '/students' in request.path %}
            <script>
                var chapterProgress;
                var currentPageUpdateOnServer = 0;

                function chapterProgressFunction() {
                    var timewhensendingprogress = Date.now() / 1000 | 0; // floors the value
                    //if (currentPageUpdateOnServer) {
                    chapterProgress = setInterval(function () {
                        $.ajax({
                            url: "{% url 'pageupdateajax' course.pk chapter.pk %}",
                            type: "post",
                            data: {
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'currentpage': window.currentpage,
                                'totalpages': data.numberofpages,
                                'studytimeinseconds': 5,    // because in every 5 seconds the function will be called, therefore studytime is 5 seconds.
                                'last_study_time': timewhensendingprogress,
                            },
                            success: function (data) {
                                console.log(data)
                                window.currentPageUpdateOnServer = parseInt(data.contents.currentpagenumber)
                            },
                        })
                    }, 5000);
                    //}
                }

                function chapterProgressStopFunction() {
                    clearInterval(chapterProgress);
                }

                chapterProgressFunction()
                StudentChapterLogUpdateAjax(1)

                function StudentChapterLogUpdateAjax(type = 1) {
                    $.ajax({
                        url: "{% url 'studentChapterLogUpdateAjax' chapter.pk %}",
                        type: "post",
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'type': type,
                        },
                        success: function (data) {
                            console.log(data)
                        },
                    })
                }

                /*
                                $(window).on("blur focus", async function (e) {
                                    var prevType = $(this).data("prevType");

                                    if (prevType != e.type) {   //  reduce double fire issues
                                        switch (e.type) {
                                            case "blur":
                                                StudentChapterLogUpdateAjax(0);
                                                chapterProgressStopFunction();
                                                break;
                                            case "focus":
                                                StudentChapterLogUpdateAjax(1);
                                                chapterProgressFunction();
                                                break;
                                        }
                                    }

                                    $(this).data("prevType", e.type);
                                })

                */
                window.addEventListener('beforeunload', function (event) {
                    StudentChapterLogUpdateAjax(0)
                }, false);
            </script>
        {% endif %}

        <script>
            var teacherchapterProgress;

            // var currentPageUpdateOnServer = 0;

            function teacherchapterProgressFunction() {
                //if (currentPageUpdateOnServer === 0) {
                teacherchapterProgress = setTimeout(function () {
                    $.ajax({
                        url: "{% url 'taketeacherAttendance' course.pk %}",
                        type: "get",
                        data: {
                            'chapterid': '{{chapter.pk }}',
                            'pagenumber': window.currentpage,
                        },
                        success: function (data) {
                            // window.currentPageUpdateOnServer = parseInt(data)
                        },
                    })
                }, 100);
                //}
            }

            function teacherchapterProgressStopFunction() {
                clearTimeout(teacherchapterProgress);
            }

        </script>
    {% endif %}

    <script>
        function play(id) {
            var cld = cloudinary.Cloudinary.new({cloud_name: 'nsdevil-com'});
            var vidElem = $(id)[0]
            var player = cld.videoPlayer(vidElem, {
                showJumpControls: true,
                showLogo: false,
                playbackRates: ['0.25', '0.5', '1', '1.25', '1.5', '2'],
            });
        }
    </script>
{% endif %}