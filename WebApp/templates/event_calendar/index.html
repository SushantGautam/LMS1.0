{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block stylesheet %}
  <!-- Fullcalendar -->
    <link rel="stylesheet" href="{% static 'vendors/fullcalendar/fullcalendar.min.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'vendors/clockpicker/bootstrap-clockpicker.min.css' %}" type="text/css">

    <!-- Select2 -->
    <link rel="stylesheet" href="{% static 'vendors/select2/css/select2.css' %}" type="text/css">

{% endblock %}

{% block breadcrumb %}
 <li class="breadcrumb-item active" aria-current="page"><a href="{% url 'start' %}" style="font-weight:normal;">{% trans "Home" %}</a></li>
 <li class="breadcrumb-item active" aria-current="page"><a href="#">{% trans "Calendar" %}</a></li>
{% endblock %}

{% block content %}
{% include 'event_calendar/common/calendar.html' %}
{% endblock %}

{% block javascript %}

    <!-- Datepicker Example -->
    <script src="{% static 'js/examples/datepicker.js' %}"></script>
    <script src="{% static 'js/common.js' %}"></script>

    <!-- Fullcalendar -->
    <script src="{% static 'vendors/fullcalendar/moment.min.js' %}"></script>
    <script src="{% static 'vendors/fullcalendar/fullcalendar.min.js' %}"></script>
    <script src="{% static 'vendors/fullcalendar/locale-all.js' %}"></script>
    <!-- <script src="{% static 'js/examples/fullcalendar.js' %}"></script> -->

    <!-- Clockpicker -->
    <script src="{% static 'vendors/clockpicker/bootstrap-clockpicker.min.js' %}"></script>
    <script src="{% static 'js/examples/clockpicker.js' %}"></script>

    <!-- Select2 -->
    <script src="{% static 'vendors/select2/js/select2.full.js' %}"></script>

    <!-- Initialize Calendar -->
    <script>

 //   $(window).on('load', function() {
   // console.log("ASHJASJASAJ", $('#calendar-demo').fullCalendar('clientEvents', function(ev){return ev.allDay}));
 //   let list_event = $('#calendar-demo').fullCalendar('clientEvents', function(ev){return ev.allDay});
   // console.log(list_event);
  //  for( ev of list_event  ){
       // console.log("EV",ev);
     //    if(ev.end){
       //     let m_end = ev.end.toDate();
           //  console.log("M End", m_end);
       //      ev.end.set({h:23, m:59, s:59});
          //   console.log("12121212121",ev.end);
        //     $('#calendar-demo').fullCalendar('updateEvent', ev);

           //     }
 //   }
 //   });
        $(document).ready(function () {


           //  $(".chapter_dynamic").hide();

       // $(".fc.fc-event").css("border", "dotted");
       // $(".fc.fc-event").css("border-radius", "5px");
       // $(".fc .fc-event").css({"border":  5+"px " +" dotted "+ "rgb("+ 255 +","+ 229 +","+ 204 +")"});
       // $(".btn .btn-info .btn-danger .btn-primary .btn-success").css("border-color", " ");


      //   var style1 = "5px dotted rgb(231,212,164)";
      //   $('.fc.fc-event').css({
      //      'border': style1
      //  });

        // Detail For Update Modal

        function update_fxn(e){
                    let event = e.data.param1;
                //    console.log("update fxn");


                    var modal = $('#createEventModal');
                    modal.find('.modal-title').text("{% trans 'Update Event' %}");
                    modal.find('#id_title').val(event.title);
                    $(".chapter_dynamic").hide();
                   // $(".chapter_dynamic").css("display", "none");
                    console.log("Type", event.tp);
                   if (event.tp === "HO")
                   {
                        modal.find("#customRadioInline3").prop("checked", true);
                   }else if (event.tp === "ME")
                    {   
                        modal.find("#customRadioInline2").prop( "checked", true );
                   }else if (event.tp === "EX")
                    {
                        modal.find("#customRadioInline4").prop( "checked", true );
                   }else if (event.tp === "CH")
                    {
                        modal.find("#customRadioInline5").prop( "checked", true );
                        $(".chapter_dynamic").show();


                           id = [];
                            console.log("ID", id);
                           for (i=0; i<event.chapter_list.length; i++){

                                id.push(event.chapter_list[i].id);
                               // console.log(id);
                          }
                          console.log(id);
                          $('#chapter_list_multiple').val(id);
                          $('#chapter_list_multiple').trigger('change');



                   }
                   else{
                         modal.find("#customRadioInline1").prop( "checked", true );
                    }

                   console.log("R_type:", event.r_type);
                   if(event.r_type === "DA"){

                        modal.find("#repeatRadioInline1").prop( "checked", true );

                   }else if(event.r_type === "WE"){
                         modal.find("#repeatRadioInline2").prop( "checked", true );

                   }else if(event.r_type === "MO"){
                          modal.find("#repeatRadioInline3").prop( "checked", true );
                   }else{
                           modal.find("#repeatRadioInline4").prop( "checked", true );
                   }



                   if (event.allDay)
                    {
                      modal.find('#id_is_all_day').prop("checked", true);
                      $(".datetime_dynamic").hide();


                   }else {
                    modal.find('#id_is_all_day').prop("checked", false);
                    $(".datetime_dynamic").show();
                   }



                  let start = event.start_edit;
                   console.log("Start_from_Update",start);
                   sd = new Date()
           // console.log("Start_from_Update",start);
          //  console.log("Start_from_Update",start);
                  start = start._d.toLocaleString();
                 // startutc = start._d.toUTCString();
                //  console.log("Start_Locale",start);
                 // console.log("Start_UTC",startutc);
                  let start_date = start.split(' ')[0].replace(/[,]/g, ' ');
                  let start_time = start.split(' ')[1];
                  let st = start.split(' ')[2];
                  let hours = Number(start_time.match(/^(\d+)/)[1]);
                  let minutes = Number(start_time.match(/:(\d+)/)[1]);
                  if (st == 'PM' && hours<12) hours = hours+12;
                  if(st == "AM" && hours==12) hours = hours-12;
                  var sHours = hours.toString();
                  var sMinutes = minutes.toString();
                  if(hours<10) sHours = "0" + sHours;
                  if(minutes<10) sMinutes = "0" + sMinutes;
                  stime = sHours + ":" + sMinutes


           // console.log("UpdateEND",end);
                  let end = event.end_edit.clone();
                   console.log("End_from_Update",end);
                  if (!end)
                  {
                  end = event.start_edit.clone();
                  }
                   if(event.allDay){
                          end = end.subtract(1,"days");

                      }
                  end = end._d.toLocaleString();
                  let end_date = end.split(' ')[0].replace(/[,]/g, ' ');
                  let end_time = end.split(' ')[1];


                  let et = end.split(' ')[2];
                  let hours1 = Number(end_time.match(/^(\d+)/)[1]);
                  let minutes1 = Number(end_time.match(/:(\d+)/)[1]);
                  if (et == 'PM' && hours1<12) hours1 = hours1+12;
                  if(et == "AM" && hours1==12) hours1 = hours1-12;
                  var eHours = hours1.toString();
                  var eMinutes = minutes1.toString();
                  if(hours1<10) eHours = "0" + eHours;
                  if(minutes1<10) eMinutes = "0" + eMinutes;
                  etime = eHours + ":" + eMinutes



                modal.find('#event-start-date').val(start_date);
                modal.find('#event-start-time').val(stime);

                modal.find('#event-end-date').val( end_date);
                modal.find('#event-end-time').val(etime);

                    if(event.allDay){
                         $("#event-start-time").val("00:00");
                         $("#event-end-time").val("00:00");

                          }


                $("#event-start-date").daterangepicker({
                        startDate: new Date(start_date),
                        endDate: new Date(start_date),
                        singleDatePicker: true,
                    })

               $("#event-end-date").daterangepicker({
                        startDate: new Date(end_date),
                        endDate: new Date(end_date),
                        singleDatePicker: true,
                    })








                    if (event.pt === "AL")
                     {
                     modal.find("#id_participant_type_1").prop( "checked", true );
                     $(".participant_dynamic").hide();
                    }else if (event.pt === "AS")
                    {
                    $(".participant_dynamic").hide();
                    modal.find("#id_participant_type_2").prop( "checked", true );
                    }else if (event.pt === "AT")
                    {
                     $(".participant_dynamic").hide();
                     modal.find("#id_participant_type_3").prop( "checked", true );
                    }else
                    {
                     modal.find("#id_participant_type_4").prop( "checked", true );

                            $(".participant_dynamic").show();

                         //  console.log(event.event_part_list.length);
                           id = [];
                           for (i=0; i<event.event_part_list.length; i++){

                                id.push(event.event_part_list[i].id);
                               // console.log(id);
                          }
                          console.log(id);
                          $('#id_participants').val(id);
                          $('#id_participants').trigger('change');

                    }





                    modal.find("#id_description").html(" ");
                    modal.find("#id_description").html(event.description);
                    modal.find("#btn-save").text("{% trans 'Update' %}");
                  //  modal.find(".close").click(function() {
                  //  location.reload();

                 //   })

                    modal.find("#calendar_event_form").attr('action', "{% url 'event_calendar_updated' pk=12345 %}".replace("12345", event.id.replace("event_id_", "")));


                    modal.modal();
                     $("#createEventModal").css("overflow-y", "scroll");
        }



            $("input[name='participation_type']").change();
            $("#id_is_all_day").change();

            var date = new Date();

            var weekday_events =[]
            var os_date = null;
            var oe_date = null;

            {% for event in weekday_event %}
               
              //  console.log('ABCD','{{event.date_start}}')
               // console.log('EFH','{{event.date_start}}')
                os_date = moment('{{event.date_start.isoformat}}')
                oe_date = moment('{{event.date_end.isoformat}}')
                console.log("OE", oe_date.diff(os_date, 'days') + 1);

                for (n=0; n < (oe_date.diff(os_date, 'days') + 1); n++){
                    if(os_date.clone().add(n,'days').day()== 6 || os_date.clone().add(n,'days').day()== 0){
                        continue;
                    }
                    weekday_events.push({
                                 
                        title: '{{ event.title }}',
                        id: 'event_id_{{ event.pk }}',
                        groupId:'event_id_{{ event.pk }}',
                        type: '{{ event.get_event_type_display }}',
                        tp: '{{event.event_type}}',
                        r_a: '{{event.register_agent.pk}}',
                     //   start: '{{ event.date_start.isoformat}}',
                     //   start: '{{ multievent.0.isoformat}}',
                        start:(os_date.clone().add(n, 'days')).set({hour:os_date.hours(),minute:os_date.minutes(),second:os_date.seconds()}), 
                        start_edit: $.fullCalendar.moment('{{event.date_start.isoformat}}'),
                       
                       // end: '{{ event.date_end.isoformat }}',
                       {% if event.is_all_day %} 
                         end: (os_date.clone().add(n, 'days')).set({hour:oe_date.hours(),minute:oe_date.minutes(),second:oe_date.seconds()}),
                         end_edit: $.fullCalendar.moment('{{event.date_end.isoformat}}').add(1, 'days'),
                       // end: $.fullCalendar.moment('{{ event.get_end_date }}').add(1, 'days'),
                           {% else %} 
                           end: (os_date.clone().add(n, 'days')).set({hour:oe_date.hours(),minute:oe_date.minutes(),second:oe_date.seconds()}),  
                           end_edit:  $.fullCalendar.moment('{{event.date_end.isoformat}}'),
                          //  end: $.fullCalendar.moment('{{ event.get_end_date }}'),
                          {% endif %} 
                      //  allDay: false,
                        part: '{{ event.get_participation_type_display }}',
                        chapter: '{% for c in event.get_chapters %} {{c.Chapter_Name}} {% endfor %}',
                        chapter_list: [
                            {% for ch in event.get_chapters %}
                                {
                                    id: '{{ ch.pk }}',
                                    name: '{{ ch.Chapter_Name }}',
                                },

                            {% endfor %}
                        ],
                        repeat:'{{ event.get_repeat_type_display }}',
                        r_type: '{{ event.repeat_type }}',

                        pt: '{{event.participation_type}}',
                        event_part: '{% for e in event.get_participants %} {{e.username}} {% endfor %}',
                        event_part_list: [
                            {% for part in event.get_participants %}
                                {   id: '{{ part.pk }}',
                                    username: '{{ part.username }}',
                                    fullname: '{{ part.getFullName }}',
                                    avatar: '{{ part.Avatar }}',

                                },
                            {% endfor %}
                            ],






                        //icon: "user-o",
                        description: `{{ event.description }}`,

                        {% if event.is_all_day %}
                            allDay: true,

                        {% else %}
                            allDay: false,

                        {% endif %}


                        {% if event.event_type == "PR" %}
                            icon: "building-o",
                            className: 'btn btn-info',
                        {% elif event.event_type == "ME" %}
                            icon: "user-o",
                            className: 'btn btn-success',
                        {% elif event.event_type == "HO" %}
                            icon: "car",
                            className: 'btn btn-danger',
                        {% elif event.event_type == "EX" %}
                            icon: "newspaper-o",
                            className: 'btn btn-primary',
                        {% elif event.event_type == "CH" %}
                            icon: "book",
                            className: 'btn btn-warning',
                        {% else %}
                            // default values
                            icon: "diamond",
                            className: 'btn btn-info',
                        {% endif %}

                    });

                }
           {% endfor %}
           console.log("WE",weekday_events)
            var monthly_events =[]
             os_date = null;
             oe_date = null;

            {% for event in monthly_event %}
               
              //  console.log('ABCD','{{event.date_start}}')
               // console.log('EFH','{{event.date_start}}')
                os_date = moment('{{event.date_start.isoformat}}')
                oe_date = moment('{{event.date_end.isoformat}}')
               // console.log("OE", oe_date.diff(os_date, 'months') + 1);

                for (n=0; n < (oe_date.diff(os_date, 'months') + 1); n++){
                    
                    monthly_events.push({
                                 
                        title: '{{ event.title }}',
                        id: 'event_id_{{ event.pk }}',
                        groupId:'event_id_{{ event.pk }}',
                        type: '{{ event.get_event_type_display }}',
                        tp: '{{event.event_type}}',
                        r_a: '{{event.register_agent.pk}}',
                     //   start: '{{ event.date_start.isoformat}}',
                     //   start: '{{ multievent.0.isoformat}}',
                        start:(os_date.clone().add(n, 'months')).set({hour:os_date.hours(),minute:os_date.minutes(),second:os_date.seconds()}), 
                        start_edit: $.fullCalendar.moment('{{event.date_start.isoformat}}'),
                       
                       // end: '{{ event.date_end.isoformat }}',
                       {% if event.is_all_day %} 
                         end: (os_date.clone().add(n, 'months')).set({hour:oe_date.hours(),minute:oe_date.minutes(),second:oe_date.seconds()}),
                         end_edit: $.fullCalendar.moment('{{event.date_end.isoformat}}').add(1, 'days'),
                       // end: $.fullCalendar.moment('{{ event.get_end_date }}').add(1, 'days'),
                           {% else %} 
                           end: (os_date.clone().add(n, 'months')).set({hour:oe_date.hours(),minute:oe_date.minutes(),second:oe_date.seconds()}),  
                           end_edit:  $.fullCalendar.moment('{{event.date_end.isoformat}}'),
                          //  end: $.fullCalendar.moment('{{ event.get_end_date }}'),
                          {% endif %} 
                      //  allDay: false,
                        part: '{{ event.get_participation_type_display }}',
                        chapter: '{% for c in event.get_chapters %} {{c.Chapter_Name}} {% endfor %}',
                        chapter_list: [
                            {% for ch in event.get_chapters %}
                                {
                                    id: '{{ ch.pk }}',
                                    name: '{{ ch.Chapter_Name }}',
                                },

                            {% endfor %}
                        ],
                        repeat:'{{ event.get_repeat_type_display }}',
                        r_type: '{{ event.repeat_type }}',

                        pt: '{{event.participation_type}}',
                        event_part: '{% for e in event.get_participants %} {{e.username}} {% endfor %}',
                        event_part_list: [
                            {% for part in event.get_participants %}
                                {   id: '{{ part.pk }}',
                                    username: '{{ part.username }}',
                                    fullname: '{{ part.getFullName }}',
                                    avatar: '{{ part.Avatar }}',

                                },
                            {% endfor %}
                            ],






                        //icon: "user-o",
                        description: `{{ event.description }}`,

                        {% if event.is_all_day %}
                            allDay: true,

                        {% else %}
                            allDay: false,

                        {% endif %}


                        {% if event.event_type == "PR" %}
                            icon: "building-o",
                            className: 'btn btn-info',
                        {% elif event.event_type == "ME" %}
                            icon: "user-o",
                            className: 'btn btn-success',
                        {% elif event.event_type == "HO" %}
                            icon: "car",
                            className: 'btn btn-danger',
                        {% elif event.event_type == "EX" %}
                            icon: "newspaper-o",
                            className: 'btn btn-primary',
                        {% elif event.event_type == "CH" %}
                            icon: "book",
                            className: 'btn btn-warning',
                        {% else %}
                            // default values
                            icon: "diamond",
                            className: 'btn btn-info',
                        {% endif %}

                    });

                }
           {% endfor %}
           console.log("Monthly", monthly_events )

            var events = [
                {% for event in daily_event %}
                 {% if event.register_agent.pk == request.user.pk or request.user in event.get_participants %}
                 {% if not event.is_all_day or not event.repeat_type == 'DA' %}
                 {% for multievent in event.date_range %}

                 {
                        title: '{{ event.title }}',
                        id: 'event_id_{{ event.pk }}',
                        groupId:'event_id_{{ event.pk }}',
                        type: '{{ event.get_event_type_display }}',
                        tp: '{{event.event_type}}',
                        r_a: '{{event.register_agent.pk}}',
                     //   start: '{{ event.date_start.isoformat}}',
                        start: '{{ multievent.0.isoformat}}',
                        start_edit: $.fullCalendar.moment('{{event.date_start.isoformat}}'),
                       
                       // end: '{{ event.date_end.isoformat }}',
                       {% if event.is_all_day %} 
                         end: $.fullCalendar.moment('{{  multievent.1.isoformat }}'),
                         end_edit:  $.fullCalendar.moment('{{event.date_end.isoformat}}').add(1, 'days'),
                       // end: $.fullCalendar.moment('{{ event.get_end_date }}').add(1, 'days'),
                           {% else %} 
                           end: $.fullCalendar.moment('{{  multievent.1.isoformat}}'),  
                           end_edit:  $.fullCalendar.moment('{{event.date_end.isoformat}}'),
                          //  end: $.fullCalendar.moment('{{ event.get_end_date }}'),
                          {% endif %} 
                      //  allDay: false,
                        part: '{{ event.get_participation_type_display }}',
                        chapter: '{% for c in event.get_chapters %} {{c.Chapter_Name}} {% endfor %}',
                        chapter_list: [
                            {% for ch in event.get_chapters %}
                                {
                                    id: '{{ ch.pk }}',
                                    name: '{{ ch.Chapter_Name }}',
                                },

                            {% endfor %}
                        ],
                        repeat:'{{ event.get_repeat_type_display }}',
                        r_type: '{{ event.repeat_type }}',

                        pt: '{{event.participation_type}}',
                        event_part: '{% for e in event.get_participants %} {{e.username}} {% endfor %}',
                        event_part_list: [
                            {% for part in event.get_participants %}
                                {   id: '{{ part.pk }}',
                                    username: '{{ part.username }}',
                                    fullname: '{{ part.getFullName }}',
                                    avatar: '{{ part.Avatar }}',

                                },
                            {% endfor %}
                            ],






                        //icon: "user-o",
                        description: `{{ event.description }}`,

                        {% if event.is_all_day %}
                            allDay: true,

                        {% else %}
                            allDay: false,

                        {% endif %}


                        {% if event.event_type == "PR" %}
                            icon: "building-o",
                            className: 'btn btn-info',
                        {% elif event.event_type == "ME" %}
                            icon: "user-o",
                            className: 'btn btn-success',
                        {% elif event.event_type == "HO" %}
                            icon: "car",
                            className: 'btn btn-danger',
                        {% elif event.event_type == "EX" %}
                            icon: "newspaper-o",
                            className: 'btn btn-primary',
                        {% elif event.event_type == "CH" %}
                            icon: "book",
                            className: 'btn btn-warning',
                        {% else %}
                            // default values
                            icon: "diamond",
                            className: 'btn btn-info',
                        {% endif %}

                    },

                 {% endfor %}
                 {% else %}

                 {
                        title: '{{ event.title }}',
                        id: 'event_id_{{ event.pk }}',
                      
                        type: '{{ event.get_event_type_display }}',
                        tp: '{{event.event_type}}',
                        r_a: '{{event.register_agent.pk}}',
                        start: '{{ event.date_start.isoformat}}',
                       
                        start_edit: $.fullCalendar.moment('{{event.date_start.isoformat}}'),
                        end: $.fullCalendar.moment('{{ event.get_end_date }}').add(1, 'days'),
                        end_edit:  $.fullCalendar.moment('{{event.date_end.isoformat}}').add(1, 'days'),
                       // end: '{{ event.date_end.isoformat }}',
                   {#    {% if event.is_all_day %} #}
                       // end: $.fullCalendar.moment('{{ event.get_end_date }}').add(1, 'days'),
                        {#   {% else %} #}
                          //  end: $.fullCalendar.moment('{{ event.get_end_date }}'),
                        {#   {% endif %} #}
                      //  allDay: false,
                        part: '{{ event.get_participation_type_display }}',
                        chapter: '{% for c in event.get_chapters %} {{c.Chapter_Name}} {% endfor %}',
                        chapter_list: [
                            {% for ch in event.get_chapters %}
                                {
                                    id: '{{ ch.pk }}',
                                    name: '{{ ch.Chapter_Name }}',
                                },

                            {% endfor %}
                        ],
                        repeat:'{{ event.get_repeat_type_display }}',
                        r_type: '{{ event.repeat_type }}',

                        pt: '{{event.participation_type}}',
                        event_part: '{% for e in event.get_participants %} {{e.username}} {% endfor %}',
                        event_part_list: [
                            {% for part in event.get_participants %}
                                {   id: '{{ part.pk }}',
                                    username: '{{ part.username }}',
                                    fullname: '{{ part.getFullName }}',
                                    avatar: '{{ part.Avatar }}',

                                },
                            {% endfor %}
                            ],






                        //icon: "user-o",
                        description: `{{ event.description }}`,

                        {% if event.is_all_day %}
                            allDay: true,

                        {% else %}
                            allDay: false,

                        {% endif %}


                        {% if event.event_type == "PR" %}
                            icon: "building-o",
                            className: 'btn btn-info',
                        {% elif event.event_type == "ME" %}
                            icon: "user-o",
                            className: 'btn btn-success',
                        {% elif event.event_type == "HO" %}
                            icon: "car",
                            className: 'btn btn-danger',
                        {% elif event.event_type == "EX" %}
                            icon: "newspaper-o",
                            className: 'btn btn-primary',
                        {% elif event.event_type == "CH" %}
                            icon: "book",
                            className: 'btn btn-warning',
                        {% else %}
                            // default values
                            icon: "diamond",
                            className: 'btn btn-info',
                        {% endif %}

                    },
                    
                    {% endif %}
                    {%endif%}
                {% endfor %}
            ];
            
            events = events.concat(monthly_events, weekday_events);
            console.log('MomentTime:',moment('2021-01-29T18:15:00Z'));

            $('#external-events .fc-event').each(function () {
                // store data so the calendar knows to render an event upon drop
                $(this).data('event', {
                    d_type: $(this).attr("data_val"),
                    title: $.trim($(this).text()), // use the element's text as the event title
                    stick: true, // maintain when user navigates (see docs on the renderEvent method),
                    color: $(this).find('i').css("color"),
                    icon: $(this).find('i').data('icon')
                });

                // make the event draggable using jQuery UI
                $(this).draggable({
                    zIndex: 999,
                    revert: true,      // will cause the event to go back to its
                    revertDuration: 0  //  original position after the drag
                });
            });


            $('#calendar-demo').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay,listMonth'
                },
                 {% get_current_language as LANGUAGE_CODE %}

                locale: '{{ LANGUAGE_CODE }}',

                timezone:"local",
                nextDayThreshold: '00:00',
                editable: false,
                droppable: true,
                drop: function () {
                    // is the "remove after drop" checkbox checked?
                    if ($('#drop-remove').is(':checked')) {
                        // if so, remove the element from the "Draggable Events" list
                        $(this).remove();
                    }
                },
                eventStartEditable: false,
                eventResizableFromStart: false,
                eventDurationEditable: false,
                weekNumbers: true,
                eventLimit: true, // allow "more" link when too many events
                events: events,

                eventRender: function (event, element) {

                    if(event.allDay ){
                        console.log("All_D End Date",event.end_edit);
                        if(event.end_edit){
                           //  event.end.setHours(23, 59, 59);
                             event.end_edit.set({h:23, m:59, s:59});
                             // $('#calendar-demo').fullCalendar('updateEvent', event);

                        }

                    }
                  //  if( $("#ho_checkbox").is(':checked'))

                     if( $("#ho_checkbox").is(':checked')){
                         if (event.tp === "HO"){
                              element[0].style.setProperty('display', 'block', 'important');
                             }
                     } else if (event.tp === "HO"){
                         element[0].style.setProperty('display', 'none', 'important');
                         }




                   if( $("#ex_checkbox").is(':checked')){
                         if (event.tp === "EX"){
                             element[0].style.setProperty('display', 'block', 'important');
                         }
                   } else if (event.tp === "EX"){
                         element[0].style.setProperty('display', 'none', 'important');
                   }


                     if( $("#me_checkbox").is(':checked')){
                         if (event.tp === "ME"){
                              element[0].style.setProperty('display', 'block', 'important');
                         }
                     }else if(event.tp === "ME") {
                         element[0].style.setProperty('display', 'none', 'important');
                     }


                      if( $("#pr_checkbox").is(':checked')){
                         if (event.tp === "PR"){
                              element[0].style.setProperty('display', 'block', 'important');
                         }
                     }else if (event.tp === "PR"){
                         element[0].style.setProperty('display', 'none', 'important');
                      }


                    if( $("#ch_checkbox").is(':checked')){
                         if (event.tp === "CH"){
                              element[0].style.setProperty('display', 'block', 'important');
                         }
                     }else  if (event.tp === "CH"){
                         element[0].style.setProperty('display', 'none', 'important');
                    }

                     // List event with icon, Title
                    if (event.icon) {
                        element.find(".fc-title").prepend("<i class='mr-1 fa fa-" + event.icon + "'></i>");
                    }
                      //Add border to the self created events.
                     if(event.r_a == '{{request.user.pk}}'){
                       //  element.find(".fc-title").prepend("<i class='fa mr-1 fa-star'></i>");
                         element[0].style.setProperty('border', '2px solid black', 'important');
                    }
                },

                dayClick: function (date, jsEvent, view) {

                    $('#createEventModal').modal();
                    $(".modal-title").text("{% trans 'Create Event' %}");
                    $("#id_title").val("");
                    $("#customRadioInline1").prop("checked", true);

                  //  let start_date = iso_to_django(event.start._d);
                    let start_date = date._d;


                    console.log(start_date);
                    let end_date = start_date;

                    $("#event-start-date").daterangepicker({
                            startDate: new Date(start_date),
                            endDate: new Date(start_date),
                            singleDatePicker: true,
                        })

                   $("#event-end-date").daterangepicker({
                            startDate: new Date(end_date),
                            endDate: new Date(end_date),
                            singleDatePicker: true,
                        })



                 $("#id_participant_type_1").prop("checked", true);
                 $(".chapter_dynamic").hide();
                 $("#id_is_all_day").prop("checked", true);
                 $(".participant_dynamic").hide();
                 $(".datetime_dynamic").hide();
                 $("#id_description").html(" ");
                 $("#createEventModal #btn-save").text("{% trans 'Create' %}");



                },



                  eventClick: function (event, jsEvent, view) {

                    var modal = $('#viewEventModal');
                  //  var brs = $(".modal_finder").find('br');
                   //     while (brs.length) {
                   //          brs[2].parentNode.removeChild(brs[0]);
                    //        }

                        if (event.tp == "PR")
                            {
                            modal.find('.event-type').removeClass('btn btn-danger btn-success btn-primary');
                            modal.find('.event-type').addClass('btn btn-info');


                            }
                          if (event.tp == "HO")
                            {
                            modal.find('.event-type').removeClass('btn btn-success btn-info btn-primary');
                            modal.find('.event-type').addClass('btn btn-danger');

                            }
                          if (event.tp == "ME")
                            {
                            modal.find('.event-type').removeClass("btn btn-danger btn-info btn-primary");
                            modal.find('.event-type').addClass("btn btn-success");

                            }
                          if (event.tp == "EX")
                            {
                            modal.find('.event-type').removeClass("btn btn-success btn-info btn-danger");
                            modal.find('.event-type').addClass("btn btn-primary");

                            }
                            if (event.tp == "CH")
                            {
                            modal.find('.event-type').removeClass("btn btn-success btn-info btn-danger btn-primary");
                            modal.find('.event-type').addClass("btn btn-warning");

                            }


                    // modal.find('.event-type').addClass(event.className);
                    modal.find('.event-type').html("<i class=' fa fa-" + event.icon + " '></i> &nbsp;" + event.type);
                    modal.find('.event-title').html("");
                    modal.find('.event-title').html(event.title);


                    console.log("Event Type",  event.tp );

                    if(event.tp === 'CH')
                    {

                      //  $(".modal_finder br" ).css("display","none");
                     //   $('.chapter_info_dynamic').after($("<br><br>")).remove();

                        $(".chapter_info_dynamic").show();
                        // modal.find('.class_chapter').html("");

                      //   modal.find('.class_chapter').html(`<span class="btn btn-sm btn-warning"> ${event.chapter} </span>`,);
                        let chapter_str = ""
                        for( chapter of event.chapter_list){
                            chapter_str += `<span class="btn btn-sm btn-warning mb-1"> ${chapter.name} </span>`
                        }

                         modal.find('.class_chapter').html(chapter_str);
                         modal.find('.class_repeat').html(event.repeat);
                       //  $( ".chapter_info_dynamic" ).after( "<br><br>" );


                         //
                         console.log(event.chapter);

                    }else{
                        $(".chapter_info_dynamic").hide();
                        $(".rptp").show();
                        modal.find('.class_repeat').html(event.repeat);
                    }





                      let start = event.start_edit;
                      start = start._d.toLocaleString();
                      let start_date = start.split(' ')[0].replace(/[,]/g, ' ');
                      let start_time = start.split(' ')[1];
                      let st = start.split(' ')[2];
                      let hours = Number(start_time.match(/^(\d+)/)[1]);
                      let minutes = Number(start_time.match(/:(\d+)/)[1]);
                      if (st == 'PM' && hours<12) hours = hours+12;
                      if(st == "AM" && hours==12) hours = hours-12;
                      var sHours = hours.toString();
                      var sMinutes = minutes.toString();
                      if(hours<10) sHours = "0" + sHours;
                      if(minutes<10) sMinutes = "0" + sMinutes;
                      stime = sHours + ":" + sMinutes


                      let end = event.end_edit.clone();
                    //  let end = $.extend( true, {}, event.end_edit );
                    //  let end = JSON.parse(JSON.stringify(event.end_edit))
                    //  console.log(end);
                      if (!end)
                      {
                      end = event.start_edit.clone();
                      //end = $.extend( true, {}, event.start_edit );
                      // end = JSON.parse(JSON.stringify(event.start_edit))
                      }
                       console.log(event.end_edit);
                      if(event.allDay){
                        end = end.subtract(1,"days");
                      }

                      end = end._d.toLocaleString();
                      console.log(event.end_edit);
                      let end_date = end.split(' ')[0].replace(/[,]/g, ' ');
                      let end_time = end.split(' ')[1];
                      let et = end.split(' ')[2];
                      let hours1 = Number(end_time.match(/^(\d+)/)[1]);
                      let minutes1 = Number(end_time.match(/:(\d+)/)[1]);
                      if (et == 'PM' && hours1<12) hours1 = hours1+12;
                      if(et == "AM" && hours1==12) hours1 = hours1-12;
                      var eHours = hours1.toString();
                      var eMinutes = minutes1.toString();
                      if(hours1<10) eHours = "0" + eHours;
                      if(minutes1<10) eMinutes = "0" + eMinutes;
                      etime = eHours + ":" + eMinutes




                    if (event.allDay){
                        modal.find('.type_event').html("<a class='btn btn-sm btn-light'>{% trans 'All Day Event' %}</a>");
                        if (start_date == end_date){
                             modal.find('.strt_at').html("{% trans 'Date' %}: (MM/DD/YYYY)");
                             modal.find('.start_at').html(start_date);
                             modal.find('.end_at').empty();
                             modal.find('.en_at').empty();
                           //  modal.find('.en_at').hide();
                        }
                        else{


                            modal.find('.strt_at').html("{% trans 'Start At' %}: (MM/DD/YYYY)")
                            modal.find('.en_at').html("{% trans 'End At' %}: (MM/DD/YYYY)")
                            modal.find('.start_at').html(start_date);
                            modal.find('.end_at').html(end_date);
                        }

                    }else{
                        modal.find('.type_event').empty();
                        modal.find('.en_at').html("{% trans 'Time' %}: (24Hrs.)");
                        modal.find('.end_at').html(stime + "&nbsp; to &nbsp;" + etime );
                        if(start_date == end_date){
                             modal.find('.strt_at').html(" {% trans 'Date' %}: (MM/DD/YYYY)")
                             modal.find('.start_at').html(start_date);

                        }
                        else{
                             modal.find('.strt_at').html("{% trans 'From' %}: (MM/DD/YYYY)");
                             modal.find('.start_at').html(start_date +" &nbsp; to &nbsp; "+ end_date);
                        }
                    }


                    if (event.pt === 'CH')
                    {
                        console.log(event.event_part_list);
                         modal.find('.participant').html("{% trans 'Participants' %}:&nbsp;"+event.event_part_list.length);
                         $('.part_list').empty();
                        for (i = 0; i < event.event_part_list.length; i++){
                             $('.part_list').append(` <a href='#' class='list-group-item d-flex align-items-center'>
                                <div class='pr-3'>
                                    <div class='avatar'>
                                        <img src="${event.event_part_list[i].avatar}"
                                             class='rounded-circle'
                                             alt='image'>
                                    </div>
                                </div>
                                <div>
                                    <h6 class='mb-1 participant_name '> ${event.event_part_list[i].fullname} </h6>
                                </div>
                             </a>`);
                        }


                   // modal.find('.participant_name').text(event.event_part);
                    modal.find('.part_custom').show();
                    $(".cus_prt").css({"height": "300px","width": "fit-content",  "overflow-y": "scroll"})



                    }else{
                  //   modal.find('.participant').append(event.part);
                     modal.find('.participant').html("{% trans 'Participants' %}:&nbsp;"+ event.part);
                     modal.find('.part_custom').hide();
                    }
                    modal.find('.desc').html(" ");
                    modal.find('.desc').html(event.description);


                    let event_id = event.id.replace("event_id_", "");
                    modal.find('.delete_event').attr('action', '{% url "event_calendar_delete" 12345 %}'.replace("12345", event_id));


                  //// update button upon pressing display Form Detail Modal
                    $("#update_event_btn").click({param1: event}, update_fxn);
                    modal.find(".close").click(function() {
                    //    location.reload();
                     })


                    modal.modal();

                },


                eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                    console.log("event resized", event);
                    if (event.id) {
                        console.log("event update", event.id);
                        update_event(event, delta, revertFunc, jsEvent, ui, view);
                    } else {
                        console.log("event create", event.id);
                        create_event(event, delta, revertFunc, jsEvent, ui, view);
                    }
                },
                eventDrop: function (event, delta, revertFunc, jsEvent, ui, view) {
                    console.log("event dragged", event);
                    if (event.id) {
                        console.log("event update", event.id);
                        update_event(event, delta, revertFunc, jsEvent, ui, view);
                    } else {
                        console.log("event create", event.id);
                        create_event(event, delta, revertFunc, jsEvent, ui, view);
                    }
                },
                eventReceive: function (event,  delta, revertFunc, jsEvent, ui, view) {
                    console.log("event received", event);
                    if (event.id) {
                        console.log("event update", event.id);
                        update_event(event, delta, revertFunc, jsEvent, ui, view);
                    } else {
                        console.log("event create", event.id);
                        // create_event(event, delta, revertFunc, jsEvent, ui, view);
                        drag_create(event);


                    }
                },

            });

            function drag_create(event){
                $('#createEventModal').modal();

                       $(".modal-title").text("{% trans 'Create Event' %}");
                       $("#id_title").val("");

                       // console.log("D_Type:", event.d_type)

                          $(".chapter_dynamic").hide();



                       if (event.d_type === "HO"){
                            $("#customRadioInline3").prop("checked", true);

                         }
                         if (event.d_type === "PR"){
                            $("#customRadioInline1").prop("checked", true);
                         }
                         if (event.d_type === "ME"){
                            $("#customRadioInline2").prop("checked", true);
                         }
                         if (event.d_type === "EX"){
                            $("#customRadioInline4").prop("checked", true);
                         }
                          if (event.d_type === "CH"){
                            $("#customRadioInline5").prop("checked", true);
                             $(".chapter_dynamic").show();

                         }

                       let start_date = iso_to_django(event.start._d);
                       let end_date = start_date;

                            $("#event-start-date").daterangepicker({
                                    startDate: new Date(start_date),
                                    endDate: new Date(start_date),
                                    singleDatePicker: true,
                                })

                           $("#event-end-date").daterangepicker({
                                    startDate: new Date(end_date),
                                    endDate: new Date(end_date),
                                    singleDatePicker: true,
                                })


                         $("#id_participant_type_1").prop("checked", true);
                         $("#id_is_all_day").prop("checked", true);
                         $(".participant_dynamic").hide();
                         $(".datetime_dynamic").hide();

                         $("#id_description").html(" ");
                         $("#createEventModal #btn-save").text("{% trans 'Create' %}");

                          $(".close").click(function (){
                            location.reload();

                         })


            }

            function update_event(event, delta, revertFunc, jsEvent, ui, view) {
                //// obtain event data
                let start_date = iso_to_django(event.start_edit._d);
                let end_date = null;
                if (event.end_edit) {
                    end_date = iso_to_django(event.end_edit._d);
                } else {
                    end_date = start_date;
                }
                let post_data = {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    date_start: start_date,
                    date_end: end_date,
                }
                //// make ajax request to change the related object in the database
                $.ajax({
                    url: "{% url 'event_calendar_update' pk=12345 %}".replace("12345", event.id.replace("event_id_", "")), // URL to your view that serves new info
                    type: 'POST', // GET or POST
                    data: post_data,
                    success: function (response) {
                        //// on success, notify user about success
                        alert("Event change success !!!");
                    },
                    error: function () {
                        console.log('Error in posting form');
                        alert("Can't change event !!!");
                        revertFunc();

                    },
                    complete: function () {
                    }
                });
            }

            function create_event(event, delta, revertFunc, jsEvent, ui, view) {
                //// obtain event data

                let start_date = iso_to_django(event.start_edit._d);
                console.log("sd_create",start_date);
                let end_date = null;
                let event_type = "PR";
                if (event.title === "Holiday") {
                    event_type = "HO";
                } else if (event.title === "Meeting") {
                    event_type = "ME";
                } else if (event.title === "Program") {
                    event_type = "PR";
                }
                console.log("et_create",event_type);
                if (event.end_edit) {
                    end_date = iso_to_django(event.end_edit._d);

                } else {
                    end_date = start_date;
                }
                console.log("ed_create", end_date);
                let post_data = {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    title: event.title,
                    event_type: event_type,
                    participation_type:"AL",
                    description: event.description,
                    date_start: start_date,
                    date_end: end_date,
                    is_all_day: true,
                }
                console.log(post_data);
                //// make ajax request to change the related object in the database
                $.ajax({
                    url: "{% url 'event_calendar_create' %}?return=json", // URL to your view that serves new info
                    type: 'POST', // GET or POST
                    data: post_data,
                    success: function (response) {
                        //// on success, notify user about success
                        alert("Event Create Success !!!");
                        console.log(response['pk']);
                        event.id = "event_id_" + response['pk'];
                        event.type = response['type'];
                        event.part = response['part'];

                        $('#calendar-demo').fullCalendar('updateEvent', event);
                    },
                    error: function () {
                        console.log('Error in posting form');
                        alert("Can't change event !!!");
                        event.id = "remove_event"
                        $('#calendar-demo').fullCalendar('updateEvent', event);
                        $('#calendar-demo').fullCalendar('removeEvents', ["remove_event",]);
                    },
                    complete: function () {
                    }
                });


            }
        });


        function iso_to_django(date_obj) {
            let mo = (date_obj.getUTCMonth() + 1).toString();       // month starts form zero
            let y = date_obj.getUTCFullYear().toString();
            let d = (date_obj.getUTCDate()).toString();
            let h = date_obj.getUTCHours().toString();
            let mi = date_obj.getUTCMinutes().toString();
            return y + "-" + mo + "-" + d + " " + h + ":" + mi;
        }

    </script>

    <script>
        $(".select2-example").select2({
            placeholder: 'Select',
           width: "element",
             multiple: true,
            templateResult: function (state) {
                // how dropdown list is displayed
                let filter_type = $("input[name='filter_type']:checked").val();
                let is_student = $(state.element).attr('data-is_student');
                let is_teacher = $(state.element).attr('data-is_teacher');
                if (filter_type === "A") {        // all user
                    return state.text;
                }
                if (filter_type === "S" && is_student === "true") {        // Students only
                    return state.text;
                }
                if (filter_type === "T" && is_teacher === "true") {        // Teachers only
                    return state.text;
                }
                return null;
            },
        });

        //// Calendar Event Create Form Submit:
        $("#calendar_event_form").submit(function (e) {


           // console.log("Clicked")

            //// Convert date and time inputs to UTC and required format for django:

            let d_end = new Date($("#event-end-date").val() + " " + $("#event-end-time").val());
           // console.log("Date_End",d_end );
            let d_start = new Date($("#event-start-date").val() + " " + $("#event-start-time").val());
           // console.log("Date_Start",d_start );

            //// Using one of django's default format: '%Y-%m-%d %H:%M', '2006-10-25 14:30':
            $("#id_date_end").val(iso_to_django(d_end));
          //  console.log("New Date End", $("#id_date_end").val(iso_to_django(d_end)));
            $("#id_date_start").val(iso_to_django(d_start));
           // console.log("New Date Start",  $("#id_date_start").val(iso_to_django(d_start)));
           // return false;
            //// Validation Here:
            let is_valid = true;


             let title = $("#createEventModal #id_title").val();
             let sd = $("#event-start-date").val();
             let st = $("#event-start-time").val();
             let ed = $("#event-end-date").val();
             let et = $("#event-end-time").val();
             let is_ad = $("#createEventModal #id_is_all_day").is(':checked');
             let is_custom = $("#createEventModal #id_participant_type_4").is(':checked');
            // let p_l = $(".select2-selection__rendered > li").length;
            // let ch_l = $("#chapter_list_multiple .select2-selection__rendered > li").length;


             $("span.text-danger").remove();
             if (title.length < 1){
                 $("#createEventModal #id_title").after('<span class="text-danger">This field is required</span>');
                is_valid = false;

             }
             let ch = $("#customRadioInline5").is(':checked');
             v = $("#chapter_list_multiple").val();
             if(ch){
                 if(v.length < 1){
                      $("#chapter_list_multiple").after('<span class="text-danger">This field is required</span>');
                      is_valid = false;
                 }
             }
              if (sd === ""){
                 $("#event-start-date").after('<span class="text-danger">This field is required</span>');
                is_valid = false;

             }
              if (ed === ""){
                 $("#event-end-date").after('<span class="text-danger">This field is required</span>');


                is_valid = false;

             }
             if( new Date(sd) > new Date(ed) ){
                 $("#event-start-date").after('<span class="text-danger">Start Date Cannot be Greater then End Date.</span>');
                is_valid = false;
             }

                 if (sd === ed){
                        if( st > et ){
                             $("#event-start-time").after('<span class="text-danger">Start Time Cannot be Greater then End Time.</span>');
                            is_valid = false;
                        }
                 }

             if(!is_ad){
                if(st === ""){
                    $("#event-start-time").after('<span class=" text-danger">This field is required</span>');
                    is_valid = false;
                }
                if(et === ""){
                    $("#event-end-time").after('<span class=" text-danger">This field is required</span>');
                    is_valid = false;
                }

             }
             let pt_ls = $("#id_participants").val();
            if(is_custom){
                if( pt_ls.length < 1 ){
                     $("#id_participants").after('<span class=" text-danger">This field is required</span>');
                     is_valid = false;

                }
            }

              //   $("#chapter_list_hidden").val($("#chapter_list_multiple").val().toString());
             //    console.log("Chapter_List", $( "#chapter_list_hidden").val());
                // return  false

            if (!is_valid) {
                e.preventDefault();
                return false;
            }
        });



        // Participation Type On Choose User Display User Selection Dropdown
        $("input[name='participation_type']").change(function () {
            let ch_val = $("input[name='participation_type']:checked").val();
            //console.log("part_type changed: ", ch_val, ch_val === "CH");
            if (ch_val === "CH") {
                $(".participant_dynamic").show();
            } else {
                $(".participant_dynamic").hide();
                $(".select2-example").val("");
                $(".select2-example").trigger("change");
            }
        });

        // Chapter Event On Selection Display Chapter And Repeat Type
         $('input[name="event_type"]').change(function () {
              let c_val = $("input[name='event_type']:checked").val();
                console.log("CH_VAL",c_val);
                 if (c_val === "CH") {
                $(".chapter_dynamic").show();
            } else {
                $(".chapter_dynamic").hide();
                $(".select2-example").val("");
                $(".select2-example").trigger("change");
            }
         });


        $(".create_event_button").click(function () {



            //console.log("event create button click");
            $("#calendar_event_form").trigger("reset");
            $('#createEventModal .modal-title').text("{% trans 'Create Event' %}");
            $('#createEventModal #id_is_all_day').prop("checked", true);

                    if ($("#createEventModal #id_is_all_day").is(':checked')) {
                         $(".datetime_dynamic").hide();
                         $("#event-start-time").val("00:00");
                         $("#event-end-time").val("00:00");
                    } else {
                        $(".datetime_dynamic").show();
                    }
            $("#event-start-date").val("");
            $("#event-end-date").val("");
            $("#event-start-time").val("");
            $("#event-end-time").val("");
            $("#createEventModal #id_title").val("");
            $("#createEventModal #id_description").val("");
            $("#createEventModal #btn-save").text("{% trans 'Create' %}");
            $("#createEventModal").trigger("change");



            $("#id_participant_type_1").click();
            $("#customRadioInline1").click();
            $("#id_filter_type_1").click();
        })

        $("#id_is_all_day").change(function () {
            if ($(this).is(':checked')) {
                $(".datetime_dynamic").hide();
            } else {
                $(".datetime_dynamic").show();
            }
        })

         $(".event_filter").change(function () {
           $("#calendar-demo").fullCalendar('rerenderEvents');
        })


          $("#id_is_all_day").change(function () {
             if ($(this).is(':checked')){
                 $("#event-start-time").val("00:00");
                 $("#event-end-time").val("00:00");

             }
        })


    </script>

<script>
    $("#update_event_btn").click(function(){
      $('#viewEventModal').modal('toggle');
    })

    $(".detail_btn").click(function(){
        $('#viewEventModal').removeClass("show");
    })

     $("#custom_Participant_Modal .close_prt").click(function(){
        $('#viewEventModal').addClass("show");
    })





</script>


{% endblock %}

